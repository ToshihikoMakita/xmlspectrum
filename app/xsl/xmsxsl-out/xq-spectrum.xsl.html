<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title>xq-spectrum.xsl</title><link rel="stylesheet" type="text/css" href="theme.css"></link></head><body><div><pre class="spectrum"><span class="z">&lt;?</span><span class="pi">xml version="1.0" encoding="UTF-8"</span><span class="z">?&gt;</span><span class="txt">
</span><span class="ww" id="w5"><span class="es">&lt;</span><a class="solar" href="index.html"><span class="enxsl" id="e?{http://www.w3.org/1999/XSL/Transform}stylesheet">xsl:stylesheet</span></a><span class="z"> </span><span class="atn">xmlns:xsl</span><span class="atneq">=</span><span class="z">"</span><span class="av">http://www.w3.org/1999/XSL/Transform</span><span class="z">"</span><span class="z">
                </span><span class="atn">xmlns:xs</span><span class="atneq">=</span><span class="z">"</span><span class="av">http://www.w3.org/2001/XMLSchema</span><span class="z">"</span><span class="z"> </span><span class="atn">version</span><span class="atneq">=</span><span class="z">"</span><span class="av">2.0</span><span class="z">"</span><span class="z">
                </span><span class="atn">xmlns:f</span><span class="atneq">=</span><span class="z">"</span><span class="av">urn:xq.internal-function</span><span class="z">"</span><span class="z">
                </span><span class="atn">xmlns:xq</span><span class="atneq">=</span><span class="z">"</span><span class="av">com.qutoric.xq.functions</span><span class="z">"</span><span class="z">
                </span><span class="atn">xmlns</span><span class="atneq">=</span><span class="z">"</span><span class="av">http://www.w3.org/1999/xhtml</span><span class="z">"</span><span class="z">
                </span><span class="atn">xpath-default-namespace</span><span class="atneq">=</span><span class="z">"</span><span class="av">http://www.w3.org/1999/xhtml</span><span class="z">"</span><span class="z">
                </span><span class="atn">exclude-result-prefixes</span><span class="atneq">=</span><span class="z">"</span><span class="av">f xs xq</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
  
  </span><span class="ww" id="w57"><span class="es">&lt;</span><span class="enxsl">xsl:output</span><span class="z"> </span><span class="atn">indent</span><span class="atneq">=</span><span class="z">"</span><span class="av">yes</span><span class="z">"</span><span id="wx65" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w67"><span class="es">&lt;</span><span class="enxsl">xsl:include</span><span class="z"> </span><span class="atn">href</span><span class="atneq">=</span><span class="z">"</span><a href="xq-handler.xsl.html" class="solar"><span class="href">xq-handler.xsl</span></a><span class="z">"</span><span id="wx75" class="sc">/&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w77"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?cQuote">cQuote</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">34</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx97" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w99"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?cApos">cApos</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">39</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx119" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w121"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?cColon">cColon</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">58</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx141" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w143"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?cParenStart">cParenStart</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">91</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx163" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w165"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?cParenEnd">cParenEnd</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">93</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx185" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w187"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?cBracketStart">cBracketStart</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">40</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx207" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w209"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?cBracketEnd">cBracketEnd</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">41</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx229" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w231"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?cCloseComment">cCloseComment</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer*</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#v?cColon" class="solar"><span class="variable">$cColon</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cBracketEnd" class="solar"><span class="variable">$cBracketEnd</span></a><span class="z">"</span><span id="wx254" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w256"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?cTagStart">cTagStart</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">60</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx276" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w278"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?cTagEnd">cTagEnd</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">62</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx298" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w300"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?cWhitespace">cWhitespace</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">13</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">32</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer*</span><span class="z">"</span><span id="wx323" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w325"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?cFnStart">cFnStart</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">123</span><span class="z">"</span><span id="wx345" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w347"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?cFnEnd">cFnEnd</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">125</span><span class="z">"</span><span id="wx367" class="sc">/&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w369"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?xExclam">xExclam</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">33</span><span class="z">"</span><span id="wx389" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w391"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?xPI">xPI</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">63</span><span class="z">"</span><span id="wx411" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w413"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?xSlash">xSlash</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">47</span><span class="z">"</span><span id="wx433" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w435"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?xHyphen">xHyphen</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">45</span><span class="z">"</span><span id="wx455" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w457"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?xEquals">xEquals</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">61</span><span class="z">"</span><span id="wx477" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="z">&lt;!--</span><span class="cm"> unused codepoints when waiting for / or &gt; chars </span><span class="z">--&gt;</span><span class="txt">
  </span><span class="ww" id="w483"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?xxInitTagEnd">xxInitTagEnd</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">6</span><span class="z">"</span><span id="wx503" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w505"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?xxTagEnd">xxTagEnd</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">7</span><span class="z">"</span><span id="wx525" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w527"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?xxAnyTagEnd">xxAnyTagEnd</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer*</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">6</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">7</span><span class="z">"</span><span id="wx550" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w552"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?xxCloseTagEnd">xxCloseTagEnd</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">8</span><span class="z">"</span><span id="wx572" class="sc">/&gt;</span></span><span class="txt">     
  
  </span><span class="ww" id="w574"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{urn:xq.internal-function}show-xquery">f:show-xquery</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w584"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?doc-text">doc-text</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span id="wx598" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w600"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?text-points">text-points</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer*</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-string-to-codepoints" class="solar"><span class="function">string-to-codepoints</span></a><span class="parenthesis">(</span><span class="variable">$doc-text</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx623" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w625"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?blocks">blocks</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w641"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}createXqBlocks" class="solar"><span class="function">f:createXqBlocks</span></a><span class="parenthesis">(</span><span class="variable">$text-points</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx652" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx656" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ww" id="w658"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}tokeniseBlocks" class="solar"><span class="function">f:tokeniseBlocks</span></a><span class="parenthesis">(</span><span class="variable">$doc-text</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$blocks</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx672" class="sc">/&gt;</span></span><span class="txt">             
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx676" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w678"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{urn:xq.internal-function}show-xsl-tvt">f:show-xsl-tvt</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w688"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?doc-text">doc-text</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span id="wx702" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w704"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?prefixed-text">prefixed-text</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-concat" class="solar"><span class="function">concat</span></a><span class="parenthesis">(</span><span class="op">'</span><span class="literal">&amp;lt;t&amp;gt;</span><span class="op">'</span><span class="op">,</span><span class="variable">$doc-text</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx731" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w733"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?text-points">text-points</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer*</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-string-to-codepoints" class="solar"><span class="function">string-to-codepoints</span></a><span class="parenthesis">(</span><span class="variable">$prefixed-text</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx756" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w758"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?blocks">blocks</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w774"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}createXslTvtBlocks" class="solar"><span class="function">f:createXslTvtBlocks</span></a><span class="parenthesis">(</span><span class="variable">$text-points</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx785" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx789" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ww" id="w791"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-subsequence" class="solar"><span class="function">subsequence</span></a><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}tokeniseBlocks" class="solar"><span class="function">f:tokeniseBlocks</span></a><span class="parenthesis">(</span><span class="variable">$prefixed-text</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$blocks</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">4</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx811" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx815" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w817"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{urn:xq.internal-function}tokeniseBlocks">f:tokeniseBlocks</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w827"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?doc-text">doc-text</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span id="wx841" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w843"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?blocks">blocks</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span id="wx857" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w859"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}tokeniseBlocks" class="solar"><span class="function">f:tokeniseBlocks</span></a><span class="parenthesis">(</span><span class="variable">$doc-text</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$blocks</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-false" class="solar"><span class="function">false</span></a><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx890" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx894" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w896"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{urn:xq.internal-function}tokeniseBlocks">f:tokeniseBlocks</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w906"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?doc-text">doc-text</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span id="wx920" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w922"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?blocks">blocks</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span id="wx936" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w938"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?index">index</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx952" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w954"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?type">type</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span id="wx968" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w970"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?result">result</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span id="wx984" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="z">&lt;!--</span><span class="cm"> if is-preceding-closed then an operator is expected next, normally a qname is expected
         but a comment may have been placed where an operator was expected - eg. abc (: test :) div def
    </span><span class="z">--&gt;</span><span class="txt">
    </span><span class="ww" id="w990"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?is-preceding-closed">is-preceding-closed</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span id="wx1004" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w1006"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?block">block</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$blocks</span><span class="filter">[</span><span class="variable">$index</span><span class="filter">]</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()</span><span class="z">"</span><span id="wx1029" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w1031"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?nextBlock">nextBlock</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$blocks</span><span class="filter">[</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="filter">]</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()?</span><span class="z">"</span><span id="wx1058" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w1060"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?name">name</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-name" class="solar"><span class="function">name</span></a><span class="parenthesis">(</span><span class="variable">$block</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx1083" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w1085"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?start">start</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer?</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$block</span><span class="step">/</span><span class="axis">@</span><span class="qname">start</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$block</span><span class="step">/</span><span class="axis">@</span><span class="qname">start</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$block</span><span class="step">/</span><span class="axis">@</span><span class="qname">pos</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$block</span><span class="step">/</span><span class="axis">@</span><span class="qname">pos</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx1142" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w1144"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?nextStart">nextStart</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer?</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$nextBlock</span><span class="step">/</span><span class="axis">@</span><span class="qname">start</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$nextBlock</span><span class="step">/</span><span class="axis">@</span><span class="qname">start</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$nextBlock</span><span class="step">/</span><span class="axis">@</span><span class="qname">pos</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$nextBlock</span><span class="step">/</span><span class="axis">@</span><span class="qname">pos</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx1201" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w1203"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?length">length</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:double?</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$block</span><span class="step">/</span><span class="axis">@</span><span class="qname">end</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$block</span><span class="step">/</span><span class="axis">@</span><span class="qname">end</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="variable">$start</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$block</span><span class="step">/</span><span class="axis">@</span><span class="qname">length</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$block</span><span class="step">/</span><span class="axis">@</span><span class="qname">length</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$nextStart</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$nextStart</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="variable">$start</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx1286" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w1288"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?newType">newType</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string?</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$name</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">x-tag-end</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> 
                          </span><span class="op">'</span><span class="literal">x-text</span><span class="op">'</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-exists" class="solar"><span class="function">exists</span></a><span class="parenthesis">(</span><span class="variable">$block</span><span class="step">/</span><span class="axis">@</span><span class="qname">type</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> 
                          </span><span class="variable">$block</span><span class="step">/</span><span class="axis">@</span><span class="qname">type</span><span class="whitespace"> 
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$type</span><span class="z">"</span><span id="wx1349" class="sc">/&gt;</span></span><span class="txt">
    
     
    </span><span class="ww" id="w1351"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?count">count</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-count" class="solar"><span class="function">count</span></a><span class="parenthesis">(</span><span class="variable">$blocks</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx1374" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w1376"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?followingStart">followingStart</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$start</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="variable">$length</span><span class="z">"</span><span id="wx1394" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="z">&lt;!--</span><span class="cm"> when closed, an op is expected next in xquery </span><span class="z">--&gt;</span><span class="txt">
    </span><span class="ww" id="w1400"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?current-is-preceding-closed">current-is-preceding-closed</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$name</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">comment</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                          </span><span class="variable">$is-preceding-closed</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$name</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">literal</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">start-xquery</span><span class="op">'</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx1453" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w1455"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?isClose">isClose</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$name</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">xml-close-tag</span><span class="op">'</span><span class="z">"</span><span id="wx1475" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w1477"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?isOpen">isOpen</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$name</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">xml-open-tag</span><span class="op">'</span><span class="z">"</span><span id="wx1497" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w1499"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?offset">offset</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$isClose</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="numeric">2</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$isOpen</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="numeric">0</span><span class="z">"</span><span id="wx1543" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w1545"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?shiftStart">shiftStart</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-empty" class="solar"><span class="function">empty</span></a><span class="parenthesis">(</span><span class="variable">$start</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="numeric">0</span><span class="whitespace"> 
                                                            </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$start</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="variable">$offset</span><span class="z">"</span><span id="wx1584" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w1586"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?text">text</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-empty" class="solar"><span class="function">empty</span></a><span class="parenthesis">(</span><span class="variable">$length</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                                      </span><a href="http://www.w3.org/TR/xpath-functions/#func-substring" class="solar"><span class="function">substring</span></a><span class="parenthesis">(</span><span class="variable">$doc-text</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$shiftStart</span><span class="parenthesis">)</span><span class="whitespace">
                                      </span><span class="op">else</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-substring" class="solar"><span class="function">substring</span></a><span class="parenthesis">(</span><span class="variable">$doc-text</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$shiftStart</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$length</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="variable">$offset</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx1634" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w1636"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?following-string">following-string</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-empty" class="solar"><span class="function">empty</span></a><span class="parenthesis">(</span><span class="variable">$followingStart</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="whitespace">
                                                  </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-empty" class="solar"><span class="function">empty</span></a><span class="parenthesis">(</span><span class="variable">$nextStart</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                                                  </span><a href="http://www.w3.org/TR/xpath-functions/#func-substring" class="solar"><span class="function">substring</span></a><span class="parenthesis">(</span><span class="variable">$doc-text</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$followingStart</span><span class="parenthesis">)</span><span class="whitespace">
                                                  </span><span class="op">else</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-substring" class="solar"><span class="function">substring</span></a><span class="parenthesis">(</span><span class="variable">$doc-text</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$followingStart</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$nextStart</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="variable">$followingStart</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx1701" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w1703"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?token-string">token-string</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$name</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">comment</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">literal</span><span class="op">'</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                          </span><span class="variable">$following-string</span><span class="whitespace"> 
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$name</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">start-xquery</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> 
                          </span><span class="variable">$text</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="z">"</span><span id="wx1761" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w1763"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?xq-token">xq-token</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-empty" class="solar"><span class="function">empty</span></a><span class="parenthesis">(</span><span class="variable">$start</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><a href="xq-handler.xsl.html#f?{com.qutoric.xq.functions}createXqTokens" class="solar"><span class="function">xq:createXqTokens</span></a><span class="parenthesis">(</span><span class="variable">$token-string</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$current-is-preceding-closed</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx1805" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="z">&lt;!--</span><span class="cm"> todo: must check if whitespace found </span><span class="z">--&gt;</span><span class="txt">
    </span><span class="ww" id="w1811"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?new-is-preceding-closed">new-is-preceding-closed</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-count" class="solar"><span class="function">count</span></a><span class="parenthesis">(</span><span class="variable">$xq-token</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$xq-token</span><span class="step">/</span><span class="axis">@</span><span class="qname">class</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">whitespace</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                          </span><span class="variable">$is-preceding-closed</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-empty" class="solar"><span class="function">empty</span></a><span class="parenthesis">(</span><span class="variable">$xq-token</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                          </span><span class="variable">$is-preceding-closed</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function">not</span></a><span class="parenthesis">(</span><span class="variable">$xq-token</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="step">/</span><span class="axis">@</span><span class="qname">class</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">open</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx1893" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w1895"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?result1">result1</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w1911"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function">not</span></a><span class="parenthesis">(</span><span class="variable">$start</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w1936"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?text">text</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-empty" class="solar"><span class="function">empty</span></a><span class="parenthesis">(</span><span class="variable">$start</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$doc-text</span><span class="whitespace">
                                          </span><span class="op">else</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-substring" class="solar"><span class="function">substring</span></a><span class="parenthesis">(</span><span class="variable">$doc-text</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$start</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx1978" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ww" id="w1980"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-handler.xsl.html#f?{com.qutoric.xq.functions}createXqTokens" class="solar"><span class="function">xq:createXqTokens</span></a><span class="parenthesis">(</span><span class="variable">$text</span><span class="op">,</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-false" class="solar"><span class="function">false</span></a><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx1996" class="sc">/&gt;</span></span><span class="txt">            
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx2000" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ww" id="w2002"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="z">&lt;!--</span><span class="cm">                &lt;xsl:when test="empty($length)"&gt;
             &lt;length-empty name="{$name}" shiftStart="{$shiftStart}" nextStart="{$nextStart}"/&gt;
             &lt;/xsl:when&gt;</span><span class="z">--&gt;</span><span class="txt">
        </span><span class="ww" id="w2010"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-exists" class="solar"><span class="function">exists</span></a><span class="parenthesis">(</span><span class="variable">$start</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w2023"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isClose</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w2033"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="av">sc</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">&amp;lt;/</span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx2045" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx2049" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ww" id="w2051"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isOpen</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w2061"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="av">es</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">&amp;lt;</span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx2073" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx2077" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ww" id="w2079"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w2083"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$name</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">start-xquery</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="ww" id="w2099"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-empty" class="solar"><span class="function">empty</span></a><span class="parenthesis">(</span><span class="variable">$nextStart</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace"> </span><span class="variable">$shiftStart</span><span class="whitespace"> </span><span class="op">ne</span><span class="whitespace"> </span><span class="variable">$nextStart</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                </span><span class="z">&lt;!--</span><span class="cm">&lt;xquery pos="{$shiftStart}"/&gt;</span><span class="z">--&gt;</span><span class="txt">
                </span><span class="ww" id="w2124"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$xq-token</span><span class="z">"</span><span id="wx2132" class="sc">/&gt;</span></span><span class="txt">
              </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx2136" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx2140" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ww" id="w2142"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$name</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">literal</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">comment</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="ww" id="w2164"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
                </span><span class="ww" id="w2168"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$name</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">literal</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                  </span><span class="ww" id="w2184"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?quote">quote</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-codepoints-to-string" class="solar"><span class="function">codepoints-to-string</span></a><span class="parenthesis">(</span><span class="variable">$block</span><span class="step">/</span><span class="axis">@</span><span class="qname">type</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx2204" class="sc">/&gt;</span></span><span class="txt">
                  </span><span class="ww" id="w2206"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?is-map-property">is-map-property</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-matches" class="solar"><span class="function">matches</span></a><span class="parenthesis">(</span><span class="variable">$following-string</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">^\s*:</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx2228" class="sc">/&gt;</span></span><span class="txt">
                  </span><span class="ww" id="w2230"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="av">op</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt"></span><span class="ww" id="w2240"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$quote</span><span class="z">"</span><span id="wx2248" class="sc">/&gt;</span></span><span class="txt"></span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx2252" class="ec">&gt;</span></span><span class="txt">
                  </span><span class="ww" id="w2254"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="if">if</span><span class="parenthesis">(</span><span class="variable">$is-map-property</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">property</span><span class="op">'</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$name</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                    </span><span class="ww" id="w2279"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-substring" class="solar"><span class="function">substring</span></a><span class="parenthesis">(</span><span class="variable">$text</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">2</span><span class="op">,</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-string-length" class="solar"><span class="function">string-length</span></a><span class="parenthesis">(</span><span class="variable">$text</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">2</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx2303" class="sc">/&gt;</span></span><span class="txt">                          
                  </span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx2307" class="ec">&gt;</span></span><span class="txt">
                  </span><span class="ww" id="w2309"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="av">op</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt"></span><span class="ww" id="w2319"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$quote</span><span class="z">"</span><span id="wx2327" class="sc">/&gt;</span></span><span class="txt"></span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx2331" class="ec">&gt;</span></span><span class="txt">
                </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx2335" class="ec">&gt;</span></span><span class="txt">
                </span><span class="ww" id="w2337"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
                  </span><span class="ww" id="w2341"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$name</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                    </span><span class="ww" id="w2353"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$text</span><span class="z">"</span><span id="wx2361" class="sc">/&gt;</span></span><span class="txt">                               
                  </span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx2365" class="ec">&gt;</span></span><span class="txt">                                   
                </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx2369" class="ec">&gt;</span></span><span class="txt">
              </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx2373" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx2377" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ww" id="w2379"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="ww" id="w2383"><span class="es">&lt;</span><span class="en">span</span><span class="z">
                  </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$name</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">x-tag-end</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">xml-tag</span><span class="op">'</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> 
                         </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">z</span><span class="op">'</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}getClassFromName" class="solar"><span class="function">f:getClassFromName</span></a><span class="parenthesis">(</span><span class="variable">$name</span><span class="parenthesis">)</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">                                      
                </span><span class="ww" id="w2424"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$text</span><span class="z">"</span><span id="wx2432" class="sc">/&gt;</span></span><span class="txt">
              </span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx2436" class="ec">&gt;</span></span><span class="txt">                           
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx2440" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx2444" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx2448" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx2452" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ww" id="w2454"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-empty" class="solar"><span class="function">empty</span></a><span class="parenthesis">(</span><span class="variable">$nextStart</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$followingStart</span><span class="whitespace"> </span><span class="op">ne</span><span class="whitespace"> </span><span class="variable">$nextStart</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w2477"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w2481"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$name</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">comment</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">literal</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">   
            </span><span class="ww" id="w2504"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$xq-token</span><span class="z">"</span><span id="wx2512" class="sc">/&gt;</span></span><span class="txt">                     
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx2516" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ww" id="w2518"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$name</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">x-tag-end</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">xml-tag</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w2541"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$name</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">xml-tag</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}getClassFromType" class="solar"><span class="function">f:getClassFromType</span></a><span class="parenthesis">(</span><span class="variable">$newType</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">txt</span><span class="op">'</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="ww" id="w2576"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$following-string</span><span class="z">"</span><span id="wx2584" class="sc">/&gt;</span></span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx2588" class="ec">&gt;</span></span><span class="txt">                                          
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx2592" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx2596" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx2600" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx2604" class="ec">&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w2606"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?final-result">final-result</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="parenthesis">(</span><span class="variable">$result</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$result1</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx2631" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w2633"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w2637"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="variable">$count</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w2651"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$final-result</span><span class="z">"</span><span id="wx2659" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx2663" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ww" id="w2665"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w2669"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}tokeniseBlocks" class="solar"><span class="function">f:tokeniseBlocks</span></a><span class="parenthesis">(</span><span class="variable">$doc-text</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$blocks</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$newType</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$final-result</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$new-is-preceding-closed</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx2699" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx2703" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx2707" class="ec">&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx2711" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w2713"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{urn:xq.internal-function}handleXquery">f:handleXquery</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w2729"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?text">text</span><span class="z">"</span><span id="wx2737" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w2739"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?is-preceding-literal">is-preceding-literal</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span id="wx2753" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w2755"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-handler.xsl.html#f?{com.qutoric.xq.functions}createXqTokens" class="solar"><span class="function">xq:createXqTokens</span></a><span class="parenthesis">(</span><span class="variable">$text</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$is-preceding-literal</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx2769" class="sc">/&gt;</span></span><span class="txt">       
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx2773" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w2775"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{urn:xq.internal-function}createXqBlocks">f:createXqBlocks</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w2791"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?chars">chars</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer*</span><span class="z">"</span><span id="wx2805" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w2807"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}createXqBlocks" class="solar"><span class="function">f:createXqBlocks</span></a><span class="parenthesis">(</span><span class="variable">$chars</span><span class="op">,</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-false" class="solar"><span class="function">false</span></a><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace">
                          </span><span class="numeric">0</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">0</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">0</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">0</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx2857" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx2861" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w2863"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{urn:xq.internal-function}createXslTvtBlocks">f:createXslTvtBlocks</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w2879"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?chars">chars</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer*</span><span class="z">"</span><span id="wx2893" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="z">&lt;!--</span><span class="cm">
         &lt;xsl:sequence select="f:createXmlBlocks($chars, 1, $cTagStart, 1, 1, 1, (), (), ())"/&gt;
    </span><span class="z">--&gt;</span><span class="txt">
    </span><span class="ww" id="w2899"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}createXqBlocks" class="solar"><span class="function">f:createXqBlocks</span></a><span class="parenthesis">(</span><span class="variable">$chars</span><span class="op">,</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-false" class="solar"><span class="function">false</span></a><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace">
                          </span><span class="numeric">0</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">0</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">0</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">0</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx2949" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx2953" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w2955"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?class-in">class-in</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span class="z">
                </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">x-comment</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">x-cdata</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">x-pi</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">x-dtd</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx2991" class="sc">/&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w2993"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?class-out">class-out</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span class="z">
                </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">cm</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">cd</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">pi</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">dt</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx3029" class="sc">/&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w3031"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?name-in">name-in</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span class="z">
                </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">nested-query</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">unnested-xquery</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">xml-open-tag</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">xml-name-end</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">x-equals</span><span class="op">'</span><span class="op">,</span><span class="whitespace">
                        </span><span class="op">'</span><span class="literal">xml-att-quote</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">xml-literal-start</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">xml-literal-end</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">resume-x-literal</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">resume-x-literal-txt</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">xml-close-tag</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx3103" class="sc">/&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w3105"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?name-out">name-out</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span class="z">
                </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">op</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">op</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">en</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">atn</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">atneq</span><span class="op">'</span><span class="op">,</span><span class="whitespace">
                        </span><span class="op">'</span><span class="literal">z</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">av</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">atn</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">av</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">txt</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">cl</span><span class="op">'</span><span class="whitespace"> </span><span class="parenthesis">)</span><span class="z">"</span><span id="wx3179" class="sc">/&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w3181"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{urn:xq.internal-function}getClassFromType">f:getClassFromType</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w3191"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?type">type</span><span class="z">"</span><span id="wx3199" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w3201"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?index">index</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer?</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-index-of" class="solar"><span class="function">index-of</span></a><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#v?class-in" class="solar"><span class="variable">$class-in</span></a><span class="op">,</span><span class="whitespace"> </span><span class="variable">$type</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx3227" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w3229"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-exists" class="solar"><span class="function">exists</span></a><span class="parenthesis">(</span><span class="variable">$index</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?class-out" class="solar"><span class="variable">$class-out</span></a><span class="filter">[</span><span class="variable">$index</span><span class="filter">]</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$type</span><span class="z">"</span><span id="wx3255" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx3259" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w3261"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{urn:xq.internal-function}getClassFromName">f:getClassFromName</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w3271"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?type">type</span><span class="z">"</span><span id="wx3279" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w3281"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?index">index</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer?</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-index-of" class="solar"><span class="function">index-of</span></a><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#v?name-in" class="solar"><span class="variable">$name-in</span></a><span class="op">,</span><span class="whitespace"> </span><span class="variable">$type</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx3307" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w3309"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-exists" class="solar"><span class="function">exists</span></a><span class="parenthesis">(</span><span class="variable">$index</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?name-out" class="solar"><span class="variable">$name-out</span></a><span class="filter">[</span><span class="variable">$index</span><span class="filter">]</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$type</span><span class="z">"</span><span id="wx3335" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx3339" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w3341"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{urn:xq.internal-function}createXmlBlocks">f:createXmlBlocks</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w3357"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?chars">chars</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer*</span><span class="z">"</span><span id="wx3371" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w3373"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?index">index</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx3387" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w3389"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?awaiting">awaiting</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer*</span><span class="z">"</span><span id="wx3403" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w3405"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?start">start</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx3419" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w3421"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?level">level</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx3435" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w3437"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?xq-fnlevel">xq-fnlevel</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx3451" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w3453"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?xml-stack">xml-stack</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer*</span><span class="z">"</span><span id="wx3467" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w3469"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?xq-stack">xq-stack</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer*</span><span class="z">"</span><span id="wx3483" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w3485"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?result">result</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span id="wx3499" class="sc">/&gt;</span></span><span class="txt">        
    
    </span><span class="ww" id="w3501"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?char">char</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$chars</span><span class="filter">[</span><span class="variable">$index</span><span class="filter">]</span><span class="z">"</span><span id="wx3524" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w3526"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?pChar">pChar</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer?</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$chars</span><span class="filter">[</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">1</span><span class="filter">]</span><span class="z">"</span><span id="wx3553" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w3555"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?n1Char">n1Char</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer?</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$chars</span><span class="filter">[</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="filter">]</span><span class="z">"</span><span id="wx3582" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w3584"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?n2Char">n2Char</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer?</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$chars</span><span class="filter">[</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">2</span><span class="filter">]</span><span class="z">"</span><span id="wx3611" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w3613"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?limit">limit</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-count" class="solar"><span class="function">count</span></a><span class="parenthesis">(</span><span class="variable">$awaiting</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">1</span><span class="z">"</span><span id="wx3640" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w3642"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?compChars">compChars</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer*</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$i</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="numeric">0</span><span class="whitespace"> </span><span class="op">to</span><span class="whitespace"> </span><span class="variable">$limit</span><span class="whitespace"> </span><span class="op">return</span><span class="whitespace"> </span><span class="variable">$chars</span><span class="filter">[</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="variable">$i</span><span class="filter">]</span><span class="z">"</span><span id="wx3683" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w3685"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?isLiteralStart">isLiteralStart</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?xxAnyTagEnd" class="solar"><span class="variable">$xxAnyTagEnd</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#v?cApos" class="solar"><span class="variable">$cApos</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cQuote" class="solar"><span class="variable">$cQuote</span></a><span class="parenthesis">)</span><span class="z">"</span><span id="wx3722" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w3724"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?isLiteralEnd">isLiteralEnd</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#v?cApos" class="solar"><span class="variable">$cApos</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cQuote" class="solar"><span class="variable">$cQuote</span></a><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$awaiting</span><span class="z">"</span><span id="wx3761" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w3763"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?awaiting-tag">awaiting-tag</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">item()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w3779"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w3783"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-empty" class="solar"><span class="function">empty</span></a><span class="parenthesis">(</span><span class="variable">$awaiting</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w3796"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}getAwaitingFrom2ndChar" class="solar"><span class="function">f:getAwaitingFrom2ndChar</span></a><span class="parenthesis">(</span><span class="variable">$char</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$n1Char</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx3810" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx3814" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w3816"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cTagStart" class="solar"><span class="variable">$cTagStart</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$char</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w3838"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}getAwaitingFrom2ndChar" class="solar"><span class="function">f:getAwaitingFrom2ndChar</span></a><span class="parenthesis">(</span><span class="variable">$n1Char</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$n2Char</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx3852" class="sc">/&gt;</span></span><span class="txt">                   
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx3856" class="ec">&gt;</span></span><span class="txt">               
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx3860" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx3864" class="ec">&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w3866"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?other-tag-end">other-tag-end</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$limit</span><span class="whitespace"> </span><span class="op">gt</span><span class="whitespace"> </span><span class="numeric">0</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-deep-equal" class="solar"><span class="function">deep-equal</span></a><span class="parenthesis">(</span><span class="variable">$compChars</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$awaiting</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx3900" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w3902"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?result1">result1</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()?</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w3918"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w3922"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$other-tag-end</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w3932"><span class="es">&lt;</span><span class="en">x-tag-end</span><span class="z"> </span><span class="atn">pos</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$index</span><span class="op">}</span><span class="z">"</span><span class="z"> </span><span class="atn">length</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$limit</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">}</span><span class="z">"</span><span id="wx3954" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx3958" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w3960"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?xxAnyTagEnd" class="solar"><span class="variable">$xxAnyTagEnd</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cTagEnd" class="solar"><span class="variable">$cTagEnd</span></a><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w3982"><span class="es">&lt;</span><span class="en">x-tag-end</span><span class="z"> </span><span class="atn">pos</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$index</span><span class="op">}</span><span class="z">"</span><span class="z"> </span><span class="atn">length</span><span class="atneq">=</span><span class="z">"</span><span class="av">1</span><span class="z">"</span><span id="wx3998" class="sc">/&gt;</span></span><span class="txt">               
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx4002" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w4004"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?xxCloseTagEnd" class="solar"><span class="variable">$xxCloseTagEnd</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cTagEnd" class="solar"><span class="variable">$cTagEnd</span></a><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w4026"><span class="es">&lt;</span><span class="en">x-tag-end</span><span class="z"> </span><span class="atn">pos</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$index</span><span class="op">}</span><span class="z">"</span><span class="z"> </span><span class="atn">length</span><span class="atneq">=</span><span class="z">"</span><span class="av">1</span><span class="z">"</span><span id="wx4042" class="sc">/&gt;</span></span><span class="txt">                
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx4046" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w4048"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?xxAnyTagEnd" class="solar"><span class="variable">$xxAnyTagEnd</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?xEquals" class="solar"><span class="variable">$xEquals</span></a><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w4070"><span class="es">&lt;</span><span class="en">x-equals</span><span class="z"> </span><span class="atn">pos</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$index</span><span class="op">}</span><span class="z">"</span><span id="wx4080" class="sc">/&gt;</span></span><span class="txt">                
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx4084" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx4088" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx4092" class="ec">&gt;</span></span><span class="txt">
    
    </span><span class="z">&lt;!--</span><span class="cm"> a close tag &lt;/close&gt; </span><span class="z">--&gt;</span><span class="txt">
    </span><span class="ww" id="w4098"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?isCloseTag">isCloseTag</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cTagStart" class="solar"><span class="variable">$cTagStart</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cTagStart" class="solar"><span class="variable">$cTagStart</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$n1Char</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?xSlash" class="solar"><span class="variable">$xSlash</span></a><span class="z">"</span><span id="wx4138" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="z">&lt;!--</span><span class="cm"> probably an open tag &lt;open&gt; - but may be empty eg. &lt;empty/&gt; </span><span class="z">--&gt;</span><span class="txt">
    </span><span class="ww" id="w4144"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?isOpenTag">isOpenTag</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-empty" class="solar"><span class="function">empty</span></a><span class="parenthesis">(</span><span class="variable">$awaiting</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">gt</span><span class="whitespace"> </span><span class="numeric">64</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cTagStart" class="solar"><span class="variable">$cTagStart</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cTagStart" class="solar"><span class="variable">$cTagStart</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$n1Char</span><span class="whitespace"> </span><span class="op">gt</span><span class="whitespace"> </span><span class="numeric">64</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx4203" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w4205"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?isTagNameEnd">isTagNameEnd</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?xxInitTagEnd" class="solar"><span class="variable">$xxInitTagEnd</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cWhitespace" class="solar"><span class="variable">$cWhitespace</span></a><span class="z">"</span><span id="wx4237" class="sc">/&gt;</span></span><span class="txt">        
    
    </span><span class="z">&lt;!--</span><span class="cm"> last 2 items in sequence are reserved for tag markup </span><span class="z">--&gt;</span><span class="txt">
    </span><span class="ww" id="w4243"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?count-awaiting">count-awaiting</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-count" class="solar"><span class="function">count</span></a><span class="parenthesis">(</span><span class="variable">$awaiting-tag</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">2</span><span class="z">"</span><span id="wx4270" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w4272"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?nowAwaiting">nowAwaiting</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w4288"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w4292"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isOpenTag</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w4302"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#v?xxInitTagEnd" class="solar"><span class="variable">$xxInitTagEnd</span></a><span class="z">"</span><span id="wx4310" class="sc">/&gt;</span></span><span class="txt">                   
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx4314" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w4316"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isTagNameEnd</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w4326"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#v?xxTagEnd" class="solar"><span class="variable">$xxTagEnd</span></a><span class="z">"</span><span id="wx4334" class="sc">/&gt;</span></span><span class="txt">                   
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx4338" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w4340"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isCloseTag</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w4350"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#v?xxCloseTagEnd" class="solar"><span class="variable">$xxCloseTagEnd</span></a><span class="z">"</span><span id="wx4358" class="sc">/&gt;</span></span><span class="txt">                      
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx4362" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w4364"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-exists" class="solar"><span class="function">exists</span></a><span class="parenthesis">(</span><span class="variable">$awaiting-tag</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w4377"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-subsequence" class="solar"><span class="function">subsequence</span></a><span class="parenthesis">(</span><span class="variable">$awaiting-tag</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$count-awaiting</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx4394" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx4398" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w4400"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?xxCloseTagEnd" class="solar"><span class="variable">$xxCloseTagEnd</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cTagEnd" class="solar"><span class="variable">$cTagEnd</span></a><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w4422"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#v?cTagStart" class="solar"><span class="variable">$cTagStart</span></a><span class="z">"</span><span id="wx4430" class="sc">/&gt;</span></span><span class="txt">                   
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx4434" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w4436"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?xxAnyTagEnd" class="solar"><span class="variable">$xxAnyTagEnd</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#v?xSlash" class="solar"><span class="variable">$xSlash</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cTagEnd" class="solar"><span class="variable">$cTagEnd</span></a><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w4463"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#v?cTagStart" class="solar"><span class="variable">$cTagStart</span></a><span class="z">"</span><span id="wx4471" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx4475" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w4477"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isLiteralStart</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w4487"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$char</span><span class="z">"</span><span id="wx4495" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx4499" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w4501"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isLiteralEnd</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w4511"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#v?xxTagEnd" class="solar"><span class="variable">$xxTagEnd</span></a><span class="z">"</span><span id="wx4519" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx4523" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w4525"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-deep-equal" class="solar"><span class="function">deep-equal</span></a><span class="parenthesis">(</span><span class="variable">$compChars</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$awaiting</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="z">&lt;!--</span><span class="cm"> must always be waiting for something in XML, so assume tag start </span><span class="z">--&gt;</span><span class="txt">
          </span><span class="ww" id="w4545"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#v?cTagStart" class="solar"><span class="variable">$cTagStart</span></a><span class="z">"</span><span id="wx4553" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx4557" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w4559"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w4563"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="z">"</span><span id="wx4571" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx4575" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx4579" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx4583" class="ec">&gt;</span></span><span class="txt">
    
    
    </span><span class="z">&lt;!--</span><span class="cm"> required to correct an empty tag falsely assumed to be an open tag &lt;empty/&gt; </span><span class="z">--&gt;</span><span class="txt">
    </span><span class="ww" id="w4589"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?isEmptyTag">isEmptyTag</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?xxAnyTagEnd" class="solar"><span class="variable">$xxAnyTagEnd</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?xSlash" class="solar"><span class="variable">$xSlash</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$n1Char</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cTagEnd" class="solar"><span class="variable">$cTagEnd</span></a><span class="z">"</span><span id="wx4629" class="sc">/&gt;</span></span><span class="txt">       
    
    </span><span class="z">&lt;!--</span><span class="cm"> must ignore {{ char sequence, but no need to ignore }} </span><span class="z">--&gt;</span><span class="txt">
    </span><span class="ww" id="w4635"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?isEmbeddedXQuery">isEmbeddedXQuery</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cFnStart" class="solar"><span class="variable">$cFnStart</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$n1Char</span><span class="whitespace"> </span><span class="op">ne</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cFnStart" class="solar"><span class="variable">$cFnStart</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$pChar</span><span class="whitespace"> </span><span class="op">ne</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cFnStart" class="solar"><span class="variable">$cFnStart</span></a><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#v?cApos" class="solar"><span class="variable">$cApos</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cQuote" class="solar"><span class="variable">$cQuote</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cTagStart" class="solar"><span class="variable">$cTagStart</span></a><span class="parenthesis">)</span><span class="z">"</span><span id="wx4693" class="sc">/&gt;</span></span><span class="txt">
    
    
    </span><span class="ww" id="w4695"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?poss-xml-end">poss-xml-end</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isEmptyTag</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace"> </span><span class="variable">$other-tag-end</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#v?xxAnyTagEnd" class="solar"><span class="variable">$xxAnyTagEnd</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?xxCloseTagEnd" class="solar"><span class="variable">$xxCloseTagEnd</span></a><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cTagEnd" class="solar"><span class="variable">$cTagEnd</span></a><span class="parenthesis">)</span><span class="z">"</span><span id="wx4742" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w4744"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?newLevel">newLevel</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$isOpenTag</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$level</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$isCloseTag</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace"> </span><span class="variable">$isEmptyTag</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$level</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$level</span><span class="z">"</span><span id="wx4800" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w4802"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?newXqFnLevel">newXqFnLevel</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$isEmbeddedXQuery</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                          </span><span class="variable">$xq-fnlevel</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$xq-fnlevel</span><span class="z">"</span><span id="wx4838" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="z">&lt;!--</span><span class="cm">       &lt;xsl:variable name="test-string" select="codepoints-to-string(subsequence($chars, $index + 1, 10))"/&gt;</span><span class="z">--&gt;</span><span class="txt">
    
    </span><span class="ww" id="w4844"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?result2">result2</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w4860"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w4864"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isTagNameEnd</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w4874"><span class="es">&lt;</span><span class="en">xml-name-end</span><span class="z"> </span><span class="atn">pos</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$index</span><span class="op">}</span><span class="z">"</span><span id="wx4884" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx4888" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w4890"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isOpenTag</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w4900"><span class="es">&lt;</span><span class="en">xml-open-tag</span><span class="z"> </span><span class="atn">pos</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cTagStart" class="solar"><span class="variable">$cTagStart</span></a><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">}</span><span class="z">"</span><span id="wx4930" class="sc">/&gt;</span></span><span class="txt">                    
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx4934" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w4936"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isEmptyTag</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w4946"><span class="es">&lt;</span><span class="en">x-tag-end</span><span class="z"> </span><span class="atn">pos</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$index</span><span class="op">}</span><span class="z">"</span><span class="z"> </span><span class="atn">length</span><span class="atneq">=</span><span class="z">"</span><span class="av">2</span><span class="z">"</span><span class="z"> </span><span class="atn">level</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$level</span><span class="op">}</span><span class="z">"</span><span id="wx4970" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx4974" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w4976"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isCloseTag</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w4986"><span class="es">&lt;</span><span class="en">xml-close-tag</span><span class="z"> </span><span class="atn">pos</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$index</span><span class="op">}</span><span class="z">"</span><span id="wx4996" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx5000" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w5002"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isLiteralStart</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w5012"><span class="es">&lt;</span><span class="en">xml-att-quote</span><span class="z"> </span><span class="atn">pos</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$index</span><span class="op">}</span><span class="z">"</span><span id="wx5022" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w5024"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function">not</span></a><span class="parenthesis">(</span><span class="variable">$n1Char</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$nowAwaiting</span><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cFnStart" class="solar"><span class="variable">$cFnStart</span></a><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w5046"><span class="es">&lt;</span><span class="en">xml-literal-start</span><span class="z"> </span><span class="atn">pos</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">}</span><span class="z">"</span><span id="wx5060" class="sc">/&gt;</span></span><span class="txt">                            
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx5064" class="ec">&gt;</span></span><span class="txt">            
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx5068" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w5070"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isLiteralEnd</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w5080"><span class="es">&lt;</span><span class="en">xml-att-quote</span><span class="z"> </span><span class="atn">pos</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$index</span><span class="op">}</span><span class="z">"</span><span id="wx5090" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w5092"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function">not</span></a><span class="parenthesis">(</span><span class="variable">$n1Char</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#v?xSlash" class="solar"><span class="variable">$xSlash</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cTagEnd" class="solar"><span class="variable">$cTagEnd</span></a><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w5114"><span class="es">&lt;</span><span class="en">xml-literal-end</span><span class="z"> </span><span class="atn">pos</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">}</span><span class="z">"</span><span id="wx5128" class="sc">/&gt;</span></span><span class="txt">                         
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx5132" class="ec">&gt;</span></span><span class="txt">               
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx5136" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w5138"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-exists" class="solar"><span class="function">exists</span></a><span class="parenthesis">(</span><span class="variable">$awaiting-tag</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w5151"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?awaiting-offset">awaiting-offset</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z">
                        </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-empty" class="solar"><span class="function">empty</span></a><span class="parenthesis">(</span><span class="variable">$awaiting</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="numeric">0</span><span class="z">"</span><span id="wx5186" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w5188"><span class="es">&lt;</span><span class="en">xml-tag</span><span class="z"> </span><span class="atn">pos</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="variable">$awaiting-offset</span><span class="op">}</span><span class="z">"</span><span class="z"> </span><span class="atn">type</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$awaiting-tag</span><span class="filter">[</span><a href="http://www.w3.org/TR/xpath-functions/#func-last" class="solar"><span class="function">last</span></a><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">1</span><span class="filter">]</span><span class="op">}</span><span class="z">"</span><span class="z"> </span><span class="atn">length</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$awaiting-tag</span><span class="filter">[</span><a href="http://www.w3.org/TR/xpath-functions/#func-last" class="solar"><span class="function">last</span></a><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="filter">]</span><span class="op">}</span><span class="z">"</span><span id="wx5232" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx5236" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx5240" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx5244" class="ec">&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w5246"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?final-result">final-result</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="parenthesis">(</span><span class="variable">$result</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$result1</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$result2</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx5274" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5276"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?xml-stack-level">xml-stack-level</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-exists" class="solar"><span class="function">exists</span></a><span class="parenthesis">(</span><span class="variable">$xml-stack</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$xml-stack</span><span class="filter">[</span><a href="http://www.w3.org/TR/xpath-functions/#func-last" class="solar"><span class="function">last</span></a><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="filter">]</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="numeric">0</span><span class="z">"</span><span id="wx5316" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w5318"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w5322"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">ge</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-count" class="solar"><span class="function">count</span></a><span class="parenthesis">(</span><span class="variable">$chars</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">                
        </span><span class="ww" id="w5339"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$final-result</span><span class="z">"</span><span id="wx5347" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ww" id="w5349"><span class="es">&lt;</span><span class="en">terminate-xml</span><span id="wx5351" class="sc">/&gt;</span></span><span class="txt">   
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx5355" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ww" id="w5357"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="parenthesis">(</span><span class="variable">$newLevel</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="variable">$xml-stack-level</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$poss-xml-end</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="z">&lt;!--</span><span class="cm">&lt;xsl:when test="($level eq $xml-stack-level and $char eq $cTagEnd) or ($level eq $xml-stack-level + 1 and $other-tag-end)"&gt;</span><span class="z">--&gt;</span><span class="txt">
        </span><span class="ww" id="w5381"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?offset">offset</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z">
                      </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$isEmptyTag</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$limit</span><span class="z">"</span><span id="wx5413" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ww" id="w5415"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?end">end</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w5431"><span class="es">&lt;</span><span class="en">start-xquery</span><span class="z"> </span><span class="atn">pos</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="variable">$offset</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">}</span><span class="z">"</span><span id="wx5449" class="sc">/&gt;</span></span><span class="txt">                     
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx5453" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w5455"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?popped-stack">popped-stack</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer*</span><span class="z">"</span><span class="z">
                      </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-subsequence" class="solar"><span class="function">subsequence</span></a><span class="parenthesis">(</span><span class="variable">$xml-stack</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-count" class="solar"><span class="function">count</span></a><span class="parenthesis">(</span><span class="variable">$xml-stack</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx5491" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ww" id="w5493"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}createXqBlocks" class="solar"><span class="function">f:createXqBlocks</span></a><span class="parenthesis">(</span><span class="variable">$chars</span><span class="op">,</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-false" class="solar"><span class="function">false</span></a><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">0</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">0</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$newXqFnLevel</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$newLevel</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$nowAwaiting</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$popped-stack</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$xq-stack</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$final-result</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$end</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx5549" class="sc">/&gt;</span></span><span class="txt">                 
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx5553" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ww" id="w5555"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isEmbeddedXQuery</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w5565"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?end">end</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()+</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w5581"><span class="es">&lt;</span><span class="en">nested-query</span><span class="z"> </span><span class="atn">pos</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$index</span><span class="op">}</span><span class="z">"</span><span id="wx5591" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w5593"><span class="es">&lt;</span><span class="en">start-xquery</span><span class="z"> </span><span class="atn">pos</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">}</span><span class="z">"</span><span id="wx5607" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx5611" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w5613"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}createXqBlocks" class="solar"><span class="function">f:createXqBlocks</span></a><span class="parenthesis">(</span><span class="variable">$chars</span><span class="op">,</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-false" class="solar"><span class="function">false</span></a><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">0</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">0</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$newXqFnLevel</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$newLevel</span><span class="op">,</span><span class="whitespace">
                              </span><span class="variable">$nowAwaiting</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$xml-stack</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$xq-stack</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$newXqFnLevel</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$final-result</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$end</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx5674" class="sc">/&gt;</span></span><span class="txt">               
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx5678" class="ec">&gt;</span></span><span class="txt">           
      </span><span class="ww" id="w5680"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w5684"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}createXmlBlocks" class="solar"><span class="function">f:createXmlBlocks</span></a><span class="parenthesis">(</span><span class="variable">$chars</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$nowAwaiting</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$start</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$newLevel</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$newXqFnLevel</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$xml-stack</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$xq-stack</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$final-result</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx5723" class="sc">/&gt;</span></span><span class="txt">                
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx5727" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx5731" class="ec">&gt;</span></span><span class="txt">
    
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx5735" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w5737"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{urn:xq.internal-function}createXqBlocks">f:createXqBlocks</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w5753"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?chars">chars</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer*</span><span class="z">"</span><span id="wx5767" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5769"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?skip">skip</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span id="wx5783" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5785"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?index">index</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx5799" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5801"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?awaiting">awaiting</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer*</span><span class="z">"</span><span id="wx5815" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5817"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?start">start</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx5831" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5833"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?level">level</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx5847" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5849"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?fnLevel">fnLevel</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx5863" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="z">&lt;!--</span><span class="cm"> xml nesting level </span><span class="z">--&gt;</span><span class="txt">
    </span><span class="ww" id="w5869"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?xLevel">xLevel</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx5883" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="z">&lt;!--</span><span class="cm"> whether in attribute ' or " or element: &lt; </span><span class="z">--&gt;</span><span class="txt">
    </span><span class="ww" id="w5889"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?xAwaiting">xAwaiting</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx5903" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5905"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?xml-stack">xml-stack</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer*</span><span class="z">"</span><span id="wx5919" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5921"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?xq-stack">xq-stack</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer*</span><span class="z">"</span><span id="wx5935" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5937"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?result">result</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span id="wx5951" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w5953"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?charCount">charCount</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-count" class="solar"><span class="function">count</span></a><span class="parenthesis">(</span><span class="variable">$chars</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx5970" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w5972"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?char">char</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$chars</span><span class="filter">[</span><span class="variable">$index</span><span class="filter">]</span><span class="z">"</span><span id="wx5995" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5997"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?nChar">nChar</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer?</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$chars</span><span class="filter">[</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="filter">]</span><span class="z">"</span><span id="wx6024" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w6026"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?pChar">pChar</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer?</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$chars</span><span class="filter">[</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">1</span><span class="filter">]</span><span class="z">"</span><span id="wx6053" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w6055"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?newLevel">newLevel</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w6071"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w6075"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#v?cColon" class="solar"><span class="variable">$cColon</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cBracketEnd" class="solar"><span class="variable">$cBracketEnd</span></a><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w6094"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="parenthesis">(</span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cBracketStart" class="solar"><span class="variable">$cBracketStart</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$nChar</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cColon" class="solar"><span class="variable">$cColon</span></a><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$level</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace">
                                </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cBracketEnd" class="solar"><span class="variable">$cBracketEnd</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$pChar</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cColon" class="solar"><span class="variable">$cColon</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$level</span><span class="whitespace"> </span><span class="op">gt</span><span class="whitespace"> </span><span class="numeric">0</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$level</span><span class="whitespace"> </span><span class="numeric">-1</span><span class="whitespace">
                                </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$level</span><span class="z">"</span><span id="wx6163" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx6167" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w6169"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w6173"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$level</span><span class="z">"</span><span id="wx6181" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx6185" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx6189" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx6193" class="ec">&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w6195"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?nowAwaiting">nowAwaiting</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w6211"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w6215"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-empty" class="solar"><span class="function">empty</span></a><span class="parenthesis">(</span><span class="variable">$awaiting</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w6228"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z">
              </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="parenthesis">(</span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#v?cQuote" class="solar"><span class="variable">$cQuote</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cApos" class="solar"><span class="variable">$cApos</span></a><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">
                      </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$char</span><span class="whitespace"> 
                      </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cBracketStart" class="solar"><span class="variable">$cBracketStart</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$nChar</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cColon" class="solar"><span class="variable">$cColon</span></a><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#v?cColon" class="solar"><span class="variable">$cColon</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cBracketEnd" class="solar"><span class="variable">$cBracketEnd</span></a><span class="parenthesis">)</span><span class="whitespace"> 
                      </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx6286" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx6290" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w6292"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-deep-equal" class="solar"><span class="function">deep-equal</span></a><span class="parenthesis">(</span><span class="variable">$char</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$awaiting</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w6308"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx6317" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx6321" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w6323"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#v?cColon" class="solar"><span class="variable">$cColon</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cBracketEnd" class="solar"><span class="variable">$cBracketEnd</span></a><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cBracketEnd" class="solar"><span class="variable">$cBracketEnd</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$pChar</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cColon" class="solar"><span class="variable">$cColon</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$level</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="numeric">0</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w6366"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx6375" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx6379" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w6381"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w6385"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="z">"</span><span id="wx6393" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx6397" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx6401" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx6405" class="ec">&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w6407"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?nowSkip">nowSkip</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w6423"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w6427"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$skip</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w6437"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-false" class="solar"><span class="function">false</span></a><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx6447" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx6451" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w6453"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#v?cApos" class="solar"><span class="variable">$cApos</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cQuote" class="solar"><span class="variable">$cQuote</span></a><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$nChar</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$char</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w6488"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-true" class="solar"><span class="function">true</span></a><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx6498" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx6502" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w6504"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w6508"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-false" class="solar"><span class="function">false</span></a><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx6518" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx6522" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx6526" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx6530" class="ec">&gt;</span></span><span class="txt">
    
    </span><span class="z">&lt;!--</span><span class="cm">        &lt;xsl:if test="empty($awaiting) and empty($nowAwaiting)"&gt;
         &lt;xsl:if test="$char = ($cParenStart,$cParenEnd,$cBracketStart,$cBracketEnd)"&gt;
         &lt;block position="{$index}" type="{codepoints-to-string($char)}"/&gt;
         &lt;/xsl:if&gt;
         &lt;/xsl:if&gt;</span><span class="z">--&gt;</span><span class="txt">
    
    </span><span class="ww" id="w6536"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?isFound">isFound</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function">not</span></a><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-deep-equal" class="solar"><span class="function">deep-equal</span></a><span class="parenthesis">(</span><span class="variable">$awaiting</span><span class="op">,</span><span class="variable">$nowAwaiting</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function">not</span></a><span class="parenthesis">(</span><span class="variable">$skip</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace"> </span><span class="variable">$nowSkip</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx6575" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w6577"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?newStart">newStart</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$isFound</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$start</span><span class="z">"</span><span id="wx6609" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w6611"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?result1">result1</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()?</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w6627"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-exists" class="solar"><span class="function">exists</span></a><span class="parenthesis">(</span><span class="variable">$awaiting</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$isFound</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w6644"><span class="es">&lt;</span><span class="enxsl">xsl:element</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-deep-equal" class="solar"><span class="function">deep-equal</span></a><span class="parenthesis">(</span><span class="variable">$awaiting</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#v?cColon" class="solar"><span class="variable">$cColon</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cBracketEnd" class="solar"><span class="variable">$cBracketEnd</span></a><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">comment</span><span class="op">'</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">literal</span><span class="op">'</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w6683"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function">not</span></a><span class="parenthesis">(</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#v?cColon" class="solar"><span class="variable">$cColon</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cBracketEnd" class="solar"><span class="variable">$cBracketEnd</span></a><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w6705"><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">type</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$char</span><span class="z">"</span><span id="wx6719" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx6723" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ww" id="w6725"><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">start</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$start</span><span class="z">"</span><span id="wx6739" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w6741"><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">end</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$index</span><span class="z">"</span><span id="wx6755" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:element</span><span id="wx6759" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx6763" class="ec">&gt;</span></span><span class="txt">            
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx6767" class="ec">&gt;</span></span><span class="txt">
    
            
    </span><span class="ww" id="w6769"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?newFnLevel">newFnLevel</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w6785"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w6789"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-empty" class="solar"><span class="function">empty</span></a><span class="parenthesis">(</span><span class="variable">$awaiting</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w6802"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="parenthesis">(</span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cFnStart" class="solar"><span class="variable">$cFnStart</span></a><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$fnLevel</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace">
                                </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cFnEnd" class="solar"><span class="variable">$cFnEnd</span></a><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$fnLevel</span><span class="whitespace"> </span><span class="numeric">-1</span><span class="whitespace">
                                </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$fnLevel</span><span class="z">"</span><span id="wx6847" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx6851" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w6853"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w6857"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$fnLevel</span><span class="z">"</span><span id="wx6865" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx6869" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx6873" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx6877" class="ec">&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w6879"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?xq-stack-level">xq-stack-level</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-empty" class="solar"><span class="function">empty</span></a><span class="parenthesis">(</span><span class="variable">$xq-stack</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="numeric">0</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$xq-stack</span><span class="filter">[</span><a href="http://www.w3.org/TR/xpath-functions/#func-last" class="solar"><span class="function">last</span></a><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="filter">]</span><span class="z">"</span><span id="wx6919" class="sc">/&gt;</span></span><span class="txt">        
    </span><span class="ww" id="w6921"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?xqueryEnds">xqueryEnds</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$newFnLevel</span><span class="whitespace"> </span><span class="op">lt</span><span class="whitespace"> </span><span class="variable">$xq-stack-level</span><span class="z">"</span><span id="wx6945" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w6947"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?xmlStarts">xmlStarts</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-empty" class="solar"><span class="function">empty</span></a><span class="parenthesis">(</span><span class="variable">$awaiting</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}tagStart" class="solar"><span class="function">f:tagStart</span></a><span class="parenthesis">(</span><span class="variable">$char</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$nChar</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx6980" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="z">&lt;!--</span><span class="cm">        &lt;xsl:variable name="test-string" select="codepoints-to-string(subsequence($chars, $index + 1, 10))"/&gt;</span><span class="z">--&gt;</span><span class="txt">
    
    </span><span class="ww" id="w6986"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?final-result">final-result</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$result</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$result1</span><span class="z">"</span><span id="wx7009" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w7011"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w7015"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">ge</span><span class="whitespace"> </span><span class="variable">$charCount</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w7029"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-exists" class="solar"><span class="function">exists</span></a><span class="parenthesis">(</span><span class="variable">$awaiting</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function">not</span></a><span class="parenthesis">(</span><span class="variable">$isFound</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w7049"><span class="es">&lt;</span><span class="enxsl">xsl:element</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#v?cColon" class="solar"><span class="variable">$cColon</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cBracketEnd" class="solar"><span class="variable">$cBracketEnd</span></a><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">comment</span><span class="op">'</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">literal</span><span class="op">'</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w7086"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function">not</span></a><span class="parenthesis">(</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#v?cColon" class="solar"><span class="variable">$cColon</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cBracketEnd" class="solar"><span class="variable">$cBracketEnd</span></a><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="ww" id="w7108"><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">type</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="z">"</span><span id="wx7122" class="sc">/&gt;</span></span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx7126" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ww" id="w7128"><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">start</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$start</span><span class="z">"</span><span id="wx7142" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:element</span><span id="wx7146" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx7150" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w7152"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?end">end</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w7168"><span class="es">&lt;</span><span class="en">terminate-xquery</span><span id="wx7170" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx7174" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w7176"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$final-result</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$end</span><span class="z">"</span><span id="wx7187" class="sc">/&gt;</span></span><span class="txt">
        
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx7191" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ww" id="w7193"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w7197"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w7201"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$xqueryEnds</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w7211"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?end">end</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()+</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="ww" id="w7227"><span class="es">&lt;</span><span class="en">unnested-xquery</span><span class="z"> </span><span class="atn">pos</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$index</span><span class="op">}</span><span class="z">"</span><span id="wx7237" class="sc">/&gt;</span></span><span class="txt">
              </span><span class="ww" id="w7239"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$nChar</span><span class="whitespace"> </span><span class="op">ne</span><span class="whitespace"> </span><span class="variable">$xAwaiting</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                </span><span class="ww" id="w7253"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?name">name</span><span class="z">"</span><span class="z">
                              </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$xAwaiting</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cTagStart" class="solar"><span class="variable">$cTagStart</span></a><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                                           </span><span class="op">'</span><span class="literal">resume-x-literal-txt</span><span class="op">'</span><span class="whitespace">
                                           </span><span class="op">else</span><span class="whitespace">
                                           </span><span class="op">'</span><span class="literal">resume-x-literal</span><span class="op">'</span><span class="z">"</span><span id="wx7287" class="sc">/&gt;</span></span><span class="txt">
                </span><span class="ww" id="w7289"><span class="es">&lt;</span><span class="enxsl">xsl:element</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$name</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                  </span><span class="ww" id="w7301"><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">pos</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="z">"</span><span id="wx7319" class="sc">/&gt;</span></span><span class="txt">
                </span><span class="ez">&lt;/</span><span class="clxsl">xsl:element</span><span id="wx7323" class="ec">&gt;</span></span><span class="txt">                            
              </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx7327" class="ec">&gt;</span></span><span class="txt">                           
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx7331" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ww" id="w7333"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?popped-xqstack">popped-xqstack</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer*</span><span class="z">"</span><span class="z">
                          </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-subsequence" class="solar"><span class="function">subsequence</span></a><span class="parenthesis">(</span><span class="variable">$xq-stack</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-count" class="solar"><span class="function">count</span></a><span class="parenthesis">(</span><span class="variable">$xq-stack</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx7369" class="sc">/&gt;</span></span><span class="txt">
            </span><span class="ww" id="w7371"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}createXmlBlocks" class="solar"><span class="function">f:createXmlBlocks</span></a><span class="parenthesis">(</span><span class="variable">$chars</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$xAwaiting</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$index</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$xLevel</span><span class="op">,</span><span class="whitespace">
                                  </span><span class="variable">$newFnLevel</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$xml-stack</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$popped-xqstack</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$final-result</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$end</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx7415" class="sc">/&gt;</span></span><span class="txt">                       
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx7419" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ww" id="w7421"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$xmlStarts</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w7431"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?end">end</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="ww" id="w7447"><span class="es">&lt;</span><span class="en">xml-constructor</span><span class="z"> </span><span class="atn">pos</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$index</span><span class="op">}</span><span class="z">"</span><span id="wx7457" class="sc">/&gt;</span></span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx7461" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ww" id="w7463"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}createXmlBlocks" class="solar"><span class="function">f:createXmlBlocks</span></a><span class="parenthesis">(</span><span class="variable">$chars</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$index</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$xLevel</span><span class="op">,</span><span class="whitespace">
                                  </span><span class="variable">$newFnLevel</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$xml-stack</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$xLevel</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$xq-stack</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$final-result</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx7514" class="sc">/&gt;</span></span><span class="txt">                       
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx7518" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ww" id="w7520"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w7524"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}createXqBlocks" class="solar"><span class="function">f:createXqBlocks</span></a><span class="parenthesis">(</span><span class="variable">$chars</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$nowSkip</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$nowAwaiting</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$newStart</span><span class="op">,</span><span class="whitespace"> 
                                  </span><span class="variable">$newLevel</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$newFnLevel</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$xLevel</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$xAwaiting</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$xml-stack</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$xq-stack</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$final-result</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx7572" class="sc">/&gt;</span></span><span class="txt">                           
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx7576" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx7580" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx7584" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx7588" class="ec">&gt;</span></span><span class="txt">
    
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx7592" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="z">&lt;!--</span><span class="cm"> suffixed with label and length of start char sequence eg. tags: cdata start, comment start pi start </span><span class="z">--&gt;</span><span class="txt">
  
  </span><span class="ww" id="w7598"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{urn:xq.internal-function}getAwaitingFrom2ndChar">f:getAwaitingFrom2ndChar</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">item()+</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w7614"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?char">char</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx7628" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w7630"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?char2">char2</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer?</span><span class="z">"</span><span id="wx7644" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w7646"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?xExclam" class="solar"><span class="variable">$xExclam</span></a><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                          </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$char2</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cParenStart" class="solar"><span class="variable">$cParenStart</span></a><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                          </span><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#v?cParenEnd" class="solar"><span class="variable">$cParenEnd</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cParenEnd" class="solar"><span class="variable">$cParenEnd</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cTagEnd" class="solar"><span class="variable">$cTagEnd</span></a><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">x-cdata</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">9</span><span class="parenthesis">)</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$char2</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?xHyphen" class="solar"><span class="variable">$xHyphen</span></a><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                          </span><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#v?xHyphen" class="solar"><span class="variable">$xHyphen</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?xHyphen" class="solar"><span class="variable">$xHyphen</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cTagEnd" class="solar"><span class="variable">$cTagEnd</span></a><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">x-comment</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">4</span><span class="parenthesis">)</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace">
                          </span><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#v?cParenEnd" class="solar"><span class="variable">$cParenEnd</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cTagEnd" class="solar"><span class="variable">$cTagEnd</span></a><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">x-dtd</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">2</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="comment">(: not supported in XQuery anyway :)</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$char</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?xPI" class="solar"><span class="variable">$xPI</span></a><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                          </span><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#v?xPI" class="solar"><span class="variable">$xPI</span></a><span class="op">,</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cTagEnd" class="solar"><span class="variable">$cTagEnd</span></a><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">x-pi</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">2</span><span class="parenthesis">)</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace">
                          </span><span class="parenthesis">(</span><a href="xq-spectrum.xsl.html#v?xxInitTagEnd" class="solar"><span class="variable">$xxInitTagEnd</span></a><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">x-tag</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx7788" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx7792" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w7794"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{urn:xq.internal-function}tagStart">f:tagStart</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w7810"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?char1">char1</span><span class="z">"</span><span id="wx7824" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w7826"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?char2">char2</span><span class="z">"</span><span id="wx7840" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w7842"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$char1</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xq-spectrum.xsl.html#v?cTagStart" class="solar"><span class="variable">$cTagStart</span></a><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$char2</span><span class="whitespace"> </span><span class="op">gt</span><span class="whitespace"> </span><span class="numeric">64</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace"> </span><span class="variable">$char2</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="numeric">33</span><span class="whitespace"> </span><span class="op">or</span><span class="whitespace"> </span><span class="variable">$char2</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="numeric">63</span><span class="parenthesis">)</span><span class="whitespace"> 
                          </span><span class="op">and</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function">not</span></a><span class="parenthesis">(</span><span class="variable">$char2</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="numeric">91</span><span class="op">,</span><span class="numeric">92</span><span class="op">,</span><span class="numeric">93</span><span class="op">,</span><span class="numeric">94</span><span class="op">,</span><span class="numeric">96</span><span class="op">,</span><span class="numeric">123</span><span class="op">,</span><span class="numeric">124</span><span class="op">,</span><span class="numeric">125</span><span class="op">,</span><span class="numeric">126</span><span class="op">,</span><span class="numeric">127</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx7911" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx7915" class="ec">&gt;</span></span><span class="txt">
</span><span class="ez">&lt;/</span><span class="clxsl">xsl:stylesheet</span><span id="wx7919" class="ec">&gt;</span></span><span class="txt">
</span></pre></div></body></html>