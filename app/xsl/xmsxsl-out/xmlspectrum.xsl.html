<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title>xmlspectrum.xsl</title><link rel="stylesheet" type="text/css" href="theme.css"></link></head><body><div><pre class="spectrum"><span class="z">&lt;?</span><span class="pi">xml version="1.0" encoding="utf-8"</span><span class="z">?&gt;</span><span class="txt">
</span><span class="z">&lt;!--</span><span class="cm">
     XMLSpectrum by Phil Fearon Qutoric Limited 2012 (c)
     http://qutoric.com
     License: Apache 2.0 http://www.apache.org/licenses/LICENSE-2.0.html
     
     Purpose: Syntax highlighter for XPath (text), XML, XSLT and XSD 1.1 file formats
     
     Interface Functions:
     ====================
     f:render(xml-content, is-xml, root-prefix)
     loc:showXPath(text-content)
     f:get-css(color-theme)
     f:indent(spans, char-width)
     f:link(spans, paths, location)
     
     Interface Templates:
     ====================
     &lt;xsl:template match="span" mode="markup"&gt;
     
     Global Variables (for overriding)
     =================================
     w3c-xpath-functions-uri: location of resource proxy
     font-name:               abbreviated font name [std|scp] default
                              is std for standard monospace - override
                              with 'scp' for 'Souce Code Pro'
                              font-family
     
</span><span class="z">--&gt;</span><span class="txt">

</span><span class="ww" id="w9"><span class="es">&lt;</span><a class="solar" href="index.html"><span class="enxsl" id="e?{http://www.w3.org/1999/XSL/Transform}stylesheet">xsl:stylesheet</span></a><span class="z"> </span><span class="atn">version</span><span class="atneq">=</span><span class="z">"</span><span class="av">2.0</span><span class="z">"</span><span class="z">
                </span><span class="atn">xmlns:xsl</span><span class="atneq">=</span><span class="z">"</span><span class="av">http://www.w3.org/1999/XSL/Transform</span><span class="z">"</span><span class="z">
                </span><span class="atn">xmlns:xs</span><span class="atneq">=</span><span class="z">"</span><span class="av">http://www.w3.org/2001/XMLSchema</span><span class="z">"</span><span class="z">
                </span><span class="atn">xmlns:loc</span><span class="atneq">=</span><span class="z">"</span><span class="av">com.qutoric.sketchpath.functions</span><span class="z">"</span><span class="z">
                </span><span class="atn">xmlns:css</span><span class="atneq">=</span><span class="z">"</span><span class="av">css-defs.com</span><span class="z">"</span><span class="z">
                </span><span class="atn">xmlns:dt</span><span class="atneq">=</span><span class="z">"</span><span class="av">http://qutoric.com.xmlspectrum.document-types</span><span class="z">"</span><span class="z">
                </span><span class="atn">exclude-result-prefixes</span><span class="atneq">=</span><span class="z">"</span><span class="av">loc f xs css c qf dt</span><span class="z">"</span><span class="z">
                </span><span class="atn">xmlns:c</span><span class="atneq">=</span><span class="z">"</span><span class="av">http://xmlspectrum.colors.org</span><span class="z">"</span><span class="z">
                </span><span class="atn">xmlns</span><span class="atneq">=</span><span class="z">"</span><span class="av">http://www.w3.org/1999/xhtml</span><span class="z">"</span><span class="z">
                </span><span class="atn">xpath-default-namespace</span><span class="atneq">=</span><span class="z">"</span><span class="av">http://www.w3.org/1999/xhtml</span><span class="z">"</span><span class="z">
                </span><span class="atn">xmlns:qf</span><span class="atneq">=</span><span class="z">"</span><span class="av">urn:xq.internal-function</span><span class="z">"</span><span class="z">
                </span><span class="atn">xmlns:f</span><span class="atneq">=</span><span class="z">"</span><span class="av">internal</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
  
  </span><span class="ww" id="w85"><span class="es">&lt;</span><span class="enxsl">xsl:include</span><span class="z"> </span><span class="atn">href</span><span class="atneq">=</span><span class="z">"</span><a href="doctype-functions.xsl.html" class="solar"><span class="href">doctype-functions.xsl</span></a><span class="z">"</span><span id="wx93" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w95"><span class="es">&lt;</span><span class="enxsl">xsl:include</span><span class="z"> </span><span class="atn">href</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html" class="solar"><span class="href">xq-spectrum.xsl</span></a><span class="z">"</span><span id="wx103" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w105"><span class="es">&lt;</span><span class="enxsl">xsl:include</span><span class="z"> </span><span class="atn">href</span><span class="atneq">=</span><span class="z">"</span><a href="xslt-formatting-functions.xsl.html" class="solar"><span class="href">xslt-formatting-functions.xsl</span></a><span class="z">"</span><span id="wx113" class="sc">/&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w115"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?color-theme">color-theme</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">dark</span><span class="op">'</span><span class="z">"</span><span id="wx131" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w133"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?force-newline">force-newline</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">no</span><span class="op">'</span><span class="z">"</span><span id="wx149" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w151"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?format-mixed-content">format-mixed-content</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">no</span><span class="op">'</span><span class="z">"</span><span id="wx167" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w169"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?ignore-mc">ignore-mc</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="highlight-file.xsl.html#p?format-mixed-content" class="solar"><span class="variable">$format-mixed-content</span></a><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">yes</span><span class="op">'</span><span class="z">"</span><span id="wx195" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w197"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?insert-newlines">insert-newlines</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#p?force-newline" class="solar"><span class="variable">$force-newline</span></a><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">yes</span><span class="op">'</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span id="wx223" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w225"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?max-newline-length">max-newline-length</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">80</span><span class="z">"</span><span id="wx245" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w247"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?resolved-theme">resolved-theme</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="z">
                </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="highlight-file.xsl.html#p?color-theme" class="solar"><span class="variable">$color-theme</span></a><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">light</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">solarized-light</span><span class="op">'</span><span class="whitespace">
                        </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="highlight-file.xsl.html#p?color-theme" class="solar"><span class="variable">$color-theme</span></a><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">dark</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">solarized-dark</span><span class="op">'</span><span class="whitespace">
                        </span><span class="op">else</span><span class="whitespace"> </span><a href="highlight-file.xsl.html#p?color-theme" class="solar"><span class="variable">$color-theme</span></a><span class="z">"</span><span id="wx307" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="z">&lt;!--</span><span class="cm"> override these variables </span><span class="z">--&gt;</span><span class="txt">
  </span><span class="ww" id="w313"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?w3c-xpath-functions-uri">w3c-xpath-functions-uri</span><span class="z">"</span><span class="z">
                </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">http://www.w3.org/TR/xpath-functions/</span><span class="op">'</span><span class="z">"</span><span id="wx329" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w331"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?font-name">font-name</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">std</span><span class="op">'</span><span class="z">"</span><span id="wx347" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w349"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?theme-doc-uri">theme-doc-uri</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">data/color-themes.xml</span><span class="op">'</span><span class="z">"</span><span id="wx365" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w367"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?css-inline">css-inline</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">no</span><span class="op">'</span><span class="z">"</span><span id="wx383" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w385"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?css-doc">css-doc</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-doc" class="solar"><span class="function">doc</span></a><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-resolve-uri" class="solar"><span class="function">resolve-uri</span></a><span class="parenthesis">(</span><a href="xmlspectrum.xsl.html#v?theme-doc-uri" class="solar"><span class="variable">$theme-doc-uri</span></a><span class="op">,</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-static-base-uri" class="solar"><span class="function">static-base-uri</span></a><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx410" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w412"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?color-theme-data">color-theme-data</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element(c:theme)</span><span class="z">"</span><span class="z">
                </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#v?css-doc" class="solar"><span class="variable">$css-doc</span></a><span class="step">/</span><span class="qname">c:themes</span><span class="step">/</span><span class="qname">c:theme</span><span class="filter">[</span><span class="axis">@</span><span class="qname">name</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><a href="xmlspectrum.xsl.html#f?{internal}get-theme" class="solar"><span class="function">f:get-theme</span></a><span class="parenthesis">(</span><a href="xmlspectrum.xsl.html#v?resolved-theme" class="solar"><span class="variable">$resolved-theme</span></a><span class="parenthesis">)</span><span class="filter">]</span><span class="z">"</span><span id="wx447" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w449"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?color-modes">color-modes</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element(colors)*</span><span class="z">"</span><span class="z">
                </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#f?{internal}get-inline-colors" class="solar"><span class="function">f:get-inline-colors</span></a><span class="parenthesis">(</span><a href="xmlspectrum.xsl.html#v?color-theme-data" class="solar"><span class="variable">$color-theme-data</span></a><span class="parenthesis">)</span><span class="z">"</span><span id="wx472" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ww" id="w474"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?document-type">document-type</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="z">"</span><span id="wx490" class="sc">/&gt;</span></span><span class="txt">
  
  
  </span><span class="z">&lt;!--</span><span class="cm">
       signature:
           f:render(xml-content, is-xml, root-prefix)
       
       description:
           Converts the xml content string to a sequence of span elements. with each
           containing a class attribute used for coloring with CSS. 
       
       params:
           xml-content: string containing well-balanced XML extract - namespace and prefix
                        declarations not required
           is-xsl:      boolean specifying whether coloring is for XSLT, if this is false
                        then XSD 1.1 coloring scheme is used instead
           root-prefix: string prefix used for elements requiring special coloring for XSLT
                        or XSD 1.1 - often 'xsl' and 'xs' respectively
  </span><span class="z">--&gt;</span><span class="txt">
  
  </span><span class="ww" id="w496"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{internal}render">f:render</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w506"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?xmlText">xmlText</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span id="wx520" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w522"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?doctype">doctype</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span id="wx536" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w538"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?root-prefix-a">root-prefix-a</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span id="wx552" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w554"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?root-prefix">root-prefix</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$root-prefix-a</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> 
                          </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-concat" class="solar"><span class="function">concat</span></a><span class="parenthesis">(</span><span class="variable">$root-prefix-a</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">:</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx602" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w604"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?tokens-a">tokens-a</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-tokenize" class="solar"><span class="function">tokenize</span></a><span class="parenthesis">(</span><span class="variable">$xmlText</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">&amp;lt;</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx632" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w634"><span class="es">&lt;</span><span class="enxsl">xsl:message</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w638"><span class="es">&lt;</span><span class="enxsl">xsl:text</span><span class="scx">&gt;</span><span class="txt">document-type: </span><span class="ez">&lt;/</span><span class="clxsl">xsl:text</span><span id="wx644" class="ec">&gt;</span></span><span class="txt"></span><span class="ww" id="w646"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$doctype</span><span class="z">"</span><span id="wx654" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ww" id="w656"><span class="es">&lt;</span><span class="enxsl">xsl:text</span><span class="scx">&gt;</span><span class="txt"> rendering </span><span class="ez">&lt;/</span><span class="clxsl">xsl:text</span><span id="wx662" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ww" id="w664"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-concat" class="solar"><span class="function">concat</span></a><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-string" class="solar"><span class="function">string</span></a><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-count" class="solar"><span class="function">count</span></a><span class="parenthesis">(</span><span class="variable">$tokens-a</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="op">,</span><span class="op">'</span><span class="literal"> </span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx685" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ww" id="w687"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$doctype</span><span class="z">"</span><span id="wx695" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ww" id="w697"><span class="es">&lt;</span><span class="enxsl">xsl:text</span><span class="scx">&gt;</span><span class="txt"> tokens ...</span><span class="ez">&lt;/</span><span class="clxsl">xsl:text</span><span id="wx703" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:message</span><span id="wx707" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ww" id="w709"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?tokens">tokens</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-normalize-space" class="solar"><span class="function">normalize-space</span></a><span class="parenthesis">(</span><span class="variable">$tokens-a</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-subsequence" class="solar"><span class="function">subsequence</span></a><span class="parenthesis">(</span><span class="variable">$tokens-a</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">2</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$tokens-a</span><span class="z">"</span><span id="wx753" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w755"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?spans">spans</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w771"><span class="es">&lt;</span><span class="enxsl">xsl:call-template</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#t?iterateTokens" class="solar"><span class="tcall">iterateTokens</span></a><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w781"><span class="es">&lt;</span><span class="enxsl">xsl:with-param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">counter</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">0</span><span class="z">"</span><span id="wx801" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ww" id="w803"><span class="es">&lt;</span><span class="enxsl">xsl:with-param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">tokens</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$tokens</span><span class="z">"</span><span id="wx823" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ww" id="w825"><span class="es">&lt;</span><span class="enxsl">xsl:with-param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">index</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">1</span><span class="z">"</span><span id="wx845" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ww" id="w847"><span class="es">&lt;</span><span class="enxsl">xsl:with-param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">expected</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">n</span><span class="op">'</span><span class="z">"</span><span id="wx869" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ww" id="w871"><span class="es">&lt;</span><span class="enxsl">xsl:with-param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">beganAt</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">0</span><span class="z">"</span><span id="wx891" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ww" id="w893"><span class="es">&lt;</span><span class="enxsl">xsl:with-param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">level</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">0</span><span class="z">"</span><span id="wx913" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ww" id="w915"><span class="es">&lt;</span><span class="enxsl">xsl:with-param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">doctype</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$doctype</span><span class="z">"</span><span id="wx935" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ww" id="w937"><span class="es">&lt;</span><span class="enxsl">xsl:with-param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">root-prefix</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$root-prefix</span><span class="z">"</span><span id="wx957" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ww" id="w959"><span class="es">&lt;</span><span class="enxsl">xsl:with-param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">expand-text-stack</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean*</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-false" class="solar"><span class="function">false</span></a><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx981" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:call-template</span><span id="wx985" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx989" class="ec">&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w991"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w995"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="highlight-file.xsl.html#p?css-inline" class="solar"><span class="variable">$css-inline</span></a><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">no</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w1011"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$spans</span><span class="z">"</span><span id="wx1019" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx1023" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ww" id="w1025"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w1029"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#f?{internal}style-spans" class="solar"><span class="function">f:style-spans</span></a><span class="parenthesis">(</span><span class="variable">$spans</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx1040" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx1044" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx1048" class="ec">&gt;</span></span><span class="txt">
    
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx1052" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="z">&lt;!--</span><span class="cm">
       XSLT function signature: 
           f:get-css()
       
       description:
       
           Generates a CSS file used to colorise span elements generates by the previous 2 functions
           The colors generated depend on the theme specified with the color-theme
           parameter. The color theme uses the 'Solarized' color points specified at: http://ethanschoonover.com/solarized
       
       params:
           color-theme: xs:string - name of color theme to use 
       
  </span><span class="z">--&gt;</span><span class="txt">
  </span><span class="ww" id="w1058"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{internal}get-theme">f:get-theme</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w1068"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?input-theme">input-theme</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span id="wx1082" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w1084"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$input-theme</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">light</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">solarized-light</span><span class="op">'</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$input-theme</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">dark</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">solarized-dark</span><span class="op">'</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$input-theme</span><span class="z">"</span><span id="wx1132" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx1136" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w1138"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{internal}get-css">f:get-css</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w1148"><span class="es">&lt;</span><span class="enxsl">xsl:apply-templates</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#v?css-doc" class="solar"><span class="variable">$css-doc</span></a><span class="step">/</span><span class="qname">c:themes</span><span class="step">/</span><span class="qname">css:boiler-plate</span><span class="z">"</span><span class="z"> </span><span class="atn">mode</span><span class="atneq">=</span><span class="z">"</span><span class="av">css</span><span class="z">"</span><span id="wx1166" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx1170" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w1172"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{internal}get-css-font">f:get-css-font</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w1182"><span class="es">&lt;</span><span class="enxsl">xsl:apply-templates</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#v?css-doc" class="solar"><span class="variable">$css-doc</span></a><span class="step">/</span><span class="qname">c:themes</span><span class="step">/</span><span class="qname">css:boiler-plate</span><span class="step">/</span><span class="qname">css:font</span><span class="z">"</span><span class="z"> </span><span class="atn">mode</span><span class="atneq">=</span><span class="z">"</span><span class="av">css</span><span class="z">"</span><span id="wx1202" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx1206" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w1208"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{internal}inline-css-main">f:inline-css-main</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w1224"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?css-text">css-text</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w1240"><span class="es">&lt;</span><span class="enxsl">xsl:apply-templates</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#v?css-doc" class="solar"><span class="variable">$css-doc</span></a><span class="step">/</span><span class="qname">c:themes</span><span class="step">/</span><span class="qname">css:boiler-plate</span><span class="step">/</span><span class="qname">css:main</span><span class="z">"</span><span class="z"> </span><span class="atn">mode</span><span class="atneq">=</span><span class="z">"</span><span class="av">css</span><span class="z">"</span><span id="wx1260" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx1264" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ww" id="w1266"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-string-join" class="solar"><span class="function">string-join</span></a><span class="parenthesis">(</span><span class="variable">$css-text</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx1282" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx1286" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w1288"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{internal}inline-css-toc">f:inline-css-toc</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w1304"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?css-text">css-text</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w1320"><span class="es">&lt;</span><span class="enxsl">xsl:apply-templates</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#v?css-doc" class="solar"><span class="variable">$css-doc</span></a><span class="step">/</span><span class="qname">c:themes</span><span class="step">/</span><span class="qname">css:boiler-plate</span><span class="step">/</span><span class="qname">css:toc</span><span class="z">"</span><span class="z"> </span><span class="atn">mode</span><span class="atneq">=</span><span class="z">"</span><span class="av">css</span><span class="z">"</span><span id="wx1340" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx1344" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ww" id="w1346"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-string-join" class="solar"><span class="function">string-join</span></a><span class="parenthesis">(</span><span class="variable">$css-text</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx1362" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx1366" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w1368"><span class="es">&lt;</span><span class="enxsl">xsl:template</span><span class="z"> </span><span class="atn">match</span><span class="atneq">=</span><span class="z">"</span><span class="qname">css:font</span><span class="z">"</span><span class="z"> </span><span class="atn">mode</span><span class="atneq">=</span><span class="z">"</span><span class="av">css</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w1384"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="highlight-file.xsl.html#p?font-name" class="solar"><span class="variable">$font-name</span></a><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">scp</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="axis">@</span><span class="qname">scp</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="z">"</span><span id="wx1413" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:template</span><span id="wx1417" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w1419"><span class="es">&lt;</span><span class="enxsl">xsl:template</span><span class="z"> </span><span class="atn">match</span><span class="atneq">=</span><span class="z">"</span><span class="qname">css:map</span><span class="z">"</span><span class="z"> </span><span class="atn">mode</span><span class="atneq">=</span><span class="z">"</span><span class="av">css</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w1435"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?element">element</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="axis">@</span><span class="qname">element</span><span class="z">"</span><span id="wx1450" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w1452"><span class="es">&lt;</span><span class="enxsl">xsl:for-each</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#v?color-theme-data" class="solar"><span class="variable">$color-theme-data</span></a><span class="step">/</span><span class="qname">c:color</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w1464"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?color">color</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="axis">@</span><span class="qname">name</span><span class="z">"</span><span id="wx1479" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ww" id="w1481"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?color-value">color-value</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="axis">@</span><span class="qname">value</span><span class="z">"</span><span id="wx1496" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ww" id="w1498"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?color-selectors">color-selectors</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element(c:color)</span><span class="z">"</span><span class="z">
                    </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#v?color-theme-data" class="solar"><span class="variable">$color-theme-data</span></a><span class="step">/</span><span class="context">..</span><span class="step">/</span><span class="qname">c:color-map</span><span class="step">/</span><span class="qname">c:color</span><span class="filter">[</span><span class="axis">@</span><span class="qname">name</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="variable">$color</span><span class="filter">]</span><span class="z">"</span><span id="wx1532" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ww" id="w1534"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?css-prop">css-prop</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="parenthesis">(</span><span class="variable">$color-selectors</span><span class="step">/</span><span class="axis">@</span><span class="qname">property</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">color</span><span class="op">'</span><span class="parenthesis">)</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="z">"</span><span id="wx1561" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ww" id="w1563"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?selectors">selectors</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-normalize-space" class="solar"><span class="function">normalize-space</span></a><span class="parenthesis">(</span><span class="variable">$color-selectors</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx1580" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ww" id="w1582"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?selector-tokens">selector-tokens</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-tokenize" class="solar"><span class="function">tokenize</span></a><span class="parenthesis">(</span><span class="variable">$selectors</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">\s</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string+</span><span class="z">"</span><span id="wx1610" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ww" id="w1612"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?qselector-tokens">qselector-tokens</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$s</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="variable">$selector-tokens</span><span class="whitespace"> </span><span class="op">return</span><span class="whitespace">
                                                    </span><a href="http://www.w3.org/TR/xpath-functions/#func-concat" class="solar"><span class="function">concat</span></a><span class="parenthesis">(</span><span class="variable">$element</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">.</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$s</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx1647" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ww" id="w1649"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?selector-string">selector-string</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-string-join" class="solar"><span class="function">string-join</span></a><span class="parenthesis">(</span><span class="variable">$qselector-tokens</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">, </span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx1671" class="sc">/&gt;</span></span><span class="txt">
      
      </span><span class="ww" id="w1673"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-concat" class="solar"><span class="function">concat</span></a><span class="parenthesis">(</span><span class="whitespace">
                            </span><span class="variable">$selector-string</span><span class="op">,</span><span class="whitespace">
                            </span><span class="op">'</span><span class="literal"> {</span><span class="op">'</span><span class="op">,</span><span class="whitespace">
                            </span><span class="variable">$css-prop</span><span class="op">,</span><span class="whitespace">
                            </span><span class="op">'</span><span class="literal">: #</span><span class="op">'</span><span class="op">,</span><span class="whitespace">
                            </span><span class="variable">$color-value</span><span class="op">,</span><span class="whitespace">
                            </span><span class="op">'</span><span class="literal">; }</span><span class="op">'</span><span class="whitespace">
                            </span><span class="parenthesis">)</span><span class="z">"</span><span id="wx1707" class="sc">/&gt;</span></span><span class="txt">
      
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:for-each</span><span id="wx1711" class="ec">&gt;</span></span><span class="txt">
    
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:template</span><span id="wx1715" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="z">&lt;!--</span><span class="cm">
       Sample output:
       &lt;colors&gt;
       &lt;color name="yellow" value="b58900" property="background-color"&gt;
       &lt;class&gt;yellow&lt;/class&gt;
       &lt;class&gt;op&lt;/class&gt;
       &lt;class&gt;type-op&lt;/class&gt;
       &lt;/color&gt;
       ...
       &lt;/colors&gt;
       
  </span><span class="z">--&gt;</span><span class="txt">
  </span><span class="ww" id="w1721"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{internal}get-inline-colors">f:get-inline-colors</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element(colors)+</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w1737"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?theme">theme</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element(c:theme)</span><span class="z">"</span><span id="wx1751" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w1753"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?color-map">color-map</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$theme</span><span class="step">/</span><span class="context">..</span><span class="step">/</span><span class="qname">c:color-map</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element(c:color-map)</span><span class="z">"</span><span id="wx1777" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w1779"><span class="es">&lt;</span><span class="en">colors</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w1783"><span class="es">&lt;</span><span class="enxsl">xsl:for-each</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$theme</span><span class="step">/</span><span class="qname">c:color</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w1795"><span class="es">&lt;</span><span class="en">color</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w1799"><span class="es">&lt;</span><span class="enxsl">xsl:copy-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="axis">@</span><span class="op">*</span><span class="z">"</span><span id="wx1808" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w1810"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?color-key">color-key</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="axis">@</span><span class="qname">name</span><span class="z">"</span><span id="wx1825" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w1827"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?color">color</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element(c:color)</span><span class="z">"</span><span class="z">
                        </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$color-map</span><span class="step">/</span><span class="qname">c:color</span><span class="filter">[</span><span class="axis">@</span><span class="qname">name</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="variable">$color-key</span><span class="filter">]</span><span class="z">"</span><span id="wx1857" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w1859"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$color</span><span class="step">/</span><span class="axis">@</span><span class="qname">property</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w1872"><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">property</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$color</span><span class="step">/</span><span class="axis">@</span><span class="qname">property</span><span class="z">"</span><span id="wx1889" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx1893" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ww" id="w1895"><span class="es">&lt;</span><span class="enxsl">xsl:for-each</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-tokenize" class="solar"><span class="function">tokenize</span></a><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-normalize-space" class="solar"><span class="function">normalize-space</span></a><span class="parenthesis">(</span><span class="variable">$color</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">\s+</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w1916"><span class="es">&lt;</span><span class="en">class</span><span class="scx">&gt;</span><span class="txt"></span><span class="ww" id="w1920"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="context">.</span><span class="z">"</span><span id="wx1928" class="sc">/&gt;</span></span><span class="txt"></span><span class="ez">&lt;/</span><span class="cl">class</span><span id="wx1932" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:for-each</span><span id="wx1936" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="cl">color</span><span id="wx1940" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:for-each</span><span id="wx1944" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="cl">colors</span><span id="wx1948" class="ec">&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx1952" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w1954"><span class="es">&lt;</span><span class="enxsl">xsl:template</span><span class="z"> </span><span class="atn">match</span><span class="atneq">=</span><span class="z">"</span><span class="qname">css:color</span><span class="z">"</span><span class="z"> </span><span class="atn">mode</span><span class="atneq">=</span><span class="z">"</span><span class="av">css</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w1970"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?color">color</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="axis">@</span><span class="qname">name</span><span class="z">"</span><span id="wx1985" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w1987"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-concat" class="solar"><span class="function">concat</span></a><span class="parenthesis">(</span><span class="op">'</span><span class="literal">#</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><a href="xmlspectrum.xsl.html#v?color-theme-data" class="solar"><span class="variable">$color-theme-data</span></a><span class="step">/</span><span class="qname">c:color</span><span class="filter">[</span><span class="axis">@</span><span class="qname">name</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="variable">$color</span><span class="filter">]</span><span class="step">/</span><span class="axis">@</span><span class="qname">value</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx2016" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:template</span><span id="wx2020" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w2022"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{internal}getTagType">f:getTagType</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w2032"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?token">token</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string?</span><span class="z">"</span><span id="wx2046" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w2048"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?t">t</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$token</span><span class="z">"</span><span id="wx2062" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w2064"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?t1">t1</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-substring" class="solar"><span class="function">substring</span></a><span class="parenthesis">(</span><span class="variable">$t</span><span class="op">,</span><span class="numeric">1</span><span class="op">,</span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx2085" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w2087"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?t2">t2</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-substring" class="solar"><span class="function">substring</span></a><span class="parenthesis">(</span><span class="variable">$t</span><span class="op">,</span><span class="numeric">2</span><span class="op">,</span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx2108" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w2110"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w2114"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$t1</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">?</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt"></span><span class="ww" id="w2130"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">pi</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">?</span><span class="op">'</span><span class="z">"</span><span id="wx2144" class="sc">/&gt;</span></span><span class="txt"></span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx2148" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ww" id="w2150"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$t1</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">!</span><span class="op">'</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$t2</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">-</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt"></span><span class="ww" id="w2176"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">cm</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">!--</span><span class="op">'</span><span class="z">"</span><span id="wx2190" class="sc">/&gt;</span></span><span class="txt"></span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx2194" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ww" id="w2196"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$t1</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">!</span><span class="op">'</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$t2</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">[</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt"></span><span class="ww" id="w2222"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">cd</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">![CDATA[</span><span class="op">'</span><span class="z">"</span><span id="wx2236" class="sc">/&gt;</span></span><span class="txt"></span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx2240" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ww" id="w2242"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$t1</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">!</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt"></span><span class="ww" id="w2258"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">dt</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">!</span><span class="op">'</span><span class="z">"</span><span id="wx2272" class="sc">/&gt;</span></span><span class="txt"></span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx2276" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ww" id="w2278"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$t1</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">/</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w2294"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">cl</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">/</span><span class="op">'</span><span class="z">"</span><span id="wx2308" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx2312" class="ec">&gt;</span></span><span class="txt">
      </span><span class="z">&lt;!--</span><span class="cm"> open tag (may be  self-closing) </span><span class="z">--&gt;</span><span class="txt">
      </span><span class="ww" id="w2318"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt"></span><span class="ww" id="w2322"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">tg</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="z">"</span><span id="wx2336" class="sc">/&gt;</span></span><span class="txt"></span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx2340" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx2344" class="ec">&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx2348" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w2350"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{internal}expected-offset">f:expected-offset</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w2366"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?in">in</span><span class="z">"</span><span id="wx2374" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w2376"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$in</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">?&amp;gt;</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="numeric">2</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$in</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">--&amp;gt;</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="numeric">3</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$in</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">]]&gt;</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="numeric">9</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="numeric">1</span><span class="z">"</span><span id="wx2438" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx2442" class="ec">&gt;</span></span><span class="txt">

  </span><span class="ww" id="w2444"><span class="es">&lt;</span><span class="enxsl">xsl:template</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="tname" id="t?iterateTokens">iterateTokens</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w2460"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?counter">counter</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx2474" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w2476"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?tokens">tokens</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span id="wx2490" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w2492"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?index">index</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx2506" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w2508"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?expected">expected</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span id="wx2522" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w2524"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?beganAt">beganAt</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx2538" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w2540"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?level">level</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx2554" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w2556"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?doctype">doctype</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span id="wx2570" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w2572"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?root-prefix">root-prefix</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span id="wx2586" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w2588"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?expand-text-stack">expand-text-stack</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean*</span><span class="z">"</span><span id="wx2602" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w2604"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?is-xsl">is-xsl</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$doctype</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">xslt</span><span class="op">'</span><span class="z">"</span><span id="wx2630" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w2632"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?is-xsd">is-xsd</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function">not</span></a><span class="parenthesis">(</span><span class="variable">$is-xsl</span><span class="parenthesis">)</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span id="wx2655" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w2657"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?token">token</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$tokens</span><span class="filter">[</span><span class="variable">$index</span><span class="filter">]</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string?</span><span class="z">"</span><span id="wx2680" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w2682"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?prevToken">prevToken</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$tokens</span><span class="filter">[</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="filter">]</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string?</span><span class="z">"</span><span id="wx2709" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w2711"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?nextToken">nextToken</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$tokens</span><span class="filter">[</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">1</span><span class="filter">]</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string?</span><span class="z">"</span><span id="wx2738" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w2740"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?awaiting">awaiting</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$expected</span><span class="whitespace"> </span><span class="op">ne</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">n</span><span class="op">'</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span id="wx2766" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w2768"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?expand-text">expand-text</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean?</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$expand-text-stack</span><span class="filter">[</span><a href="http://www.w3.org/TR/xpath-functions/#func-last" class="solar"><span class="function">last</span></a><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="filter">]</span><span class="z">"</span><span id="wx2793" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="z">&lt;!--</span><span class="cm">
         &lt;trace&gt;
         token: &lt;xsl:value-of select="$token"/&gt;
         expected: &lt;xsl:value-of select="$expected"/&gt;
         index: &lt;xsl:value-of select="$index"/&gt;
         &lt;/trace&gt;
    </span><span class="z">--&gt;</span><span class="txt">
    
    </span><span class="ww" id="w2799"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?expectedOutput">expectedOutput</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w2815"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="z">&lt;!--</span><span class="cm">  looking to close an open ta
        g </span><span class="z">--&gt;</span><span class="txt">
        </span><span class="z">&lt;!--</span><span class="cm"> consider: &lt;!DOCTYPE person [&lt;!ELEMENT ... ]&gt; as well as reference only </span><span class="z">--&gt;</span><span class="txt">
        </span><span class="ww" id="w2833"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?beforeFind">beforeFind</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-substring-before" class="solar"><span class="function">substring-before</span></a><span class="parenthesis">(</span><span class="variable">$token</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$expected</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx2853" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ww" id="w2855"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?found">found</span><span class="z">"</span><span class="z">
                      </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-string-length" class="solar"><span class="function">string-length</span></a><span class="parenthesis">(</span><span class="variable">$beforeFind</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">gt</span><span class="whitespace"> </span><span class="numeric">0</span><span class="parenthesis">)</span><span class="whitespace">
                              </span><span class="op">then</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-true" class="solar"><span class="function">true</span></a><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace"> 
                              </span><span class="op">else</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-starts-with" class="solar"><span class="function">starts-with</span></a><span class="parenthesis">(</span><span class="variable">$beforeFind</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$expected</span><span class="parenthesis">)</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span id="wx2902" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ww" id="w2904"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$found</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w2914"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?offset">offset</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#f?{internal}expected-offset" class="solar"><span class="function">f:expected-offset</span></a><span class="parenthesis">(</span><span class="variable">$expected</span><span class="parenthesis">)</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx2937" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w2939"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?begin-token">begin-token</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$tokens</span><span class="filter">[</span><span class="variable">$beganAt</span><span class="filter">]</span><span class="z">"</span><span id="wx2956" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w2958"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="av">z</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w2968"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z">
                </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-concat" class="solar"><span class="function">concat</span></a><span class="parenthesis">(</span><span class="op">'</span><span class="literal">&amp;lt;</span><span class="op">'</span><span class="op">,</span><a href="http://www.w3.org/TR/xpath-functions/#func-substring" class="solar"><span class="function">substring</span></a><span class="parenthesis">(</span><span class="variable">$begin-token</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$offset</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx2992" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx2996" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ww" id="w2998"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?part-token">part-token</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-substring" class="solar"><span class="function">substring</span></a><span class="parenthesis">(</span><span class="variable">$begin-token</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$offset</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx3022" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w3024"><span class="es">&lt;</span><span class="en">span</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w3028"><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">class</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#f?{internal}getTagType" class="solar"><span class="function">f:getTagType</span></a><span class="parenthesis">(</span><span class="variable">$tokens</span><span class="filter">[</span><span class="variable">$beganAt</span><span class="filter">]</span><span class="parenthesis">)</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="z">"</span><span id="wx3051" class="sc">/&gt;</span></span><span class="txt">
            </span><span class="ww" id="w3053"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> 
                </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-string-join" class="solar"><span class="function">string-join</span></a><span class="parenthesis">(</span><span class="whitespace">
                        </span><span class="parenthesis">(</span><span class="variable">$part-token</span><span class="op">,</span><span class="whitespace">
                        </span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$x</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="variable">$beganAt</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace"> </span><span class="op">to</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$index</span><span class="whitespace"> </span><span class="numeric">-1</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">return</span><span class="whitespace">
                        </span><a href="http://www.w3.org/TR/xpath-functions/#func-concat" class="solar"><span class="function">concat</span></a><span class="parenthesis">(</span><span class="op">'</span><span class="literal">&amp;lt;</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$tokens</span><span class="filter">[</span><span class="variable">$x</span><span class="filter">]</span><span class="parenthesis">)</span><span class="op">,</span><span class="whitespace">
                        </span><span class="op">'</span><span class="literal">&amp;lt;</span><span class="op">'</span><span class="op">,</span><span class="variable">$beforeFind</span><span class="parenthesis">)</span><span class="whitespace">
                        </span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace">
                        </span><span class="z">"</span><span id="wx3117" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx3121" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ww" id="w3123"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="av">z</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt"></span><span class="ww" id="w3133"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$expected</span><span class="z">"</span><span id="wx3141" class="sc">/&gt;</span></span><span class="txt"></span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx3145" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ww" id="w3147"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?textNode">textNode</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-substring" class="solar"><span class="function">substring</span></a><span class="parenthesis">(</span><span class="variable">$token</span><span class="op">,</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-string-length" class="solar"><span class="function">string-length</span></a><span class="parenthesis">(</span><span class="variable">$beforeFind</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-string-length" class="solar"><span class="function">string-length</span></a><span class="parenthesis">(</span><span class="variable">$expected</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx3187" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w3189"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w3193"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$expand-text</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="ww" id="w3203"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}show-xsl-tvt" class="solar"><span class="function">qf:show-xsl-tvt</span></a><span class="parenthesis">(</span><span class="variable">$textNode</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx3214" class="sc">/&gt;</span></span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx3218" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ww" id="w3220"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="ww" id="w3224"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="av">txt</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                </span><span class="ww" id="w3234"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$textNode</span><span class="z">"</span><span id="wx3242" class="sc">/&gt;</span></span><span class="txt">
              </span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx3246" class="ec">&gt;</span></span><span class="txt">
              
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx3250" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx3254" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx3258" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx3262" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx3266" class="ec">&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w3268"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?char1">char1</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string?</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-substring" class="solar"><span class="function">substring</span></a><span class="parenthesis">(</span><span class="variable">$token</span><span class="op">,</span><span class="numeric">1</span><span class="op">,</span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx3295" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w3297"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?is-element-start">is-element-start</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function">not</span></a><span class="parenthesis">(</span><span class="variable">$awaiting</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function">not</span></a><span class="parenthesis">(</span><span class="variable">$char1</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">?</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">!</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">/</span><span class="op">'</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx3343" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w3345"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?is-root-element">is-root-element</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$counter</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="numeric">0</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$is-element-start</span><span class="z">"</span><span id="wx3373" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="z">&lt;!--</span><span class="cm"> if root-prefix not initially supplied, get this from the first element name </span><span class="z">--&gt;</span><span class="txt">
    </span><span class="ww" id="w3379"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?new-root-prefix">new-root-prefix</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$is-root-element</span><span class="parenthesis">)</span><span class="whitespace">
                          </span><span class="op">then</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$root-prefix</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace">
                          </span><span class="op">then</span><span class="whitespace">
                          </span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$x</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-tokenize" class="solar"><span class="function">tokenize</span></a><span class="parenthesis">(</span><span class="variable">$token</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">\s+</span><span class="op">'</span><span class="parenthesis">)</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="whitespace"> </span><span class="op">return</span><span class="whitespace"> 
                          </span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$s</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-substring-before" class="solar"><span class="function">substring-before</span></a><span class="parenthesis">(</span><span class="variable">$x</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">:</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">return</span><span class="whitespace">
                              </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$s</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-concat" class="solar"><span class="function">concat</span></a><span class="parenthesis">(</span><span class="variable">$s</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">:</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$root-prefix</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$root-prefix</span><span class="z">"</span><span id="wx3490" class="sc">/&gt;</span></span><span class="txt">
    
    
    </span><span class="z">&lt;!--</span><span class="cm"> return 2 strings if required close found - that befoe and that after (even if empty string)
         if no required close found - just return the required close</span><span class="z">--&gt;</span><span class="txt">
    
    </span><span class="ww" id="w3496"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?parseStrings">parseStrings</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w3512"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function">not</span></a><span class="parenthesis">(</span><span class="variable">$awaiting</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w3525"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?requiredClose">requiredClose</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w3541"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?char2">char2</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string?</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-substring" class="solar"><span class="function">substring</span></a><span class="parenthesis">(</span><span class="variable">$token</span><span class="op">,</span><span class="numeric">2</span><span class="op">,</span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx3568" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w3570"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w3574"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$char1</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">?</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">?&amp;gt;</span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx3592" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ww" id="w3594"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$char1</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">!</span><span class="op">'</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$char2</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">-</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">--&amp;gt;</span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx3622" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ww" id="w3624"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$char1</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">!</span><span class="op">'</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$char2</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">[</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">]]&amp;gt;</span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx3652" class="ec">&gt;</span></span><span class="txt"> </span><span class="z">&lt;!--</span><span class="cm"> assume cdata: &lt;![CDATA[]]&gt; </span><span class="z">--&gt;</span><span class="txt">
            </span><span class="ww" id="w3658"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$char1</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">!</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="ww" id="w3674"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-contains" class="solar"><span class="function">contains</span></a><span class="parenthesis">(</span><span class="variable">$token</span><span class="op">,</span><span class="op">'</span><span class="literal">[</span><span class="op">'</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">]&gt;</span><span class="op">'</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">&gt;</span><span class="op">'</span><span class="z">"</span><span id="wx3705" class="sc">/&gt;</span></span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx3709" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ww" id="w3711"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">&amp;gt;</span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx3717" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx3721" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx3725" class="ec">&gt;</span></span><span class="txt">
        
        </span><span class="ww" id="w3727"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?beforeClose">beforeClose</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-substring-before" class="solar"><span class="function">substring-before</span></a><span class="parenthesis">(</span><span class="variable">$token</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$requiredClose</span><span class="parenthesis">)</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span id="wx3753" class="sc">/&gt;</span></span><span class="txt">
        
        </span><span class="ww" id="w3755"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w3759"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-string-length" class="solar"><span class="function">string-length</span></a><span class="parenthesis">(</span><span class="variable">$token</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="numeric">0</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="z">&lt;!--</span><span class="cm">
                 &lt;x/&gt;
            </span><span class="z">--&gt;</span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx3782" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ww" id="w3784"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function">not</span></a><span class="parenthesis">(</span><span class="variable">$is-element-start</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="z">&lt;!--</span><span class="cm"> cdata, dtd, pi, comment, or close-tag </span><span class="z">--&gt;</span><span class="txt">
            </span><span class="ww" id="w3801"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?foundClose">foundClose</span><span class="z">"</span><span class="z">
                          </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-string-length" class="solar"><span class="function">string-length</span></a><span class="parenthesis">(</span><span class="variable">$beforeClose</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">gt</span><span class="whitespace"> </span><span class="numeric">0</span><span class="parenthesis">)</span><span class="whitespace">
                                  </span><span class="op">then</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-true" class="solar"><span class="function">true</span></a><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace"> 
                                  </span><span class="op">else</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-starts-with" class="solar"><span class="function">starts-with</span></a><span class="parenthesis">(</span><span class="variable">$beforeClose</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$requiredClose</span><span class="parenthesis">)</span><span class="z">"</span><span class="z">
                          </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span id="wx3848" class="sc">/&gt;</span></span><span class="txt">
            </span><span class="ww" id="w3850"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="ww" id="w3854"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$foundClose</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                </span><span class="ww" id="w3864"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?tagType">tagType</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#f?{internal}getTagType" class="solar"><span class="function">f:getTagType</span></a><span class="parenthesis">(</span><span class="variable">$token</span><span class="parenthesis">)</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string+</span><span class="z">"</span><span id="wx3887" class="sc">/&gt;</span></span><span class="txt">
                </span><span class="ww" id="w3889"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?tagStart">tagStart</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$tagType</span><span class="filter">[</span><span class="numeric">2</span><span class="filter">]</span><span class="z">"</span><span id="wx3906" class="sc">/&gt;</span></span><span class="txt">
                </span><span class="ww" id="w3908"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?isElementClose">isElementClose</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$char1</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">/</span><span class="op">'</span><span class="z">"</span><span id="wx3928" class="sc">/&gt;</span></span><span class="txt">
                
                </span><span class="ww" id="w3930"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$isElementClose</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">ez</span><span class="op">'</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">z</span><span class="op">'</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                  </span><span class="ww" id="w3958"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-concat" class="solar"><span class="function">concat</span></a><span class="parenthesis">(</span><span class="op">'</span><span class="literal">&amp;lt;</span><span class="op">'</span><span class="op">,</span><span class="variable">$tagStart</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx3973" class="sc">/&gt;</span></span><span class="txt"></span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx3977" class="ec">&gt;</span></span><span class="txt">
                </span><span class="ww" id="w3979"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?tagContent">tagContent</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-substring" class="solar"><span class="function">substring</span></a><span class="parenthesis">(</span><span class="variable">$beforeClose</span><span class="op">,</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-string-length" class="solar"><span class="function">string-length</span></a><span class="parenthesis">(</span><span class="variable">$tagStart</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx4006" class="sc">/&gt;</span></span><span class="txt">
                </span><span class="ww" id="w4008"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?with-prefix">with-prefix</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-starts-with" class="solar"><span class="function">starts-with</span></a><span class="parenthesis">(</span><span class="variable">$tagContent</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$root-prefix</span><span class="parenthesis">)</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span id="wx4034" class="sc">/&gt;</span></span><span class="txt">
                </span><span class="ww" id="w4036"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
                  </span><span class="ww" id="w4040"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isElementClose</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                    </span><span class="ww" id="w4050"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$is-xsl</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$with-prefix</span><span class="parenthesis">)</span><span class="whitespace">
                                 </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">clxsl</span><span class="op">'</span><span class="whitespace">
                                 </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$is-xsd</span><span class="whitespace">
                                 </span><span class="op">and</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$tagContent</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="doctype-functions.xsl.html#f?{internal}get-xsd-fnames" class="solar"><span class="function">f:get-xsd-fnames</span></a><span class="parenthesis">(</span><span class="variable">$root-prefix</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$doctype</span><span class="parenthesis">)</span><span class="step">/</span><span class="axis">@</span><span class="qname">name</span><span class="whitespace">
                                 </span><span class="op">or</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function">not</span></a><span class="parenthesis">(</span><span class="variable">$with-prefix</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> 
                                 </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">clxsl</span><span class="op">'</span><span class="whitespace">
                                 </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">cl</span><span class="op">'</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                      </span><span class="ww" id="w4122"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$tagContent</span><span class="z">"</span><span id="wx4130" class="sc">/&gt;</span></span><span class="txt">
                    </span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx4134" class="ec">&gt;</span></span><span class="txt">
                  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx4138" class="ec">&gt;</span></span><span class="txt">
                  </span><span class="ww" id="w4140"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
                    </span><span class="ww" id="w4144"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$tagType</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                      </span><span class="ww" id="w4159"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$tagContent</span><span class="z">"</span><span id="wx4167" class="sc">/&gt;</span></span><span class="txt">
                    </span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx4171" class="ec">&gt;</span></span><span class="txt">
                  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx4175" class="ec">&gt;</span></span><span class="txt">
                </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx4179" class="ec">&gt;</span></span><span class="txt">
                </span><span class="ww" id="w4181"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$isElementClose</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">ec</span><span class="op">'</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">z</span><span class="op">'</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                  </span><span class="ww" id="w4209"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isElementClose</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                    </span><span class="z">&lt;!--</span><span class="cm">
                         &lt;xsl:attribute name="id" select="js:stackPop()"/&gt;
                    </span><span class="z">--&gt;</span><span class="txt">
                  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx4225" class="ec">&gt;</span></span><span class="txt">
                  </span><span class="ww" id="w4227"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$requiredClose</span><span class="z">"</span><span id="wx4235" class="sc">/&gt;</span></span><span class="txt"></span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx4239" class="ec">&gt;</span></span><span class="txt">
                
                </span><span class="ww" id="w4241"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?textNode">textNode</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-substring" class="solar"><span class="function">substring</span></a><span class="parenthesis">(</span><span class="variable">$token</span><span class="op">,</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-string-length" class="solar"><span class="function">string-length</span></a><span class="parenthesis">(</span><span class="variable">$beforeClose</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-string-length" class="solar"><span class="function">string-length</span></a><span class="parenthesis">(</span><span class="variable">$requiredClose</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx4281" class="sc">/&gt;</span></span><span class="txt">
                </span><span class="ww" id="w4283"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
                  </span><span class="ww" id="w4287"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$expand-text</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                    </span><span class="ww" id="w4297"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}show-xsl-tvt" class="solar"><span class="function">qf:show-xsl-tvt</span></a><span class="parenthesis">(</span><span class="variable">$textNode</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx4308" class="sc">/&gt;</span></span><span class="txt">
                  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx4312" class="ec">&gt;</span></span><span class="txt">
                  </span><span class="ww" id="w4314"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
                    </span><span class="ww" id="w4318"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="av">txt</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                      </span><span class="ww" id="w4328"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$textNode</span><span class="z">"</span><span id="wx4336" class="sc">/&gt;</span></span><span class="txt">
                    </span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx4340" class="ec">&gt;</span></span><span class="txt">
                  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx4344" class="ec">&gt;</span></span><span class="txt">
                </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx4348" class="ec">&gt;</span></span><span class="txt">
              </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx4352" class="ec">&gt;</span></span><span class="txt">
              </span><span class="ww" id="w4354"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
                </span><span class="ww" id="w4358"><span class="es">&lt;</span><span class="en">required</span><span class="scx">&gt;</span><span class="txt">
                  </span><span class="ww" id="w4362"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$requiredClose</span><span class="z">"</span><span id="wx4370" class="sc">/&gt;</span></span><span class="txt">
                </span><span class="ez">&lt;/</span><span class="cl">required</span><span id="wx4374" class="ec">&gt;</span></span><span class="txt">
              </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx4378" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx4382" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx4386" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ww" id="w4388"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
            
            </span><span class="ww" id="w4392"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?parts">parts</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="ww" id="w4408"><span class="es">&lt;</span><span class="enxsl">xsl:analyze-string</span><span class="z"> </span><span class="atn">regex</span><span class="atneq">=</span><span class="z">"</span><span class="av">&amp;quot;.*?&amp;quot;|'.*?'|[^'&amp;quot;]+|['&amp;quot;]</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$token</span><span class="z">"</span><span class="z"> </span><span class="atn">flags</span><span class="atneq">=</span><span class="z">"</span><span class="av">s</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                </span><span class="ww" id="w4430"><span class="es">&lt;</span><span class="enxsl">xsl:matching-substring</span><span class="scx">&gt;</span><span class="txt">
                  </span><span class="ww" id="w4434"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="context">.</span><span class="z">"</span><span id="wx4442" class="sc">/&gt;</span></span><span class="txt">
                </span><span class="ez">&lt;/</span><span class="clxsl">xsl:matching-substring</span><span id="wx4446" class="ec">&gt;</span></span><span class="txt">
                </span><span class="ww" id="w4448"><span class="es">&lt;</span><span class="enxsl">xsl:non-matching-substring</span><span class="scx">&gt;</span><span class="txt">
                  </span><span class="ww" id="w4452"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="context">.</span><span class="z">"</span><span id="wx4460" class="sc">/&gt;</span></span><span class="txt">
                </span><span class="ez">&lt;/</span><span class="clxsl">xsl:non-matching-substring</span><span id="wx4464" class="ec">&gt;</span></span><span class="txt">
              </span><span class="ez">&lt;/</span><span class="clxsl">xsl:analyze-string</span><span id="wx4468" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx4472" class="ec">&gt;</span></span><span class="txt">
            
            </span><span class="ww" id="w4474"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#f?{internal}getAttributes" class="solar"><span class="function">f:getAttributes</span></a><span class="parenthesis">(</span><span class="variable">$token</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">0</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$parts</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$doctype</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$new-root-prefix</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$expand-text-stack</span><span class="filter">[</span><a href="http://www.w3.org/TR/xpath-functions/#func-last" class="solar"><span class="function">last</span></a><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="filter">]</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx4513" class="sc">/&gt;</span></span><span class="txt">
            
            </span><span class="z">&lt;!--</span><span class="cm"> must be an open tag, so check for attributes </span><span class="z">--&gt;</span><span class="txt">
            
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx4521" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx4525" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx4529" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx4533" class="ec">&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w4535"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?newLevel">newLevel</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="numeric">0</span><span class="z">"</span><span id="wx4555" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w4557"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?newCounter">newCounter</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$is-element-start</span><span class="parenthesis">)</span><span class="whitespace">
                                            </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$counter</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$counter</span><span class="z">"</span><span id="wx4587" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w4589"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?stillAwaiting">stillAwaiting</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$awaiting</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-empty" class="solar"><span class="function">empty</span></a><span class="parenthesis">(</span><span class="variable">$expectedOutput</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx4616" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w4618"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function">not</span></a><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-name" class="solar"><span class="function">name</span></a><span class="parenthesis">(</span><span class="variable">$parseStrings</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">required</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w4643"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$parseStrings</span><span class="z">"</span><span id="wx4651" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx4655" class="ec">&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w4657"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$expectedOutput</span><span class="z">"</span><span id="wx4665" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w4667"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?newExpected">newExpected</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                          </span><span class="op">'</span><span class="literal">n</span><span class="op">'</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$stillAwaiting</span><span class="parenthesis">)</span><span class="whitespace">
                          </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$expected</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-count" class="solar"><span class="function">count</span></a><span class="parenthesis">(</span><span class="variable">$parseStrings</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="whitespace">
                          </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$parseStrings</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">n</span><span class="op">'</span><span class="z">"</span><span id="wx4738" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w4740"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?newBeganAt">newBeganAt</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$stillAwaiting</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$beganAt</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$index</span><span class="z">"</span><span id="wx4772" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w4774"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">le</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-count" class="solar"><span class="function">count</span></a><span class="parenthesis">(</span><span class="variable">$tokens</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w4791"><span class="es">&lt;</span><span class="enxsl">xsl:call-template</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#t?iterateTokens" class="solar"><span class="tcall">iterateTokens</span></a><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w4801"><span class="es">&lt;</span><span class="enxsl">xsl:with-param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">counter</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$newCounter</span><span class="z">"</span><span id="wx4821" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ww" id="w4823"><span class="es">&lt;</span><span class="enxsl">xsl:with-param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">tokens</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$tokens</span><span class="z">"</span><span id="wx4843" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ww" id="w4845"><span class="es">&lt;</span><span class="enxsl">xsl:with-param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">index</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="z">"</span><span id="wx4869" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ww" id="w4871"><span class="es">&lt;</span><span class="enxsl">xsl:with-param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">expected</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$newExpected</span><span class="z">"</span><span id="wx4891" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ww" id="w4893"><span class="es">&lt;</span><span class="enxsl">xsl:with-param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">beganAt</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$newBeganAt</span><span class="z">"</span><span id="wx4913" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ww" id="w4915"><span class="es">&lt;</span><span class="enxsl">xsl:with-param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">level</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$newLevel</span><span class="z">"</span><span id="wx4935" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ww" id="w4937"><span class="es">&lt;</span><span class="enxsl">xsl:with-param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">doctype</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$doctype</span><span class="z">"</span><span id="wx4957" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ww" id="w4959"><span class="es">&lt;</span><span class="enxsl">xsl:with-param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">root-prefix</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$new-root-prefix</span><span class="z">"</span><span id="wx4979" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ww" id="w4981"><span class="es">&lt;</span><span class="enxsl">xsl:with-param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">expand-text-stack</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean*</span><span class="z">"</span><span class="z"> 
                        </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#f?{internal}getNewExpandStack" class="solar"><span class="function">f:getNewExpandStack</span></a><span class="parenthesis">(</span><span class="variable">$parseStrings</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$expand-text-stack</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx5007" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:call-template</span><span id="wx5011" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx5015" class="ec">&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:template</span><span id="wx5019" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w5021"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{internal}getNewExpandStack">f:getNewExpandStack</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w5037"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?parseStrings">parseStrings</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span id="wx5051" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5053"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?expandStack">expandStack</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean*</span><span class="z">"</span><span id="wx5067" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="z">&lt;!--</span><span class="cm"> don't and empty tag value to stack </span><span class="z">--&gt;</span><span class="txt">
    </span><span class="ww" id="w5073"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?startXslTag">startXslTag</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z"> 
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-exists" class="solar"><span class="function">exists</span></a><span class="parenthesis">(</span><span class="variable">$parseStrings</span><span class="filter">[</span><span class="axis">@</span><span class="qname">class</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">en</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">enxsl</span><span class="op">'</span><span class="parenthesis">)</span><span class="filter">]</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-empty" class="solar"><span class="function">empty</span></a><span class="parenthesis">(</span><span class="variable">$parseStrings</span><span class="filter">[</span><span class="axis">@</span><span class="qname">class</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">sc</span><span class="op">'</span><span class="filter">]</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx5129" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5131"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?closeXslTag">closeXslTag</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-exists" class="solar"><span class="function">exists</span></a><span class="parenthesis">(</span><span class="variable">$parseStrings</span><span class="filter">[</span><span class="axis">@</span><span class="qname">class</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">cl</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">clxsl</span><span class="op">'</span><span class="parenthesis">)</span><span class="filter">]</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx5170" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5172"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?expandValue">expandValue</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean?</span><span class="z">"</span><span class="z"> 
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#f?{internal}getExpandTextValue" class="solar"><span class="function">f:getExpandTextValue</span></a><span class="parenthesis">(</span><span class="variable">$parseStrings</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx5195" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w5197"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-exists" class="solar"><span class="function">exists</span></a><span class="parenthesis">(</span><span class="variable">$expandValue</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                          </span><span class="parenthesis">(</span><span class="variable">$expandStack</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$expandValue</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="parenthesis">(</span><span class="variable">$startXslTag</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                          </span><span class="parenthesis">(</span><span class="variable">$expandStack</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$expandStack</span><span class="filter">[</span><a href="http://www.w3.org/TR/xpath-functions/#func-last" class="solar"><span class="function">last</span></a><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="filter">]</span><span class="parenthesis">)</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="parenthesis">(</span><span class="variable">$closeXslTag</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                          </span><a href="http://www.w3.org/TR/xpath-functions/#func-subsequence" class="solar"><span class="function">subsequence</span></a><span class="parenthesis">(</span><span class="variable">$expandStack</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">1</span><span class="op">,</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-count" class="solar"><span class="function">count</span></a><span class="parenthesis">(</span><span class="variable">$expandStack</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace">
                          </span><span class="variable">$expandStack</span><span class="z">"</span><span id="wx5274" class="sc">/&gt;</span></span><span class="txt">
    
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx5278" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w5280"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{internal}getExpandTextValue">f:getExpandTextValue</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean?</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w5296"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?parseStrings">parseStrings</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span id="wx5310" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w5312"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?expandValue">expandValue</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string?</span><span class="z">"</span><span class="z"> 
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="parenthesis">(</span><span class="variable">$parseStrings</span><span class="filter">[</span><span class="axis">@</span><span class="qname">class</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">en</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">enxsl</span><span class="op">'</span><span class="parenthesis">)</span><span class="filter">]</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                          </span><span class="parenthesis">(</span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$i</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace"> </span><span class="op">to</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-count" class="solar"><span class="function">count</span></a><span class="parenthesis">(</span><span class="variable">$parseStrings</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">return</span><span class="whitespace">
                          </span><span class="if">if</span><span class="parenthesis">(</span><span class="variable">$parseStrings</span><span class="filter">[</span><span class="variable">$i</span><span class="filter">]</span><span class="filter">[</span><span class="axis">@</span><span class="qname">class</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">atn</span><span class="op">'</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="context">.</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">xsl:expand-text</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">expand-text</span><span class="op">'</span><span class="parenthesis">)</span><span class="filter">]</span><span class="parenthesis">)</span><span class="whitespace">
                          </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$parseStrings</span><span class="filter">[</span><span class="variable">$i</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">3</span><span class="filter">]</span><span class="step">/</span><span class="node-type">text</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">
                          </span><span class="parenthesis">)</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx5432" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5434"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="parenthesis">(</span><span class="variable">$expandValue</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                          </span><span class="variable">$expandValue</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">yes</span><span class="op">'</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx5460" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx5464" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w5466"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{internal}checkExpandSpans">f:checkExpandSpans</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w5482"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?spans">spans</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span id="wx5496" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5498"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?existing-expand-state">existing-expand-state</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean*</span><span class="z">"</span><span id="wx5512" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5514"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?expandValue">expandValue</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string?</span><span class="z">"</span><span class="z"> 
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="higher">for</span><span class="whitespace"> </span><span class="variable">$i</span><span class="whitespace"> </span><span class="op">in</span><span class="whitespace"> </span><span class="numeric">1</span><span class="whitespace"> </span><span class="op">to</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-count" class="solar"><span class="function">count</span></a><span class="parenthesis">(</span><span class="variable">$spans</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">return</span><span class="whitespace">
                          </span><span class="if">if</span><span class="parenthesis">(</span><span class="variable">$spans</span><span class="filter">[</span><span class="variable">$i</span><span class="filter">]</span><span class="filter">[</span><span class="axis">@</span><span class="qname">class</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">atn</span><span class="op">'</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="context">.</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">xsl:expand-text</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">expand-text</span><span class="op">'</span><span class="parenthesis">)</span><span class="filter">]</span><span class="parenthesis">)</span><span class="whitespace">
                          </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$spans</span><span class="filter">[</span><span class="variable">$i</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">3</span><span class="filter">]</span><span class="step">/</span><span class="node-type">text</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx5603" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5605"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="parenthesis">(</span><span class="variable">$expandValue</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                          </span><span class="variable">$expandValue</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">yes</span><span class="op">'</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$existing-expand-state</span><span class="z">"</span><span id="wx5630" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx5634" class="ec">&gt;</span></span><span class="txt">
  
  
  </span><span class="ww" id="w5636"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{internal}getAttributes">f:getAttributes</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">item()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w5652"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?attToken">attToken</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span id="wx5666" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5668"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?offset">offset</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx5682" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5684"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?parts">parts</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span id="wx5698" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5700"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?index">index</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:integer</span><span class="z">"</span><span id="wx5714" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5716"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?doctype">doctype</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span id="wx5730" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5732"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?root-prefix">root-prefix</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span id="wx5746" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5748"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?ename">ename</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span id="wx5762" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5764"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?expand-text">expand-text</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span id="wx5778" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5780"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?is-xsl">is-xsl</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$doctype</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">xslt</span><span class="op">'</span><span class="z">"</span><span id="wx5806" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5808"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?is-xsd">is-xsd</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function">not</span></a><span class="parenthesis">(</span><span class="variable">$is-xsl</span><span class="parenthesis">)</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span id="wx5831" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w5833"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?part1">part1</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string?</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$parts</span><span class="filter">[</span><span class="variable">$index</span><span class="filter">]</span><span class="z">"</span><span id="wx5856" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5858"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?part2">part2</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string?</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$parts</span><span class="filter">[</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="filter">]</span><span class="z">"</span><span id="wx5885" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w5887"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?elementName">elementName</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string?</span><span class="z">"</span><span class="z">
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$ename</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                          </span><a href="http://www.w3.org/TR/xpath-functions/#func-tokenize" class="solar"><span class="function">tokenize</span></a><span class="parenthesis">(</span><span class="variable">$part1</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">&gt;|\s+|/</span><span class="op">'</span><span class="parenthesis">)</span><span class="filter">[</span><span class="numeric">1</span><span class="filter">]</span><span class="whitespace">
                          </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$ename</span><span class="z">"</span><span id="wx5936" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w5938"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?with-prefix">with-prefix</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-starts-with" class="solar"><span class="function">starts-with</span></a><span class="parenthesis">(</span><span class="variable">$elementName</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$root-prefix</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx5958" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w5960"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?is-xsl-element">is-xsl-element</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$is-xsl</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$with-prefix</span><span class="z">"</span><span id="wx5978" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w5980"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="numeric">1</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w5994"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="av">es</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">&amp;lt;</span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx6006" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ww" id="w6008"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$is-xsl-element</span><span class="parenthesis">)</span><span class="whitespace">
                   </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">enxsl</span><span class="op">'</span><span class="whitespace">
                   </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$is-xsl</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function">not</span></a><span class="parenthesis">(</span><span class="variable">$with-prefix</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">
                   </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">en</span><span class="op">'</span><span class="whitespace">
                   </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$is-xsd</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function">not</span></a><span class="parenthesis">(</span><span class="variable">$with-prefix</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">
                   </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">enxsl</span><span class="op">'</span><span class="whitespace">
                   </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$is-xsd</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$elementName</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="doctype-functions.xsl.html#f?{internal}get-xsd-fnames" class="solar"><span class="function">f:get-xsd-fnames</span></a><span class="parenthesis">(</span><span class="variable">$root-prefix</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$doctype</span><span class="parenthesis">)</span><span class="step">/</span><span class="axis">@</span><span class="qname">name</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">enxsl</span><span class="op">'</span><span class="whitespace"> 
                   </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">en</span><span class="op">'</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="z">&lt;!--</span><span class="cm">
             id="{js:stackPush($elementName)}"&gt;
        </span><span class="z">--&gt;</span><span class="txt">
        </span><span class="ww" id="w6113"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$elementName</span><span class="z">"</span><span id="wx6121" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx6125" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx6129" class="ec">&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w6131"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?pre-close">pre-close</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-substring-before" class="solar"><span class="function">substring-before</span></a><span class="parenthesis">(</span><span class="variable">$part1</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">&gt;</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx6153" class="sc">/&gt;</span></span><span class="txt"> 
    
    </span><span class="ww" id="w6155"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?isFinalPart">isFinalPart</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">2</span><span class="whitespace"> </span><span class="op">gt</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-count" class="solar"><span class="function">count</span></a><span class="parenthesis">(</span><span class="variable">$parts</span><span class="parenthesis">)</span><span class="whitespace">
                                             </span><span class="op">or</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-string-length" class="solar"><span class="function">string-length</span></a><span class="parenthesis">(</span><span class="variable">$pre-close</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">gt</span><span class="whitespace"> </span><span class="numeric">0</span><span class="whitespace">
                                             </span><span class="op">or</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-starts-with" class="solar"><span class="function">starts-with</span></a><span class="parenthesis">(</span><span class="variable">$part1</span><span class="op">,</span><span class="op">'</span><span class="literal">&gt;</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="z">
                  </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span id="wx6208" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w6210"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?spans">spans</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      
      </span><span class="ww" id="w6226"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w6230"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isFinalPart</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="z">&lt;!--</span><span class="cm">  use sc class value to mark end of self-closed element </span><span class="z">--&gt;</span><span class="txt">
          </span><span class="ww" id="w6244"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?isSelfClosed">isSelfClosed</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-ends-with" class="solar"><span class="function">ends-with</span></a><span class="parenthesis">(</span><span class="variable">$pre-close</span><span class="op">,</span><span class="op">'</span><span class="literal">/</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span id="wx6271" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w6273"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$isSelfClosed</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">sc</span><span class="op">'</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">scx</span><span class="op">'</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w6301"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$isSelfClosed</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">/</span><span class="op">'</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal"></span><span class="op">'</span><span class="z">"</span><span id="wx6325" class="sc">/&gt;</span></span><span class="txt">&amp;gt;</span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx6329" class="ec">&gt;</span></span><span class="txt">
          
          </span><span class="ww" id="w6331"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?textNode">textNode</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-substring" class="solar"><span class="function">substring</span></a><span class="parenthesis">(</span><span class="variable">$attToken</span><span class="op">,</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-string-length" class="solar"><span class="function">string-length</span></a><span class="parenthesis">(</span><span class="variable">$pre-close</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="variable">$offset</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">2</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx6368" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w6370"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w6374"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$expand-text</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function">not</span></a><span class="parenthesis">(</span><span class="variable">$is-xsl-element</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-ends-with" class="solar"><span class="function">ends-with</span></a><span class="parenthesis">(</span><span class="variable">$elementName</span><span class="op">,</span><span class="op">'</span><span class="literal">:text</span><span class="op">'</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="ww" id="w6402"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}show-xsl-tvt" class="solar"><span class="function">qf:show-xsl-tvt</span></a><span class="parenthesis">(</span><span class="variable">$textNode</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx6413" class="sc">/&gt;</span></span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx6417" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ww" id="w6419"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="ww" id="w6423"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="av">txt</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                </span><span class="ww" id="w6433"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$textNode</span><span class="z">"</span><span id="wx6441" class="sc">/&gt;</span></span><span class="txt">
              </span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx6445" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx6449" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx6453" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx6457" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w6459"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-exists" class="solar"><span class="function">exists</span></a><span class="parenthesis">(</span><span class="variable">$part2</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="z">&lt;!--</span><span class="cm"> attribute must exist and name occurs before value, so get this first </span><span class="z">--&gt;</span><span class="txt">
          </span><span class="ww" id="w6476"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?left">left</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="z">
                        </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="whitespace">
                                </span><span class="op">then</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-substring" class="solar"><span class="function">substring</span></a><span class="parenthesis">(</span><span class="variable">$part1</span><span class="op">,</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-string-length" class="solar"><span class="function">string-length</span></a><span class="parenthesis">(</span><span class="variable">$elementName</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="whitespace">
                                </span><span class="op">else</span><span class="whitespace"> </span><span class="variable">$part1</span><span class="z">"</span><span id="wx6525" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w6527"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?pre">pre</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-substring-before" class="solar"><span class="function">substring-before</span></a><span class="parenthesis">(</span><span class="variable">$left</span><span class="op">,</span><span class="op">'</span><span class="literal">=</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx6548" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="z">&lt;!--</span><span class="cm">
               &lt;xsl:variable name="tokens" select="tokenize($pre, '\s+')"/&gt;
          </span><span class="z">--&gt;</span><span class="txt">
          </span><span class="ww" id="w6554"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?tokens">tokens</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#f?{internal}splitAttributeName" class="solar"><span class="function">f:splitAttributeName</span></a><span class="parenthesis">(</span><span class="variable">$pre</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx6571" class="sc">/&gt;</span></span><span class="txt">
          
          </span><span class="ww" id="w6573"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?attSpans">attSpans</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w6589"><span class="es">&lt;</span><span class="enxsl">xsl:for-each</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$tokens</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="ww" id="w6599"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?class">class</span><span class="z">"</span><span class="z">
                            </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-matches" class="solar"><span class="function">matches</span></a><span class="parenthesis">(</span><span class="context">.</span><span class="op">,</span><span class="op">'</span><span class="literal">\S</span><span class="op">'</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> 
                                    </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">atn</span><span class="op">'</span><span class="whitespace">
                                    </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">z</span><span class="op">'</span><span class="z">"</span><span id="wx6636" class="sc">/&gt;</span></span><span class="txt">
              </span><span class="ww" id="w6638"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$class</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt"></span><span class="ww" id="w6650"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="context">.</span><span class="z">"</span><span id="wx6658" class="sc">/&gt;</span></span><span class="txt"></span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx6662" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:for-each</span><span id="wx6666" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx6670" class="ec">&gt;</span></span><span class="txt">
          
          </span><span class="ww" id="w6672"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?att-name">att-name</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$attSpans</span><span class="filter">[</span><span class="axis">@</span><span class="qname">class</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">atn</span><span class="op">'</span><span class="filter">]</span><span class="z">"</span><span id="wx6696" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w6698"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?xsd-xpath-elements">xsd-xpath-elements</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="doctype-functions.xsl.html#f?{internal}get-xsd-element-names" class="solar"><span class="function">f:get-xsd-element-names</span></a><span class="parenthesis">(</span><span class="variable">$root-prefix</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$doctype</span><span class="parenthesis">)</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span id="wx6724" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w6726"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?xsd-xpath-attributes">xsd-xpath-attributes</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="doctype-functions.xsl.html#f?{internal}get-xsd-attribute-names" class="solar"><span class="function">f:get-xsd-attribute-names</span></a><span class="parenthesis">(</span><span class="variable">$root-prefix</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$doctype</span><span class="parenthesis">)</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span id="wx6752" class="sc">/&gt;</span></span><span class="txt">
          
          </span><span class="ww" id="w6754"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$attSpans</span><span class="z">"</span><span id="wx6762" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w6764"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?isXPath">isXPath</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z">
                        </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$is-xsl-element</span><span class="parenthesis">)</span><span class="whitespace">
                                </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$att-name</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">select</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">test</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">match</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">xpath</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">context-item</span><span class="op">'</span><span class="op">,</span><span class="whitespace">
                                </span><span class="op">'</span><span class="literal">namespace-context</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">count</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">use-when</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">for-each-item</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">for-each-stream</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">key</span><span class="op">'</span><span class="op">,</span><span class="whitespace">
                                </span><span class="op">'</span><span class="literal">initial-value</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">value</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">applies-to</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">on-empty</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">xpath</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">with-params</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">context-item</span><span class="op">'</span><span class="op">,</span><span class="whitespace">
                                </span><span class="op">'</span><span class="literal">group-by</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">group-adjacent</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">group-starting-with</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">group-ending-with</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">use</span><span class="op">'</span><span class="op">,</span><span class="op">'</span><span class="literal">use-when</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace">
                                
                                </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-exists" class="solar"><span class="function">exists</span></a><span class="parenthesis">(</span><span class="variable">$xsd-xpath-attributes</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                                
                                </span><span class="parenthesis">(</span><span class="variable">$is-xsd</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-exists" class="solar"><span class="function">exists</span></a><span class="parenthesis">(</span><span class="whitespace"> 
                                </span><span class="variable">$xsd-xpath-attributes</span><span class="filter">[</span><span class="axis">@</span><span class="qname">name</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$att-name</span><span class="filter">]</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> 
                                
                                </span><span class="op">else</span><span class="whitespace">
                                
                                </span><span class="parenthesis">(</span><span class="variable">$is-xsd</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-exists" class="solar"><span class="function">exists</span></a><span class="parenthesis">(</span><span class="whitespace"> 
                                </span><span class="variable">$xsd-xpath-elements</span><span class="filter">[</span><span class="axis">@</span><span class="qname">name</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$elementName</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="context">.</span><span class="step">/</span><span class="qname">dt:att</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$att-name</span><span class="filter">]</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace"> 
                                </span><span class="z">"</span><span id="wx6963" class="sc">/&gt;</span></span><span class="txt">
          
          </span><span class="z">&lt;!--</span><span class="cm"> for coloring attribute values that are referenced from XPath </span><span class="z">--&gt;</span><span class="txt">
          </span><span class="ww" id="w6969"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?metaXPathName">metaXPathName</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="z">
                        </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#f?{internal}get-av-class" class="solar"><span class="function">f:get-av-class</span></a><span class="parenthesis">(</span><span class="variable">$is-xsl-element</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$doctype</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$is-xsd</span><span class="op">,</span><span class="whitespace"> 
                                       </span><span class="variable">$elementName</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$att-name</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$root-prefix</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx7007" class="sc">/&gt;</span></span><span class="txt">
          
          </span><span class="ww" id="w7009"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="av">atneq</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt"></span><span class="ww" id="w7019"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-substring" class="solar"><span class="function">substring</span></a><span class="parenthesis">(</span><span class="variable">$left</span><span class="op">,</span><a href="http://www.w3.org/TR/xpath-functions/#func-string-length" class="solar"><span class="function">string-length</span></a><span class="parenthesis">(</span><span class="variable">$pre</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx7039" class="sc">/&gt;</span></span><span class="txt"></span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx7043" class="ec">&gt;</span></span><span class="txt">
          
          </span><span class="ww" id="w7045"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?sl">sl</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-string-length" class="solar"><span class="function">string-length</span></a><span class="parenthesis">(</span><span class="variable">$part2</span><span class="parenthesis">)</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:double</span><span class="z">"</span><span id="wx7068" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w7070"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="av">z</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt"></span><span class="ww" id="w7080"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-substring" class="solar"><span class="function">substring</span></a><span class="parenthesis">(</span><span class="variable">$part2</span><span class="op">,</span><span class="numeric">1</span><span class="op">,</span><span class="numeric">1</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx7095" class="sc">/&gt;</span></span><span class="txt"></span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx7099" class="ec">&gt;</span></span><span class="txt">
          
          </span><span class="ww" id="w7101"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?attValue">attValue</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-substring" class="solar"><span class="function">substring</span></a><span class="parenthesis">(</span><span class="variable">$part2</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">2</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$sl</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">2</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx7128" class="sc">/&gt;</span></span><span class="txt">
          
          </span><span class="ww" id="w7130"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w7134"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$isXPath</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="ww" id="w7144"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#f?{com.qutoric.sketchpath.functions}showXPath" class="solar"><span class="function">loc:showXPath</span></a><span class="parenthesis">(</span><span class="variable">$attValue</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx7155" class="sc">/&gt;</span></span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx7159" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ww" id="w7161"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$is-xsl</span><span class="whitespace"> </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$metaXPathName</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">av</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="z">&lt;!--</span><span class="cm">
                   &lt;xsl:sequence select="f:processAVT($attValue, $metaXPathName)"/&gt;
              </span><span class="z">--&gt;</span><span class="txt">
              </span><span class="ww" id="w7185"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?att-spans">att-spans</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}show-xsl-tvt" class="solar"><span class="function">qf:show-xsl-tvt</span></a><span class="parenthesis">(</span><span class="variable">$attValue</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx7208" class="sc">/&gt;</span></span><span class="txt">
              </span><span class="ww" id="w7210"><span class="es">&lt;</span><span class="enxsl">xsl:for-each</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$att-spans</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                </span><span class="ww" id="w7220"><span class="es">&lt;</span><span class="enxsl">xsl:copy</span><span class="scx">&gt;</span><span class="txt">
                  </span><span class="ww" id="w7224"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="axis">@</span><span class="op">*</span><span class="whitespace"> </span><span class="op">except</span><span class="whitespace"> </span><span class="axis">@</span><span class="qname">class</span><span class="z">"</span><span id="wx7238" class="sc">/&gt;</span></span><span class="txt">
                  </span><span class="ww" id="w7240"><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">class</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="parenthesis">(</span><span class="axis">@</span><span class="qname">class</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">txt</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">av</span><span class="op">'</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="axis">@</span><span class="qname">class</span><span class="z">"</span><span id="wx7275" class="sc">/&gt;</span></span><span class="txt">
                  </span><span class="ww" id="w7277"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="node-type">node</span><span class="parenthesis">(</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx7287" class="sc">/&gt;</span></span><span class="txt">
                </span><span class="ez">&lt;/</span><span class="clxsl">xsl:copy</span><span id="wx7291" class="ec">&gt;</span></span><span class="txt">
              </span><span class="ez">&lt;/</span><span class="clxsl">xsl:for-each</span><span id="wx7295" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx7299" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ww" id="w7301"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="ww" id="w7305"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$metaXPathName</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
                </span><span class="ww" id="w7317"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$attValue</span><span class="z">"</span><span id="wx7325" class="sc">/&gt;</span></span><span class="txt">
              </span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx7329" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx7333" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx7337" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ww" id="w7339"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="av">z</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt"></span><span class="ww" id="w7349"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-substring" class="solar"><span class="function">substring</span></a><span class="parenthesis">(</span><span class="variable">$part2</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$sl</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx7363" class="sc">/&gt;</span></span><span class="txt"></span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx7367" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx7371" class="ec">&gt;</span></span><span class="txt">
        
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx7375" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx7379" class="ec">&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w7381"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?newExpandText">newExpandText</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span class="z"> 
                  </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#f?{internal}checkExpandSpans" class="solar"><span class="function">f:checkExpandSpans</span></a><span class="parenthesis">(</span><span class="variable">$spans</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$expand-text</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx7407" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w7409"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$spans</span><span class="z">"</span><span id="wx7417" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w7419"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?newOffset">newOffset</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-string-length" class="solar"><span class="function">string-length</span></a><span class="parenthesis">(</span><span class="variable">$part1</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-string-length" class="solar"><span class="function">string-length</span></a><span class="parenthesis">(</span><span class="variable">$part2</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="variable">$offset</span><span class="z">"</span><span id="wx7447" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w7449"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function">not</span></a><span class="parenthesis">(</span><span class="variable">$isFinalPart</span><span class="parenthesis">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w7462"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#f?{internal}getAttributes" class="solar"><span class="function">f:getAttributes</span></a><span class="parenthesis">(</span><span class="variable">$attToken</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$newOffset</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$parts</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$index</span><span class="whitespace"> </span><span class="op">+</span><span class="whitespace"> </span><span class="numeric">2</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$doctype</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$root-prefix</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$elementName</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$newExpandText</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx7498" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx7502" class="ec">&gt;</span></span><span class="txt">
    
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx7506" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w7508"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{internal}get-av-class">f:get-av-class</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w7524"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?is-xsl-element">is-xsl-element</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span id="wx7538" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w7540"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?doctype">doctype</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span id="wx7554" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w7556"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?is-xsd">is-xsd</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:boolean</span><span class="z">"</span><span id="wx7570" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w7572"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?elementName">elementName</span><span class="z">"</span><span id="wx7580" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w7582"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?att-name">att-name</span><span class="z">"</span><span id="wx7590" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w7592"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?root-prefix">root-prefix</span><span class="z">"</span><span id="wx7600" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w7602"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?vp-name">vp-name</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string*</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="doctype-functions.xsl.html#f?{internal}prefixed-name" class="solar"><span class="function">f:prefixed-name</span></a><span class="parenthesis">(</span><span class="variable">$root-prefix</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">variable</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">param</span><span class="op">'</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx7637" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w7639"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?p-name">p-name</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$vp-name</span><span class="filter">[</span><span class="numeric">2</span><span class="filter">]</span><span class="z">"</span><span id="wx7662" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w7664"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z">
        </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$is-xsl-element</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace">
                </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$elementName</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$vp-name</span><span class="whitespace">
                </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$att-name</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">name</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$elementName</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="variable">$p-name</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">pname</span><span class="op">'</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">vname</span><span class="op">'</span><span class="whitespace">
                </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$elementName</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="doctype-functions.xsl.html#f?{internal}prefixed-name" class="solar"><span class="function">f:prefixed-name</span></a><span class="parenthesis">(</span><span class="variable">$root-prefix</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">import</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">include</span><span class="op">'</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">
                </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$att-name</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">href</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">href</span><span class="op">'</span><span class="whitespace">
                </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$elementName</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="doctype-functions.xsl.html#f?{internal}prefixed-name" class="solar"><span class="function">f:prefixed-name</span></a><span class="parenthesis">(</span><span class="variable">$root-prefix</span><span class="op">,</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="op">'</span><span class="literal">call-template</span><span class="op">'</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">
                </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$att-name</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">name</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">tcall</span><span class="op">'</span><span class="whitespace">
                </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$elementName</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="doctype-functions.xsl.html#f?{internal}prefixed-name" class="solar"><span class="function">f:prefixed-name</span></a><span class="parenthesis">(</span><span class="variable">$root-prefix</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">function</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> 
                </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$att-name</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">name</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">fname</span><span class="op">'</span><span class="whitespace">
                </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$elementName</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><a href="doctype-functions.xsl.html#f?{internal}prefixed-name" class="solar"><span class="function">f:prefixed-name</span></a><span class="parenthesis">(</span><span class="variable">$root-prefix</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">template</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> 
                </span><span class="op">and</span><span class="whitespace"> </span><span class="variable">$att-name</span><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">name</span><span class="op">'</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">tname</span><span class="op">'</span><span class="whitespace">
                </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">av</span><span class="op">'</span><span class="whitespace">
                
                </span><span class="op">else</span><span class="whitespace"> </span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$is-xsd</span><span class="whitespace"> 
                 </span><span class="op">and</span><span class="whitespace"> </span><a href="doctype-functions.xsl.html#f?{internal}is-xsd-fname" class="solar"><span class="function">f:is-xsd-fname</span></a><span class="parenthesis">(</span><span class="variable">$root-prefix</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$doctype</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$elementName</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$att-name</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">
                </span><span class="op">then</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">fname</span><span class="op">'</span><span class="whitespace"> </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">av</span><span class="op">'</span><span class="z">"</span><span id="wx7917" class="sc">/&gt;</span></span><span class="txt">
    
    
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx7921" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w7923"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{internal}unescape-p">f:unescape-p</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w7933"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?text">text</span><span class="z">"</span><span id="wx7941" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w7943"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?t1">t1</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-replace" class="solar"><span class="function">replace</span></a><span class="parenthesis">(</span><span class="variable">$text</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">&amp;#x0300;</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">{{</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx7970" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w7972"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-replace" class="solar"><span class="function">replace</span></a><span class="parenthesis">(</span><span class="variable">$t1</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">&amp;#x0301;</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">}}</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx7993" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx7997" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w7999"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{internal}processAVT">f:processAVT</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w8009"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?attText">attText</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span id="wx8023" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w8025"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?class">class</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span id="wx8039" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w8041"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?regex1">regex1</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal">\{.*?\}</span><span class="op">'</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span id="wx8063" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w8065"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?t1">t1</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-replace" class="solar"><span class="function">replace</span></a><span class="parenthesis">(</span><span class="variable">$attText</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">\{\{</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">&amp;#x0300;</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx8092" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w8094"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?t2">t2</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-replace" class="solar"><span class="function">replace</span></a><span class="parenthesis">(</span><span class="variable">$t1</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">\}\}</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">&amp;#x0301;</span><span class="op">'</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx8121" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="z">&lt;!--</span><span class="cm"> flags:s = match . to any char including \n </span><span class="z">--&gt;</span><span class="txt">
    </span><span class="ww" id="w8127"><span class="es">&lt;</span><span class="enxsl">xsl:analyze-string</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$t2</span><span class="z">"</span><span class="z"> </span><span class="atn">regex</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$regex1</span><span class="op">}</span><span class="z">"</span><span class="z"> </span><span class="atn">flags</span><span class="atneq">=</span><span class="z">"</span><span class="av">s</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      
      </span><span class="ww" id="w8151"><span class="es">&lt;</span><span class="enxsl">xsl:matching-substring</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w8155"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?p">p</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#f?{internal}unescape-p" class="solar"><span class="function">f:unescape-p</span></a><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-substring" class="solar"><span class="function">substring</span></a><span class="parenthesis">(</span><span class="context">.</span><span class="op">,</span><span class="whitespace"> </span><span class="numeric">2</span><span class="op">,</span><span class="whitespace"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-string-length" class="solar"><span class="function">string-length</span></a><span class="parenthesis">(</span><span class="context">.</span><span class="parenthesis">)</span><span class="whitespace"> </span><span class="op">-</span><span class="whitespace"> </span><span class="numeric">2</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx8188" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ww" id="w8190"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="av">op</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w8200"><span class="es">&lt;</span><span class="enxsl">xsl:text</span><span class="scx">&gt;</span><span class="txt">{</span><span class="ez">&lt;/</span><span class="clxsl">xsl:text</span><span id="wx8206" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx8210" class="ec">&gt;</span></span><span class="txt">
        
        </span><span class="ww" id="w8212"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#f?{com.qutoric.sketchpath.functions}showXPath" class="solar"><span class="function">loc:showXPath</span></a><span class="parenthesis">(</span><span class="variable">$p</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx8223" class="sc">/&gt;</span></span><span class="txt">
        
        </span><span class="ww" id="w8225"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="av">op</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w8235"><span class="es">&lt;</span><span class="enxsl">xsl:text</span><span class="scx">&gt;</span><span class="txt">}</span><span class="ez">&lt;/</span><span class="clxsl">xsl:text</span><span id="wx8241" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx8245" class="ec">&gt;</span></span><span class="txt">
        
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:matching-substring</span><span id="wx8249" class="ec">&gt;</span></span><span class="txt">
      
      </span><span class="ww" id="w8251"><span class="es">&lt;</span><span class="enxsl">xsl:non-matching-substring</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w8255"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?p">p</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#f?{internal}unescape-p" class="solar"><span class="function">f:unescape-p</span></a><span class="parenthesis">(</span><span class="context">.</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx8272" class="sc">/&gt;</span></span><span class="txt">
        
        </span><span class="ww" id="w8274"><span class="es">&lt;</span><span class="en">span</span><span class="z"> </span><span class="atn">class</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><span class="variable">$class</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w8286"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$p</span><span class="z">"</span><span id="wx8294" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="cl">span</span><span id="wx8298" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:non-matching-substring</span><span id="wx8302" class="ec">&gt;</span></span><span class="txt">
      
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:analyze-string</span><span id="wx8306" class="ec">&gt;</span></span><span class="txt">
    
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx8310" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w8312"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{internal}splitAttributeName">f:splitAttributeName</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w8322"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?text">text</span><span class="z">"</span><span id="wx8330" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w8332"><span class="es">&lt;</span><span class="enxsl">xsl:analyze-string</span><span class="z"> </span><span class="atn">regex</span><span class="atneq">=</span><span class="z">"</span><span class="av">(\S+)|(\s+)</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$text</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w8348"><span class="es">&lt;</span><span class="enxsl">xsl:matching-substring</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w8352"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="context">.</span><span class="z">"</span><span id="wx8360" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:matching-substring</span><span id="wx8364" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:analyze-string</span><span id="wx8368" class="ec">&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx8372" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="z">&lt;!--</span><span class="cm">
       signature:
           loc:showXPath(text-content)
       
       description:
       
           Converts the xpath content string to a sequence of span elements. with each
           containing a class attribute used for coloring with CSS. 
       
       params:
          text-content: string containing a single XPath expression
  </span><span class="z">--&gt;</span><span class="txt">
  </span><span class="ww" id="w8378"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{com.qutoric.sketchpath.functions}showXPath">loc:showXPath</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w8388"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?chunk">chunk</span><span class="z">"</span><span id="wx8396" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="z">&lt;!--</span><span class="cm">
         &lt;xsl:variable name="chars" as="xs:string*"
         select="loc:stringToCharSequence($chunk)"/&gt;
         
         &lt;xsl:variable name="blocks" as="element()*"&gt;
         &lt;xsl:sequence select="loc:createBlocks($chars, false(), 1, '', 0, 0)"/&gt;
         &lt;/xsl:variable&gt;
         &lt;xsl:variable name="pbPairs" as="element()*"
         select="loc:createPairs($blocks[name() = 'block' and @type = ('[',']','(',')')])"/&gt;
         
         &lt;xsl:variable name="omitPairs" as="element()*"
         select="($blocks[name() = ('literal','comment')])"/&gt;
         
    </span><span class="z">--&gt;</span><span class="txt">
    </span><span class="ww" id="w8402"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?tokens">tokens</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w8418"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xq-spectrum.xsl.html#f?{urn:xq.internal-function}show-xquery" class="solar"><span class="function">qf:show-xquery</span></a><span class="parenthesis">(</span><span class="variable">$chunk</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx8429" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx8433" class="ec">&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w8435"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w8439"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="highlight-file.xsl.html#p?css-inline" class="solar"><span class="variable">$css-inline</span></a><span class="whitespace"> </span><span class="op">eq</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">no</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w8455"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$tokens</span><span class="z">"</span><span id="wx8463" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx8467" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ww" id="w8469"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w8473"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#f?{internal}style-spans" class="solar"><span class="function">f:style-spans</span></a><span class="parenthesis">(</span><span class="variable">$tokens</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx8484" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx8488" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx8492" class="ec">&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx8496" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w8498"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{internal}style-spans">f:style-spans</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">node()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w8514"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="pname" id="p?spans">spans</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">node()*</span><span class="z">"</span><span id="wx8528" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w8530"><span class="es">&lt;</span><span class="enxsl">xsl:for-each</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable">$spans</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w8540"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?color-key">color-key</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="axis">@</span><span class="qname">class</span><span class="z">"</span><span id="wx8555" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ww" id="w8557"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?color-mode1">color-mode1</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element(color)?</span><span class="z">"</span><span class="z">
                    </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="xmlspectrum.xsl.html#v?color-modes" class="solar"><span class="variable">$color-modes</span></a><span class="step">/</span><span class="qname">color</span><span class="filter">[</span><span class="qname">class</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="variable">$color-key</span><span class="filter">]</span><span class="z">"</span><span id="wx8586" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="z">&lt;!--</span><span class="cm"> use the yellow color mode if none defined for class </span><span class="z">--&gt;</span><span class="txt">
      </span><span class="ww" id="w8592"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?color-mode2">color-mode2</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">element(color)</span><span class="z">"</span><span class="z">
                    </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-exists" class="solar"><span class="function">exists</span></a><span class="parenthesis">(</span><span class="variable">$color-mode1</span><span class="parenthesis">)</span><span class="parenthesis">)</span><span class="whitespace">
                            </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$color-mode1</span><span class="whitespace">
                            </span><span class="op">else</span><span class="whitespace"> </span><a href="xmlspectrum.xsl.html#v?color-modes" class="solar"><span class="variable">$color-modes</span></a><span class="step">/</span><span class="qname">color</span><span class="filter">[</span><span class="axis">@</span><span class="qname">name</span><span class="whitespace"> </span><span class="op">=</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">yellow</span><span class="op">'</span><span class="filter">]</span><span class="z">"</span><span id="wx8639" class="sc">/&gt;</span></span><span class="txt">
      
      </span><span class="ww" id="w8641"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?property">property</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if">if</span><span class="whitespace"> </span><span class="parenthesis">(</span><span class="variable">$color-mode2</span><span class="step">/</span><span class="axis">@</span><span class="qname">property</span><span class="parenthesis">)</span><span class="whitespace">
                                            </span><span class="op">then</span><span class="whitespace"> </span><span class="variable">$color-mode2</span><span class="step">/</span><span class="axis">@</span><span class="qname">property</span><span class="whitespace">
                                            </span><span class="op">else</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">color</span><span class="op">'</span><span class="z">"</span><span id="wx8675" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ww" id="w8677"><span class="es">&lt;</span><span class="enxsl">xsl:copy</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w8681"><span class="es">&lt;</span><span class="enxsl">xsl:copy-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="axis">@</span><span class="op">*</span><span class="z">"</span><span id="wx8690" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ww" id="w8692"><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">style</span><span class="z">"</span><span class="z">
                       </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-concat" class="solar"><span class="function">concat</span></a><span class="parenthesis">(</span><span class="variable">$property</span><span class="op">,</span><span class="whitespace"> </span><span class="op">'</span><span class="literal">: #</span><span class="op">'</span><span class="op">,</span><span class="whitespace"> </span><span class="variable">$color-mode2</span><span class="step">/</span><span class="axis">@</span><span class="qname">value</span><span class="parenthesis">)</span><span class="z">"</span><span id="wx8720" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ww" id="w8722"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="context">.</span><span class="z">"</span><span id="wx8730" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:copy</span><span id="wx8734" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:for-each</span><span id="wx8738" class="ec">&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx8742" class="ec">&gt;</span></span><span class="txt">
  
</span><span class="ez">&lt;/</span><span class="clxsl">xsl:stylesheet</span><span id="wx8746" class="ec">&gt;</span></span><span class="txt">
</span></pre></div></body></html>