<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>15-transclude.xsl</title><link rel="stylesheet" type="text/css" href="../../../theme.css"></head><body><div><p class="spectrum"><span class="z">&lt;?</span><span class="pi">xml version="1.0" encoding="utf-8"</span><span class="z">?&gt;</span><span class="txt">
</span><span class="ww" id="w5"><span class="es">&lt;</span><span class="enxsl">xsl:stylesheet</span><span class="z"> </span><span class="atn">xmlns:xsl</span><span class="atneq">=</span><span class="z">"</span><span class="av">http://www.w3.org/1999/XSL/Transform</span><span class="z">"</span><span class="z"> </span><span class="atn">version</span><span class="atneq">=</span><span class="z">"</span><span class="av">2.0</span><span class="z">"</span><span class="z">
                </span><span class="atn">xmlns:f</span><span class="atneq">=</span><span class="z">"</span><span class="av">http://docbook.org/xslt/ns/extension</span><span class="z">"</span><span class="z">
                </span><span class="atn">xmlns:mp</span><span class="atneq">=</span><span class="z">"</span><span class="av">http://docbook.org/xslt/ns/mode/private</span><span class="z">"</span><span class="z">
                </span><span class="atn">xmlns:db</span><span class="atneq">=</span><span class="z">"</span><span class="av">http://docbook.org/ns/docbook</span><span class="z">"</span><span class="z">
                </span><span class="atn">xmlns:xs</span><span class="atneq">=</span><span class="z">"</span><span class="av">http://www.w3.org/2001/XMLSchema</span><span class="z">"</span><span class="z">
                </span><span class="atn">xmlns:ta</span><span class="atneq">=</span><span class="z">"</span><span class="av">http://docbook.org/xslt/ns/transclusion-annotation</span><span class="z">"</span><span class="z">
                </span><span class="atn">exclude-result-prefixes</span><span class="atneq">=</span><span class="z">"</span><span class="av">f mp xs</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
  
  </span><span class="ww" id="w57"><span class="es">&lt;</span><span class="enxsl">xsl:template</span><span class="z"> </span><span class="atn">match</span><span class="atneq">=</span><span class="z">"</span><span class="step" start="1">/</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w67"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="../../../xslt/base/preprocess/15-transclude.xsl.html#f?{http://docbook.org/xslt/ns/extension}transclude-and-adjust-idrefs" class="solar"><span class="function" start="1" pair-end="33" select="quick">f:transclude-and-adjust-idrefs</span></a><span class="parenthesis">(</span><span class="step" start="32">/</span><span class="parenthesis" start="33">)</span><span class="z">"</span><span id="wx78" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:template</span><span id="wx82" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="z">&lt;!--</span><span class="cm"> Separator for auto generated prefixes </span><span class="z">--&gt;</span><span class="txt">
  </span><span class="ww" id="w88"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?psep">psep</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal" start="1">---</span><span class="op">'</span><span class="z">"</span><span id="wx104" class="sc">/&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w106"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{http://docbook.org/xslt/ns/extension}transclude-and-adjust-idrefs">f:transclude-and-adjust-idrefs</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">node()+</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w122"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?doc">doc</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">document-node()</span><span class="z">"</span><span id="wx136" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w138"><span class="es">&lt;</span><span class="enxsl">xsl:document</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w142"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="../../../xslt/base/preprocess/15-transclude.xsl.html#f?{http://docbook.org/xslt/ns/extension}adjust-idrefs" class="solar"><span class="function" start="1" pair-end="35" select="quick">f:adjust-idrefs</span></a><span class="parenthesis">(</span><a href="../../../xslt/base/preprocess/15-transclude.xsl.html#f?{http://docbook.org/xslt/ns/extension}transclude" class="solar"><span class="function" start="17" pair-end="34" select="quick">f:transclude</span></a><span class="parenthesis">(</span><span class="variable" start="30" select="quick">$doc</span><span class="parenthesis" start="34">)</span><span class="parenthesis" start="35">)</span><span class="z">"</span><span id="wx156" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:document</span><span id="wx160" class="ec">&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx164" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w166"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{http://docbook.org/xslt/ns/extension}transclude">f:transclude</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">node()+</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w182"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?doc">doc</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">node()+</span><span class="z">"</span><span id="wx196" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w198"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?expanded">expanded</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="../../../xslt/base/preprocess/15-transclude.xsl.html#f?{http://docbook.org/xslt/ns/extension}expand-definitions" class="solar"><span class="function" start="1" pair-end="26" select="quick">f:expand-definitions</span></a><span class="parenthesis">(</span><span class="variable" start="22" select="quick">$doc</span><span class="parenthesis" start="26">)</span><span class="z">"</span><span id="wx215" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w217"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?resolved">resolved</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="../../../xslt/base/preprocess/15-transclude.xsl.html#f?{http://docbook.org/xslt/ns/extension}resolve-references" class="solar"><span class="function" start="1" pair-end="31" select="quick">f:resolve-references</span></a><span class="parenthesis">(</span><span class="variable" start="22" select="quick">$expanded</span><span class="parenthesis" start="31">)</span><span class="z">"</span><span id="wx234" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w236"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable" start="1" select="quick">$resolved</span><span class="z">"</span><span id="wx244" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx248" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w250"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{http://docbook.org/xslt/ns/extension}expand-definitions">f:expand-definitions</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">node()+</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w266"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?doc">doc</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">node()+</span><span class="z">"</span><span id="wx280" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w282"><span class="es">&lt;</span><span class="enxsl">xsl:apply-templates</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable" start="1" select="quick">$doc</span><span class="z">"</span><span class="z"> </span><span class="atn">mode</span><span class="atneq">=</span><span class="z">"</span><span class="av">mp:expand-definitions</span><span class="z">"</span><span id="wx296" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx300" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w302"><span class="es">&lt;</span><span class="enxsl">xsl:template</span><span class="z"> </span><span class="atn">match</span><span class="atneq">=</span><span class="z">"</span><span class="node" start="1" pair-end="6" select="quick">node</span><span class="parenthesis">(</span><span class="parenthesis" start="6">)</span><span class="z">"</span><span class="z"> </span><span class="atn">mode</span><span class="atneq">=</span><span class="z">"</span><span class="av">mp:expand-definitions</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w320"><span class="es">&lt;</span><span class="enxsl">xsl:copy</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w324"><span class="es">&lt;</span><span class="enxsl">xsl:copy-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="axis" start="1">@</span><span class="qname" start="2" select="quick">*</span><span class="z">"</span><span id="wx333" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ww" id="w335"><span class="es">&lt;</span><span class="enxsl">xsl:apply-templates</span><span class="z"> </span><span class="atn">mode</span><span class="atneq">=</span><span class="z">"</span><span class="av">mp:expand-definitions</span><span class="z">"</span><span id="wx343" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:copy</span><span id="wx347" class="ec">&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:template</span><span id="wx351" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w353"><span class="es">&lt;</span><span class="enxsl">xsl:template</span><span class="z"> </span><span class="atn">match</span><span class="atneq">=</span><span class="z">"</span><span class="qname" start="1" select="quick">db:definitions</span><span class="filter" start="15" pair-end="31" select="quick">[</span><span class="axis" start="16">@</span><span class="qname" start="17" select="quick">definitionfile</span><span class="filter" start="31">]</span><span class="z">"</span><span class="z"> </span><span class="atn">mode</span><span class="atneq">=</span><span class="z">"</span><span class="av">mp:expand-definitions</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w373"><span class="es">&lt;</span><span class="enxsl">xsl:copy-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="../../../xslt/base/preprocess/15-transclude.xsl.html#f?{http://docbook.org/xslt/ns/extension}expand-definitions" class="solar"><span class="function" start="1" pair-end="42" select="quick">f:expand-definitions</span></a><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-doc" class="solar"><span class="function" start="22" pair-end="41" select="quick">doc</span></a><span class="parenthesis">(</span><span class="axis" start="26">@</span><span class="qname" start="27" select="quick">definitionfile</span><span class="parenthesis" start="41">)</span><span class="parenthesis" start="42">)</span><span class="z">"</span><span id="wx388" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w390"><span class="es">&lt;</span><span class="enxsl">xsl:copy</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w394"><span class="es">&lt;</span><span class="enxsl">xsl:copy-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="axis" start="1">@</span><span class="qname" start="2" select="quick">*</span><span class="whitespace" start="3"> </span><span class="qname" start="4" select="quick">except</span><span class="whitespace" start="10"> </span><span class="axis" start="11">@</span><span class="qname" start="12" select="quick">definitionfile</span><span class="z">"</span><span id="wx408" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ww" id="w410"><span class="es">&lt;</span><span class="enxsl">xsl:apply-templates</span><span class="z"> </span><span class="atn">mode</span><span class="atneq">=</span><span class="z">"</span><span class="av">mp:expand-definitions</span><span class="z">"</span><span id="wx418" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:copy</span><span id="wx422" class="ec">&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:template</span><span id="wx426" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w428"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{http://docbook.org/xslt/ns/extension}resolve-references">f:resolve-references</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">node()+</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w444"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?doc">doc</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">node()+</span><span class="z">"</span><span id="wx458" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w460"><span class="es">&lt;</span><span class="enxsl">xsl:apply-templates</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable" start="1" select="quick">$doc</span><span class="z">"</span><span class="z"> </span><span class="atn">mode</span><span class="atneq">=</span><span class="z">"</span><span class="av">mp:transclude</span><span class="z">"</span><span id="wx474" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx478" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w480"><span class="es">&lt;</span><span class="enxsl">xsl:template</span><span class="z"> </span><span class="atn">match</span><span class="atneq">=</span><span class="z">"</span><span class="node" start="1" pair-end="6" select="quick">node</span><span class="parenthesis">(</span><span class="parenthesis" start="6">)</span><span class="z">"</span><span class="z"> </span><span class="atn">mode</span><span class="atneq">=</span><span class="z">"</span><span class="av">mp:transclude</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w498"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?idfixup">idfixup</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="op">'</span><span class="literal" start="1">auto</span><span class="op">'</span><span class="z">"</span><span class="z"> </span><span class="atn">tunnel</span><span class="atneq">=</span><span class="z">"</span><span class="av">yes</span><span class="z">"</span><span id="wx520" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w522"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?prefix">prefix</span><span class="z">"</span><span class="z"> </span><span class="atn">tunnel</span><span class="atneq">=</span><span class="z">"</span><span class="av">yes</span><span class="z">"</span><span id="wx536" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w538"><span class="es">&lt;</span><span class="enxsl">xsl:copy</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w542"><span class="es">&lt;</span><span class="enxsl">xsl:copy-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="axis" start="1">@</span><span class="qname" start="2" select="quick">*</span><span class="whitespace" start="3"> </span><span class="qname" start="4" select="quick">except</span><span class="whitespace" start="10"> </span><span class="axis" start="11">@</span><span class="qname" start="12" select="quick">xml:id</span><span class="z">"</span><span id="wx556" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ww" id="w558"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="axis" start="1">@</span><span class="qname" start="2" select="quick">xml:id</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w569"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w573"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="parenthesis" start="1" pair-end="19" select="quick">(</span><span class="variable" start="2" select="quick">$idfixup</span><span class="whitespace" start="10"> </span><span class="op" start="11">=</span><span class="whitespace" start="12"> </span><span class="op">'</span><span class="literal" start="13">none</span><span class="op">'</span><span class="parenthesis" start="19">)</span><span class="whitespace" start="20"> </span><span class="op" start="21">or</span><span class="whitespace" start="23"> </span><span class="axis" start="24">@</span><span class="qname" start="25" select="quick">ta:linkscope</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w596"><span class="es">&lt;</span><span class="enxsl">xsl:copy-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="axis" start="1">@</span><span class="qname" start="2" select="quick">xml:id</span><span class="z">"</span><span id="wx605" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx609" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ww" id="w611"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable" start="1" select="quick">$idfixup</span><span class="whitespace" start="9"> </span><span class="op" start="10">=</span><span class="whitespace" start="11"> </span><span class="op">'</span><span class="literal" start="12">strip</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx629" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ww" id="w631"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w635"><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">xml:id</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-concat" class="solar"><span class="function" start="1" pair-end="24" select="quick">concat</span></a><span class="parenthesis">(</span><span class="variable" start="8" select="quick">$prefix</span><span class="op" start="15">,</span><span class="whitespace" start="16"> </span><span class="axis" start="17">@</span><span class="qname" start="18" select="quick">xml:id</span><span class="parenthesis" start="24">)</span><span class="z">"</span><span id="wx656" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx660" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx664" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx668" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ww" id="w670"><span class="es">&lt;</span><span class="enxsl">xsl:apply-templates</span><span class="z"> </span><span class="atn">mode</span><span class="atneq">=</span><span class="z">"</span><span class="av">mp:transclude</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w680"><span class="es">&lt;</span><span class="enxsl">xsl:with-param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">prefix</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if" start="1">if</span><span class="whitespace" start="3"> </span><span class="parenthesis" start="4" pair-end="18" select="quick">(</span><span class="axis" start="5">@</span><span class="qname" start="6" select="quick">ta:linkscope</span><span class="parenthesis" start="18">)</span><span class="whitespace" start="19"> </span><span class="op" start="20">then</span><span class="whitespace" start="24"> </span><span class="op">'</span><span class="literal" start="25"></span><span class="op">'</span><span class="whitespace" start="27"> </span><span class="op" start="28">else</span><span class="whitespace" start="32"> </span><span class="variable" start="33" select="quick">$prefix</span><span class="z">"</span><span id="wx709" class="sc">/&gt;</span></span><span class="txt">   </span><span class="z">&lt;!--</span><span class="cm"> Prevent adding several prefixes on multi-level inclusions </span><span class="z">--&gt;</span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:apply-templates</span><span id="wx717" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:copy</span><span id="wx721" class="ec">&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:template</span><span id="wx725" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="z">&lt;!--</span><span class="cm"> FIMXE: this stripping is there just to have more compact output </span><span class="z">--&gt;</span><span class="txt">
  </span><span class="ww" id="w731"><span class="es">&lt;</span><span class="enxsl">xsl:template</span><span class="z"> </span><span class="atn">match</span><span class="atneq">=</span><span class="z">"</span><span class="qname" start="1" select="quick">db:definitions</span><span class="z">"</span><span class="z"> </span><span class="atn">mode</span><span class="atneq">=</span><span class="z">"</span><span class="av">mp:transclude</span><span class="z">"</span><span class="z"> </span><span class="atn">priority</span><span class="atneq">=</span><span class="z">"</span><span class="av">1</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:template</span><span id="wx755" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w757"><span class="es">&lt;</span><span class="enxsl">xsl:template</span><span class="z"> </span><span class="atn">match</span><span class="atneq">=</span><span class="z">"</span><span class="qname" start="1" select="quick">db:ref</span><span class="filter" start="7" pair-end="13" select="quick">[</span><span class="axis" start="8">@</span><span class="qname" start="9" select="quick">name</span><span class="filter" start="13">]</span><span class="z">"</span><span class="z"> </span><span class="atn">mode</span><span class="atneq">=</span><span class="z">"</span><span class="av">mp:transclude</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w777"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?name">name</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="axis" start="1">@</span><span class="qname" start="2" select="quick">name</span><span class="z">"</span><span id="wx792" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w794"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?content">content</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w804"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w808"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="axis" start="1">@</span><span class="qname" start="2" select="quick">definitionfile</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w819"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?defs">defs</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="../../../xslt/base/preprocess/15-transclude.xsl.html#f?{http://docbook.org/xslt/ns/extension}expand-definitions" class="solar"><span class="function" start="1" pair-end="42" select="quick">f:expand-definitions</span></a><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-doc" class="solar"><span class="function" start="22" pair-end="41" select="quick">doc</span></a><span class="parenthesis">(</span><span class="axis" start="26">@</span><span class="qname" start="27" select="quick">definitionfile</span><span class="parenthesis" start="41">)</span><span class="parenthesis" start="42">)</span><span class="z">"</span><span id="wx840" class="sc">/&gt;</span></span><span class="txt">
          
          </span><span class="ww" id="w842"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w846"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable" start="1" select="quick">$defs</span><span class="step" start="6">/</span><span class="qname" start="7" select="quick">db:def</span><span class="filter" start="13" pair-end="27" select="quick">[</span><span class="axis" start="14">@</span><span class="qname" start="15" select="quick">name</span><span class="whitespace" start="19"> </span><span class="op" start="20">=</span><span class="whitespace" start="21"> </span><span class="variable" start="22" select="quick">$name</span><span class="filter" start="27">]</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="ww" id="w866"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="parenthesis" start="1" pair-end="29" select="quick">(</span><span class="variable" start="2" select="quick">$defs</span><span class="step" start="7">/</span><span class="qname" start="8" select="quick">db:def</span><span class="filter" start="14" pair-end="28" select="quick">[</span><span class="axis" start="15">@</span><span class="qname" start="16" select="quick">name</span><span class="whitespace" start="20"> </span><span class="op" start="21">=</span><span class="whitespace" start="22"> </span><span class="variable" start="23" select="quick">$name</span><span class="filter" start="28">]</span><span class="parenthesis" start="29">)</span><span class="filter" start="30" pair-end="37" select="quick">[</span><a href="http://www.w3.org/TR/xpath-functions/#func-last" class="solar"><span class="function" start="31" pair-end="36" select="quick">last</span></a><span class="parenthesis">(</span><span class="parenthesis" start="36">)</span><span class="filter" start="37">]</span><span class="step" start="38">/</span><span class="node" start="39" pair-end="44" select="quick">node</span><span class="parenthesis">(</span><span class="parenthesis" start="44">)</span><span class="z">"</span><span id="wx895" class="sc">/&gt;</span></span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx899" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ww" id="w901"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="ww" id="w905"><span class="es">&lt;</span><span class="enxsl">xsl:message</span><span class="scx">&gt;</span><span class="txt">Error: definition of "</span><span class="ww" id="w909"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable" start="1" select="quick">$name</span><span class="z">"</span><span id="wx917" class="sc">/&gt;</span></span><span class="txt">" was not found.</span><span class="ez">&lt;/</span><span class="clxsl">xsl:message</span><span id="wx921" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx925" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx929" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx933" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w935"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w939"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="../../../xslt/base/preprocess/15-transclude.xsl.html#f?{http://docbook.org/xslt/ns/extension}definition-for-name" class="solar"><span class="function" start="1" pair-end="31" select="quick">f:definition-for-name</span></a><span class="parenthesis">(</span><span class="axis" start="23">@</span><span class="qname" start="24" select="quick">name</span><span class="op" start="28">,</span><span class="whitespace" start="29"> </span><span class="context" start="30">.</span><span class="parenthesis" start="31">)</span><span class="z">"</span><span id="wx954" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx958" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx962" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx966" class="ec">&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w968"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?idfixup">idfixup</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if" start="1">if</span><span class="whitespace" start="3"> </span><span class="parenthesis" start="4" pair-end="13" select="quick">(</span><span class="axis" start="5">@</span><span class="qname" start="6" select="quick">idfixup</span><span class="parenthesis" start="13">)</span><span class="whitespace" start="14"> </span><span class="op" start="15">then</span><span class="whitespace" start="19"> </span><span class="axis" start="20">@</span><span class="qname" start="21" select="quick">idfixup</span><span class="whitespace" start="28"> </span><span class="op" start="29">else</span><span class="whitespace" start="33"> </span><span class="op">'</span><span class="literal" start="34">auto</span><span class="op">'</span><span class="z">"</span><span id="wx998" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w1000"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?linkscope">linkscope</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if" start="1">if</span><span class="whitespace" start="3"> </span><span class="parenthesis" start="4" pair-end="15" select="quick">(</span><span class="axis" start="5">@</span><span class="qname" start="6" select="quick">linkscope</span><span class="parenthesis" start="15">)</span><span class="whitespace" start="16"> </span><span class="op" start="17">then</span><span class="whitespace" start="21"> </span><span class="axis" start="22">@</span><span class="qname" start="23" select="quick">linkscope</span><span class="whitespace" start="32"> </span><span class="op" start="33">else</span><span class="whitespace" start="37"> </span><span class="op">'</span><span class="literal" start="38">near</span><span class="op">'</span><span class="z">"</span><span id="wx1030" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w1032"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?prefix">prefix</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w1042"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w1046"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable" start="1" select="quick">$idfixup</span><span class="whitespace" start="9"> </span><span class="op" start="10">=</span><span class="whitespace" start="11"> </span><span class="op">'</span><span class="literal" start="12">auto</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w1062"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-concat" class="solar"><span class="function" start="1" pair-end="29" select="quick">concat</span></a><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-generate-id" class="solar"><span class="function" start="8" pair-end="21" select="quick">generate-id</span></a><span class="parenthesis">(</span><span class="context" start="20">.</span><span class="parenthesis" start="21">)</span><span class="op" start="22">,</span><span class="whitespace" start="23"> </span><a href="../../../xslt/base/preprocess/15-transclude.xsl.html#v?psep" class="solar"><span class="variable" start="24" select="quick">$psep</span></a><span class="parenthesis" start="29">)</span><span class="z">"</span><span id="wx1079" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx1083" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w1085"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable" start="1" select="quick">$idfixup</span><span class="whitespace" start="9"> </span><span class="op" start="10">=</span><span class="whitespace" start="11"> </span><span class="op">'</span><span class="literal" start="12">prefix</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w1101"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-string" class="solar"><span class="function" start="1" pair-end="15" select="quick">string</span></a><span class="parenthesis">(</span><span class="axis" start="8">@</span><span class="qname" start="9" select="quick">prefix</span><span class="parenthesis" start="15">)</span><span class="z">"</span><span id="wx1113" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx1117" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w1119"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt"></span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx1125" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx1129" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx1133" class="ec">&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w1135"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?ref-xmlid">ref-xmlid</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="axis" start="1">@</span><span class="qname" start="2" select="quick">xml:id</span><span class="z">"</span><span id="wx1150" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w1152"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-count" class="solar"><span class="function" start="1" pair-end="52" select="quick">count</span></a><span class="parenthesis">(</span><span class="variable" start="7" select="quick">$content</span><span class="step" start="15">/</span><span class="parenthesis" start="16" pair-end="51" select="quick">(</span><span class="qname" start="17" select="quick">*</span><span class="op" start="18">|</span><span class="node" start="19" pair-end="24" select="quick">text</span><span class="parenthesis">(</span><span class="parenthesis" start="24">)</span><span class="filter" start="25" pair-end="50" select="quick">[</span><a href="http://www.w3.org/TR/xpath-functions/#func-normalize-space" class="solar"><span class="function" start="26" pair-end="43" select="quick">normalize-space</span></a><span class="parenthesis">(</span><span class="context" start="42">.</span><span class="parenthesis" start="43">)</span><span class="whitespace" start="44"> </span><span class="op" start="45">ne</span><span class="whitespace" start="47"> </span><span class="op">'</span><span class="literal" start="48"></span><span class="op">'</span><span class="filter" start="50">]</span><span class="parenthesis" start="51">)</span><span class="parenthesis" start="52">)</span><span class="whitespace" start="53"> </span><span class="op" start="54">&gt;</span><span class="whitespace" start="55"> </span><span class="numeric" start="56">1</span><span class="whitespace" start="57"> </span><span class="op" start="58">and</span><span class="whitespace" start="61"> </span><span class="variable" start="62" select="quick">$ref-xmlid</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w1193"><span class="es">&lt;</span><span class="enxsl">xsl:message</span><span class="scx">&gt;</span><span class="txt">Error xml:id can't be added to definition without single outermost element.</span><span class="ez">&lt;/</span><span class="clxsl">xsl:message</span><span id="wx1199" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx1203" class="ec">&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w1205"><span class="es">&lt;</span><span class="enxsl">xsl:for-each</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable" start="1" select="quick">$content</span><span class="step" start="9">/</span><span class="node" start="10" pair-end="15" select="quick">node</span><span class="parenthesis">(</span><span class="parenthesis" start="15">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w1219"><span class="es">&lt;</span><span class="enxsl">xsl:copy</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w1223"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?xmlid">xmlid</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if" start="1">if</span><span class="whitespace" start="3"> </span><span class="parenthesis" start="4" pair-end="15" select="quick">(</span><span class="variable" start="5" select="quick">$ref-xmlid</span><span class="parenthesis" start="15">)</span><span class="whitespace" start="16"> </span><span class="op" start="17">then</span><span class="whitespace" start="21"> </span><span class="variable" start="22" select="quick">$ref-xmlid</span><span class="whitespace" start="32"> </span><span class="op" start="33">else</span><span class="whitespace" start="37"> </span><span class="axis" start="38">@</span><span class="qname" start="39" select="quick">xml:id</span><span class="z">"</span><span id="wx1250" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ww" id="w1252"><span class="es">&lt;</span><span class="enxsl">xsl:copy-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="axis" start="1">@</span><span class="qname" start="2" select="quick">*</span><span class="whitespace" start="3"> </span><span class="qname" start="4" select="quick">except</span><span class="whitespace" start="10"> </span><span class="axis" start="11">@</span><span class="qname" start="12" select="quick">xml:id</span><span class="z">"</span><span id="wx1266" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ww" id="w1268"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="axis" start="1">self::</span><span class="qname" start="7" select="quick">*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w1279"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w1283"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable" start="1" select="quick">$idfixup</span><span class="whitespace" start="9"> </span><span class="op" start="10">=</span><span class="whitespace" start="11"> </span><span class="op">'</span><span class="literal" start="12">none</span><span class="op">'</span><span class="whitespace" start="18"> </span><span class="op" start="19">and</span><span class="whitespace" start="22"> </span><span class="variable" start="23" select="quick">$xmlid</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="ww" id="w1303"><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">xml:id</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable" start="1" select="quick">$xmlid</span><span class="z">"</span><span id="wx1317" class="sc">/&gt;</span></span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx1321" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ww" id="w1323"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="parenthesis" start="1" pair-end="40" select="quick">(</span><span class="variable" start="2" select="quick">$idfixup</span><span class="whitespace" start="10"> </span><span class="op" start="11">=</span><span class="whitespace" start="12"> </span><span class="op">'</span><span class="literal" start="13">strip</span><span class="op">'</span><span class="whitespace" start="20"> </span><span class="op" start="21">and</span><span class="whitespace" start="24"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function" start="25" pair-end="39" select="quick">not</span></a><span class="parenthesis">(</span><span class="variable" start="29" select="quick">$ref-xmlid</span><span class="parenthesis" start="39">)</span><span class="parenthesis" start="40">)</span><span class="whitespace" start="41"> </span><span class="op" start="42">or</span><span class="whitespace" start="44"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function" start="45" pair-end="55" select="quick">not</span></a><span class="parenthesis">(</span><span class="variable" start="49" select="quick">$xmlid</span><span class="parenthesis" start="55">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx1357" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ww" id="w1359"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="ww" id="w1363"><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">xml:id</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-concat" class="solar"><span class="function" start="1" pair-end="24" select="quick">concat</span></a><span class="parenthesis">(</span><span class="variable" start="8" select="quick">$prefix</span><span class="op" start="15">,</span><span class="whitespace" start="16"> </span><span class="axis" start="17">@</span><span class="qname" start="18" select="quick">xml:id</span><span class="parenthesis" start="24">)</span><span class="z">"</span><span id="wx1384" class="sc">/&gt;</span></span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx1388" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx1392" class="ec">&gt;</span></span><span class="txt">
          </span><span class="z">&lt;!--</span><span class="cm"> &lt;xsl:attribute name="xml:base" select="$baseuri"/&gt; </span><span class="z">--&gt;</span><span class="txt">
          </span><span class="ww" id="w1398"><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">ta:linkscope</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable" start="1" select="quick">$linkscope</span><span class="z">"</span><span id="wx1412" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w1414"><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">ta:prefix</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable" start="1" select="quick">$prefix</span><span class="z">"</span><span id="wx1428" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx1432" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w1434"><span class="es">&lt;</span><span class="enxsl">xsl:apply-templates</span><span class="z"> </span><span class="atn">mode</span><span class="atneq">=</span><span class="z">"</span><span class="av">mp:transclude</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w1444"><span class="es">&lt;</span><span class="enxsl">xsl:with-param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">idfixup</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable" start="1" select="quick">$idfixup</span><span class="z">"</span><span class="z"> </span><span class="atn">tunnel</span><span class="atneq">=</span><span class="z">"</span><span class="av">yes</span><span class="z">"</span><span id="wx1464" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w1466"><span class="es">&lt;</span><span class="enxsl">xsl:with-param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">prefix</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable" start="1" select="quick">$prefix</span><span class="z">"</span><span class="z"> </span><span class="atn">tunnel</span><span class="atneq">=</span><span class="z">"</span><span class="av">yes</span><span class="z">"</span><span id="wx1486" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:apply-templates</span><span id="wx1490" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:copy</span><span id="wx1494" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:for-each</span><span id="wx1498" class="ec">&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:template</span><span id="wx1502" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w1504"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{http://docbook.org/xslt/ns/extension}definition-for-name">f:definition-for-name</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">node()*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w1520"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?name">name</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span id="wx1534" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w1536"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?context">context</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">node()</span><span class="z">"</span><span id="wx1550" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w1552"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?closest-info-with-defs">closest-info-with-defs</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable" start="1" select="quick">$context</span><span class="step" start="9">/</span><span class="axis" start="10">ancestor-or-self::</span><span class="qname" start="28" select="quick">*</span><span class="step" start="29">/</span><span class="qname" start="30" select="quick">db:info</span><span class="filter" start="37" pair-end="52" select="quick">[</span><span class="qname" start="38" select="quick">db:definitions</span><span class="filter" start="52">]</span><span class="filter" start="53" pair-end="55" select="quick">[</span><span class="numeric" start="54">1</span><span class="filter" start="55">]</span><span class="z">"</span><span id="wx1577" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w1579"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w1583"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable" start="1" select="quick">$closest-info-with-defs</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w1593"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w1597"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable" start="1" select="quick">$closest-info-with-defs</span><span class="step" start="24">/</span><span class="qname" start="25" select="quick">db:definitions</span><span class="step" start="39">/</span><span class="qname" start="40" select="quick">db:def</span><span class="filter" start="46" pair-end="60" select="quick">[</span><span class="axis" start="47">@</span><span class="qname" start="48" select="quick">name</span><span class="whitespace" start="52"> </span><span class="op" start="53">=</span><span class="whitespace" start="54"> </span><span class="variable" start="55" select="quick">$name</span><span class="filter" start="60">]</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w1619"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="parenthesis" start="1" pair-end="62" select="quick">(</span><span class="variable" start="2" select="quick">$closest-info-with-defs</span><span class="step" start="25">/</span><span class="qname" start="26" select="quick">db:definitions</span><span class="step" start="40">/</span><span class="qname" start="41" select="quick">db:def</span><span class="filter" start="47" pair-end="61" select="quick">[</span><span class="axis" start="48">@</span><span class="qname" start="49" select="quick">name</span><span class="whitespace" start="53"> </span><span class="op" start="54">=</span><span class="whitespace" start="55"> </span><span class="variable" start="56" select="quick">$name</span><span class="filter" start="61">]</span><span class="parenthesis" start="62">)</span><span class="filter" start="63" pair-end="70" select="quick">[</span><a href="http://www.w3.org/TR/xpath-functions/#func-last" class="solar"><span class="function" start="64" pair-end="69" select="quick">last</span></a><span class="parenthesis">(</span><span class="parenthesis" start="69">)</span><span class="filter" start="70">]</span><span class="step" start="71">/</span><span class="node" start="72" pair-end="77" select="quick">node</span><span class="parenthesis">(</span><span class="parenthesis" start="77">)</span><span class="z">"</span><span id="wx1650" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx1654" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ww" id="w1656"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w1660"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="../../../xslt/base/preprocess/15-transclude.xsl.html#f?{http://docbook.org/xslt/ns/extension}definition-for-name" class="solar"><span class="function" start="1" pair-end="59" select="quick">f:definition-for-name</span></a><span class="parenthesis">(</span><span class="variable" start="23" select="quick">$name</span><span class="op" start="28">,</span><span class="whitespace" start="29"> </span><span class="variable" start="30" select="quick">$closest-info-with-defs</span><span class="step" start="53">/</span><span class="context" start="54">..</span><span class="step" start="56">/</span><span class="context" start="57">..</span><span class="parenthesis" start="59">)</span><span class="z">"</span><span id="wx1678" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx1682" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx1686" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx1690" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ww" id="w1692"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w1696"><span class="es">&lt;</span><span class="enxsl">xsl:message</span><span class="scx">&gt;</span><span class="txt">Error: definition of "</span><span class="ww" id="w1700"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable" start="1" select="quick">$name</span><span class="z">"</span><span id="wx1708" class="sc">/&gt;</span></span><span class="txt">" was not found.</span><span class="ez">&lt;/</span><span class="clxsl">xsl:message</span><span id="wx1712" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx1716" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx1720" class="ec">&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx1724" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w1726"><span class="es">&lt;</span><span class="enxsl">xsl:template</span><span class="z"> </span><span class="atn">match</span><span class="atneq">=</span><span class="z">"</span><span class="qname" start="1" select="quick">db:ref</span><span class="filter" start="7" pair-end="24" select="quick">[</span><span class="axis" start="8">@</span><span class="qname" start="9" select="quick">parse</span><span class="whitespace" start="14"> </span><span class="op" start="15">eq</span><span class="whitespace" start="17"> </span><span class="op">'</span><span class="literal" start="18">text</span><span class="op">'</span><span class="filter" start="24">]</span><span class="z">"</span><span class="z"> </span><span class="atn">mode</span><span class="atneq">=</span><span class="z">"</span><span class="av">mp:transclude</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w1752"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?baseuri">baseuri</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-resolve-uri" class="solar"><span class="function" start="1" pair-end="34" select="quick">resolve-uri</span></a><span class="parenthesis">(</span><span class="axis" start="13">@</span><span class="qname" start="14" select="quick">fileref</span><span class="op" start="21">,</span><span class="whitespace" start="22"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-base-uri" class="solar"><span class="function" start="23" pair-end="33" select="quick">base-uri</span></a><span class="parenthesis">(</span><span class="context" start="32">.</span><span class="parenthesis" start="33">)</span><span class="parenthesis" start="34">)</span><span class="z">"</span><span id="wx1776" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w1778"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w1782"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="axis" start="1">@</span><span class="qname" start="2" select="quick">encoding</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w1793"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-unparsed-text" class="solar"><span class="function" start="1" pair-end="34" select="quick">unparsed-text</span></a><span class="parenthesis">(</span><span class="variable" start="15" select="quick">$baseuri</span><span class="op" start="23">,</span><span class="whitespace" start="24"> </span><span class="axis" start="25">@</span><span class="qname" start="26" select="quick">encoding</span><span class="parenthesis" start="34">)</span><span class="z">"</span><span id="wx1808" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx1812" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ww" id="w1814"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w1818"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-unparsed-text" class="solar"><span class="function" start="1" pair-end="23" select="quick">unparsed-text</span></a><span class="parenthesis">(</span><span class="variable" start="15" select="quick">$baseuri</span><span class="parenthesis" start="23">)</span><span class="z">"</span><span id="wx1829" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx1833" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx1837" class="ec">&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:template</span><span id="wx1841" class="ec">&gt;</span></span><span class="txt">
  
  
  </span><span class="ww" id="w1843"><span class="es">&lt;</span><span class="enxsl">xsl:template</span><span class="z"> </span><span class="atn">match</span><span class="atneq">=</span><span class="z">"</span><span class="qname" start="1" select="quick">db:ref</span><span class="filter" start="7" pair-end="53" select="quick">[</span><span class="axis" start="8">@</span><span class="qname" start="9" select="quick">fileref</span><span class="whitespace" start="16"> </span><span class="op" start="17">and</span><span class="whitespace" start="20"> </span><span class="parenthesis" start="21" pair-end="52" select="quick">(</span><span class="axis" start="22">@</span><span class="qname" start="23" select="quick">parse</span><span class="whitespace" start="28"> </span><span class="op" start="29">eq</span><span class="whitespace" start="31"> </span><span class="op">'</span><span class="literal" start="32">xml</span><span class="op">'</span><span class="whitespace" start="37"> </span><span class="op" start="38">or</span><span class="whitespace" start="40"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function" start="41" pair-end="51" select="quick">not</span></a><span class="parenthesis">(</span><span class="axis" start="45">@</span><span class="qname" start="46" select="quick">parse</span><span class="parenthesis" start="51">)</span><span class="parenthesis" start="52">)</span><span class="filter" start="53">]</span><span class="z">"</span><span class="z"> </span><span class="atn">mode</span><span class="atneq">=</span><span class="z">"</span><span class="av">mp:transclude</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w1884"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?baseuri">baseuri</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-resolve-uri" class="solar"><span class="function" start="1" pair-end="34" select="quick">resolve-uri</span></a><span class="parenthesis">(</span><span class="axis" start="13">@</span><span class="qname" start="14" select="quick">fileref</span><span class="op" start="21">,</span><span class="whitespace" start="22"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-base-uri" class="solar"><span class="function" start="23" pair-end="33" select="quick">base-uri</span></a><span class="parenthesis">(</span><span class="context" start="32">.</span><span class="parenthesis" start="33">)</span><span class="parenthesis" start="34">)</span><span class="z">"</span><span id="wx1908" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w1910"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?doc">doc</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w1920"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w1924"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="axis" start="1">@</span><span class="qname" start="2" select="quick">xpointer</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w1935"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="../../../xslt/base/preprocess/15-transclude.xsl.html#f?{http://docbook.org/xslt/ns/extension}transclude" class="solar"><span class="function" start="1" pair-end="61" select="quick">f:transclude</span></a><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-doc" class="solar"><span class="function" start="14" pair-end="26" select="quick">doc</span></a><span class="parenthesis">(</span><span class="variable" start="18" select="quick">$baseuri</span><span class="parenthesis" start="26">)</span><span class="step" start="27">//</span><span class="qname" start="29" select="quick">*</span><span class="filter" start="30" pair-end="60" select="quick">[</span><span class="axis" start="31">@</span><span class="qname" start="32" select="quick">xml:id</span><span class="whitespace" start="38"> </span><span class="op" start="39">=</span><span class="whitespace" start="40"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-current" class="solar"><span class="function" start="41" pair-end="49" select="quick">current</span></a><span class="parenthesis">(</span><span class="parenthesis" start="49">)</span><span class="step" start="50">/</span><span class="axis" start="51">@</span><span class="qname" start="52" select="quick">xpointer</span><span class="filter" start="60">]</span><span class="parenthesis" start="61">)</span><span class="z">"</span><span id="wx1964" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx1968" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w1970"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w1974"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="../../../xslt/base/preprocess/15-transclude.xsl.html#f?{http://docbook.org/xslt/ns/extension}transclude" class="solar"><span class="function" start="1" pair-end="27" select="quick">f:transclude</span></a><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-doc" class="solar"><span class="function" start="14" pair-end="26" select="quick">doc</span></a><span class="parenthesis">(</span><span class="variable" start="18" select="quick">$baseuri</span><span class="parenthesis" start="26">)</span><span class="parenthesis" start="27">)</span><span class="z">"</span><span id="wx1988" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx1992" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx1996" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx2000" class="ec">&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w2002"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?idfixup">idfixup</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if" start="1">if</span><span class="whitespace" start="3"> </span><span class="parenthesis" start="4" pair-end="13" select="quick">(</span><span class="axis" start="5">@</span><span class="qname" start="6" select="quick">idfixup</span><span class="parenthesis" start="13">)</span><span class="whitespace" start="14"> </span><span class="op" start="15">then</span><span class="whitespace" start="19"> </span><span class="axis" start="20">@</span><span class="qname" start="21" select="quick">idfixup</span><span class="whitespace" start="28"> </span><span class="op" start="29">else</span><span class="whitespace" start="33"> </span><span class="op">'</span><span class="literal" start="34">auto</span><span class="op">'</span><span class="z">"</span><span id="wx2032" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w2034"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?linkscope">linkscope</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if" start="1">if</span><span class="whitespace" start="3"> </span><span class="parenthesis" start="4" pair-end="15" select="quick">(</span><span class="axis" start="5">@</span><span class="qname" start="6" select="quick">linkscope</span><span class="parenthesis" start="15">)</span><span class="whitespace" start="16"> </span><span class="op" start="17">then</span><span class="whitespace" start="21"> </span><span class="axis" start="22">@</span><span class="qname" start="23" select="quick">linkscope</span><span class="whitespace" start="32"> </span><span class="op" start="33">else</span><span class="whitespace" start="37"> </span><span class="op">'</span><span class="literal" start="38">near</span><span class="op">'</span><span class="z">"</span><span id="wx2064" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w2066"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?prefix">prefix</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w2076"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w2080"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable" start="1" select="quick">$idfixup</span><span class="whitespace" start="9"> </span><span class="op" start="10">=</span><span class="whitespace" start="11"> </span><span class="op">'</span><span class="literal" start="12">auto</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w2096"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-concat" class="solar"><span class="function" start="1" pair-end="29" select="quick">concat</span></a><span class="parenthesis">(</span><a href="http://www.w3.org/TR/xpath-functions/#func-generate-id" class="solar"><span class="function" start="8" pair-end="21" select="quick">generate-id</span></a><span class="parenthesis">(</span><span class="context" start="20">.</span><span class="parenthesis" start="21">)</span><span class="op" start="22">,</span><span class="whitespace" start="23"> </span><a href="../../../xslt/base/preprocess/15-transclude.xsl.html#v?psep" class="solar"><span class="variable" start="24" select="quick">$psep</span></a><span class="parenthesis" start="29">)</span><span class="z">"</span><span id="wx2113" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx2117" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w2119"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable" start="1" select="quick">$idfixup</span><span class="whitespace" start="9"> </span><span class="op" start="10">=</span><span class="whitespace" start="11"> </span><span class="op">'</span><span class="literal" start="12">prefix</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w2135"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-string" class="solar"><span class="function" start="1" pair-end="15" select="quick">string</span></a><span class="parenthesis">(</span><span class="axis" start="8">@</span><span class="qname" start="9" select="quick">prefix</span><span class="parenthesis" start="15">)</span><span class="z">"</span><span id="wx2147" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx2151" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w2153"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt"></span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx2159" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx2163" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:variable</span><span id="wx2167" class="ec">&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w2169"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?ref-xmlid">ref-xmlid</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="axis" start="1">@</span><span class="qname" start="2" select="quick">xml:id</span><span class="z">"</span><span id="wx2184" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w2186"><span class="es">&lt;</span><span class="enxsl">xsl:for-each</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable" start="1" select="quick">$doc</span><span class="step" start="5">/</span><span class="node" start="6" pair-end="11" select="quick">node</span><span class="parenthesis">(</span><span class="parenthesis" start="11">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w2200"><span class="es">&lt;</span><span class="enxsl">xsl:copy</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w2204"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?xmlid">xmlid</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if" start="1">if</span><span class="whitespace" start="3"> </span><span class="parenthesis" start="4" pair-end="15" select="quick">(</span><span class="variable" start="5" select="quick">$ref-xmlid</span><span class="parenthesis" start="15">)</span><span class="whitespace" start="16"> </span><span class="op" start="17">then</span><span class="whitespace" start="21"> </span><span class="variable" start="22" select="quick">$ref-xmlid</span><span class="whitespace" start="32"> </span><span class="op" start="33">else</span><span class="whitespace" start="37"> </span><span class="axis" start="38">@</span><span class="qname" start="39" select="quick">xml:id</span><span class="z">"</span><span id="wx2231" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ww" id="w2233"><span class="es">&lt;</span><span class="enxsl">xsl:copy-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="axis" start="1">@</span><span class="qname" start="2" select="quick">*</span><span class="whitespace" start="3"> </span><span class="qname" start="4" select="quick">except</span><span class="whitespace" start="10"> </span><span class="axis" start="11">@</span><span class="qname" start="12" select="quick">xml:id</span><span class="z">"</span><span id="wx2247" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ww" id="w2249"><span class="es">&lt;</span><span class="enxsl">xsl:if</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="axis" start="1">self::</span><span class="qname" start="7" select="quick">*</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w2260"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ww" id="w2264"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable" start="1" select="quick">$idfixup</span><span class="whitespace" start="9"> </span><span class="op" start="10">=</span><span class="whitespace" start="11"> </span><span class="op">'</span><span class="literal" start="12">none</span><span class="op">'</span><span class="whitespace" start="18"> </span><span class="op" start="19">and</span><span class="whitespace" start="22"> </span><span class="variable" start="23" select="quick">$xmlid</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="ww" id="w2284"><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">xml:id</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable" start="1" select="quick">$xmlid</span><span class="z">"</span><span id="wx2298" class="sc">/&gt;</span></span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx2302" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ww" id="w2304"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="parenthesis" start="1" pair-end="40" select="quick">(</span><span class="variable" start="2" select="quick">$idfixup</span><span class="whitespace" start="10"> </span><span class="op" start="11">=</span><span class="whitespace" start="12"> </span><span class="op">'</span><span class="literal" start="13">strip</span><span class="op">'</span><span class="whitespace" start="20"> </span><span class="op" start="21">and</span><span class="whitespace" start="24"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function" start="25" pair-end="39" select="quick">not</span></a><span class="parenthesis">(</span><span class="variable" start="29" select="quick">$ref-xmlid</span><span class="parenthesis" start="39">)</span><span class="parenthesis" start="40">)</span><span class="whitespace" start="41"> </span><span class="op" start="42">or</span><span class="whitespace" start="44"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function" start="45" pair-end="55" select="quick">not</span></a><span class="parenthesis">(</span><span class="variable" start="49" select="quick">$xmlid</span><span class="parenthesis" start="55">)</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx2338" class="ec">&gt;</span></span><span class="txt">
            </span><span class="ww" id="w2340"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
              </span><span class="ww" id="w2344"><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">xml:id</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-concat" class="solar"><span class="function" start="1" pair-end="24" select="quick">concat</span></a><span class="parenthesis">(</span><span class="variable" start="8" select="quick">$prefix</span><span class="op" start="15">,</span><span class="whitespace" start="16"> </span><span class="axis" start="17">@</span><span class="qname" start="18" select="quick">xml:id</span><span class="parenthesis" start="24">)</span><span class="z">"</span><span id="wx2365" class="sc">/&gt;</span></span><span class="txt">
            </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx2369" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx2373" class="ec">&gt;</span></span><span class="txt">
          </span><span class="ww" id="w2375"><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">xml:base</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable" start="1" select="quick">$baseuri</span><span class="z">"</span><span id="wx2389" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w2391"><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">ta:linkscope</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable" start="1" select="quick">$linkscope</span><span class="z">"</span><span id="wx2405" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w2407"><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">ta:prefix</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable" start="1" select="quick">$prefix</span><span class="z">"</span><span id="wx2421" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:if</span><span id="wx2425" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w2427"><span class="es">&lt;</span><span class="enxsl">xsl:apply-templates</span><span class="z"> </span><span class="atn">mode</span><span class="atneq">=</span><span class="z">"</span><span class="av">mp:transclude</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w2437"><span class="es">&lt;</span><span class="enxsl">xsl:with-param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">idfixup</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable" start="1" select="quick">$idfixup</span><span class="z">"</span><span class="z"> </span><span class="atn">tunnel</span><span class="atneq">=</span><span class="z">"</span><span class="av">yes</span><span class="z">"</span><span id="wx2457" class="sc">/&gt;</span></span><span class="txt">
          </span><span class="ww" id="w2459"><span class="es">&lt;</span><span class="enxsl">xsl:with-param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="av">prefix</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable" start="1" select="quick">$prefix</span><span class="z">"</span><span class="z"> </span><span class="atn">tunnel</span><span class="atneq">=</span><span class="z">"</span><span class="av">yes</span><span class="z">"</span><span id="wx2479" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:apply-templates</span><span id="wx2483" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:copy</span><span id="wx2487" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ww" id="w2489"><span class="es">&lt;</span><span class="enxsl">xsl:copy-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="axis" start="1">following-sibling::</span><span class="node" start="20" pair-end="25" select="quick">node</span><span class="parenthesis">(</span><span class="parenthesis" start="25">)</span><span class="z">"</span><span id="wx2500" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:for-each</span><span id="wx2504" class="ec">&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:template</span><span id="wx2508" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w2510"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{http://docbook.org/xslt/ns/extension}adjust-idrefs">f:adjust-idrefs</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">node()+</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w2526"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?doc">doc</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">node()+</span><span class="z">"</span><span id="wx2540" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w2542"><span class="es">&lt;</span><span class="enxsl">xsl:apply-templates</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable" start="1" select="quick">$doc</span><span class="z">"</span><span class="z"> </span><span class="atn">mode</span><span class="atneq">=</span><span class="z">"</span><span class="av">mp:adjust-idrefs</span><span class="z">"</span><span id="wx2556" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx2560" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w2562"><span class="es">&lt;</span><span class="enxsl">xsl:template</span><span class="z"> </span><span class="atn">match</span><span class="atneq">=</span><span class="z">"</span><span class="node" start="1" pair-end="6" select="quick">node</span><span class="parenthesis">(</span><span class="parenthesis" start="6">)</span><span class="op" start="7">|</span><span class="axis" start="8">@</span><span class="qname" start="9" select="quick">*</span><span class="z">"</span><span class="z"> </span><span class="atn">mode</span><span class="atneq">=</span><span class="z">"</span><span class="av">mp:adjust-idrefs</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w2583"><span class="es">&lt;</span><span class="enxsl">xsl:copy</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w2587"><span class="es">&lt;</span><span class="enxsl">xsl:apply-templates</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="axis" start="1">@</span><span class="qname" start="2" select="quick">*</span><span class="whitespace" start="3"> </span><span class="op" start="4">|</span><span class="whitespace" start="5"> </span><span class="node" start="6" pair-end="11" select="quick">node</span><span class="parenthesis">(</span><span class="parenthesis" start="11">)</span><span class="z">"</span><span class="z"> </span><span class="atn">mode</span><span class="atneq">=</span><span class="z">"</span><span class="av">mp:adjust-idrefs</span><span class="z">"</span><span id="wx2608" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:copy</span><span id="wx2612" class="ec">&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:template</span><span id="wx2616" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="z">&lt;!--</span><span class="cm"> FIXME: add support for @linkends, @zone, @arearefs </span><span class="z">--&gt;</span><span class="txt">
  </span><span class="z">&lt;!--</span><span class="cm"> FIEMX: add support for xlink:href starting with # </span><span class="z">--&gt;</span><span class="txt">
  </span><span class="ww" id="w2626"><span class="es">&lt;</span><span class="enxsl">xsl:template</span><span class="z"> </span><span class="atn">match</span><span class="atneq">=</span><span class="z">"</span><span class="axis" start="1">@</span><span class="qname" start="2" select="quick">linkend</span><span class="whitespace" start="9"> </span><span class="op" start="10">|</span><span class="whitespace" start="11"> </span><span class="axis" start="12">@</span><span class="qname" start="13" select="quick">endterm</span><span class="whitespace" start="20"> </span><span class="op" start="21">|</span><span class="whitespace" start="22"> </span><span class="axis" start="23">@</span><span class="qname" start="24" select="quick">otherterm</span><span class="whitespace" start="33"> </span><span class="op" start="34">|</span><span class="whitespace" start="35"> </span><span class="axis" start="36">@</span><span class="qname" start="37" select="quick">startref</span><span class="z">"</span><span class="z"> </span><span class="atn">mode</span><span class="atneq">=</span><span class="z">"</span><span class="av">mp:adjust-idrefs</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w2658"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?idref">idref</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="context" start="1">.</span><span class="z">"</span><span id="wx2672" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w2674"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?annotation">annotation</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="axis" start="1">ancestor-or-self::</span><span class="qname" start="19" select="quick">*</span><span class="filter" start="20" pair-end="34" select="quick">[</span><span class="axis" start="21">@</span><span class="qname" start="22" select="quick">ta:linkscope</span><span class="filter" start="34">]</span><span class="filter" start="35" pair-end="37" select="quick">[</span><span class="numeric" start="36">1</span><span class="filter" start="37">]</span><span class="z">"</span><span id="wx2696" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w2698"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?linkscope">linkscope</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="parenthesis" start="1" pair-end="35" select="quick">(</span><span class="variable" start="2" select="quick">$annotation</span><span class="step" start="13">/</span><span class="axis" start="14">@</span><span class="qname" start="15" select="quick">ta:linkscope</span><span class="op" start="27">,</span><span class="whitespace" start="28"> </span><span class="op">'</span><span class="literal" start="29">near</span><span class="op">'</span><span class="parenthesis" start="35">)</span><span class="filter" start="36" pair-end="38" select="quick">[</span><span class="numeric" start="37">1</span><span class="filter" start="38">]</span><span class="z">"</span><span id="wx2725" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w2727"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?prefix">prefix</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable" start="1" select="quick">$annotation</span><span class="step" start="12">/</span><span class="axis" start="13">@</span><span class="qname" start="14" select="quick">ta:prefix</span><span class="z">"</span><span id="wx2744" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w2746"><span class="es">&lt;</span><span class="enxsl">xsl:attribute</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="op">{</span><a href="http://www.w3.org/TR/xpath-functions/#func-local-name" class="solar"><span class="function" start="1" pair-end="13" select="quick">local-name</span></a><span class="parenthesis">(</span><span class="context" start="12">.</span><span class="parenthesis" start="13">)</span><span class="op">}</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w2761"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w2765"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable" start="1" select="quick">$linkscope</span><span class="whitespace" start="11"> </span><span class="op" start="12">=</span><span class="whitespace" start="13"> </span><span class="op">'</span><span class="literal" start="14">user</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w2781"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable" start="1" select="quick">$idref</span><span class="z">"</span><span id="wx2789" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx2793" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w2795"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable" start="1" select="quick">$linkscope</span><span class="whitespace" start="11"> </span><span class="op" start="12">=</span><span class="whitespace" start="13"> </span><span class="op">'</span><span class="literal" start="14">local</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w2811"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-concat" class="solar"><span class="function" start="1" pair-end="23" select="quick">concat</span></a><span class="parenthesis">(</span><span class="variable" start="8" select="quick">$prefix</span><span class="op" start="15">,</span><span class="whitespace" start="16"> </span><span class="variable" start="17" select="quick">$idref</span><span class="parenthesis" start="23">)</span><span class="z">"</span><span id="wx2825" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx2829" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w2831"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable" start="1" select="quick">$linkscope</span><span class="whitespace" start="11"> </span><span class="op" start="12">=</span><span class="whitespace" start="13"> </span><span class="op">'</span><span class="literal" start="14">near</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w2847"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="../../../xslt/base/preprocess/15-transclude.xsl.html#f?{http://docbook.org/xslt/ns/extension}nearest-matching-id" class="solar"><span class="function" start="1" pair-end="33" select="quick">f:nearest-matching-id</span></a><span class="parenthesis">(</span><span class="variable" start="23" select="quick">$idref</span><span class="op" start="29">,</span><span class="whitespace" start="30"> </span><span class="context" start="31">..</span><span class="parenthesis" start="33">)</span><span class="z">"</span><span id="wx2861" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx2865" class="ec">&gt;</span></span><span class="txt">
        </span><span class="ww" id="w2867"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable" start="1" select="quick">$linkscope</span><span class="whitespace" start="11"> </span><span class="op" start="12">=</span><span class="whitespace" start="13"> </span><span class="op">'</span><span class="literal" start="14">global</span><span class="op">'</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
          </span><span class="ww" id="w2883"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="../../../xslt/base/preprocess/15-transclude.xsl.html#f?{http://docbook.org/xslt/ns/extension}nearest-matching-id" class="solar"><span class="function" start="1" pair-end="38" select="quick">f:nearest-matching-id</span></a><span class="parenthesis">(</span><span class="variable" start="23" select="quick">$idref</span><span class="op" start="29">,</span><span class="whitespace" start="30"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-root" class="solar"><span class="function" start="31" pair-end="37" select="quick">root</span></a><span class="parenthesis">(</span><span class="context" start="36">.</span><span class="parenthesis" start="37">)</span><span class="parenthesis" start="38">)</span><span class="z">"</span><span id="wx2900" class="sc">/&gt;</span></span><span class="txt">
        </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx2904" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx2908" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:attribute</span><span id="wx2912" class="ec">&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:template</span><span id="wx2916" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="ww" id="w2918"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{http://docbook.org/xslt/ns/extension}nearest-matching-id">f:nearest-matching-id</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string?</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w2934"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?idref">idref</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string</span><span class="z">"</span><span id="wx2948" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w2950"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?context">context</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">node()</span><span class="z">"</span><span id="wx2964" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="z">&lt;!--</span><span class="cm"> FIXME: key() requires document-node() rooted subtree </span><span class="z">--&gt;</span><span class="txt">
    </span><span class="z">&lt;!--</span><span class="cm">  &lt;xsl:variable name="targets" select="key('unprefixed-id', f:unprefixed-id($idref, $context), $context)"/&gt; </span><span class="z">--&gt;</span><span class="txt">
    </span><span class="ww" id="w2974"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?targets">targets</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable" start="1" select="quick">$context</span><span class="step" start="9">//</span><span class="qname" start="11" select="quick">*</span><span class="filter" start="12" pair-end="20" select="quick">[</span><span class="axis" start="13">@</span><span class="qname" start="14" select="quick">xml:id</span><span class="filter" start="20">]</span><span class="filter" start="21" pair-end="86" select="quick">[</span><a href="../../../xslt/base/preprocess/15-transclude.xsl.html#f?{http://docbook.org/xslt/ns/extension}unprefixed-id" class="solar"><span class="function" start="22" pair-end="48" select="quick">f:unprefixed-id</span></a><span class="parenthesis">(</span><span class="axis" start="38">@</span><span class="qname" start="39" select="quick">xml:id</span><span class="op" start="45">,</span><span class="whitespace" start="46"> </span><span class="context" start="47">.</span><span class="parenthesis" start="48">)</span><span class="whitespace" start="49"> </span><span class="op" start="50">eq</span><span class="whitespace" start="52"> </span><a href="../../../xslt/base/preprocess/15-transclude.xsl.html#f?{http://docbook.org/xslt/ns/extension}unprefixed-id" class="solar"><span class="function" start="53" pair-end="85" select="quick">f:unprefixed-id</span></a><span class="parenthesis">(</span><span class="variable" start="69" select="quick">$idref</span><span class="op" start="75">,</span><span class="whitespace" start="76"> </span><span class="variable" start="77" select="quick">$context</span><span class="parenthesis" start="85">)</span><span class="filter" start="86">]</span><span class="z">"</span><span id="wx3014" class="sc">/&gt;</span></span><span class="txt"> 
    
    </span><span class="ww" id="w3016"><span class="es">&lt;</span><span class="enxsl">xsl:choose</span><span class="scx">&gt;</span><span class="txt">
      </span><span class="ww" id="w3020"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><a href="http://www.w3.org/TR/xpath-functions/#func-not" class="solar"><span class="function" start="1" pair-end="13" select="quick">not</span></a><span class="parenthesis">(</span><span class="variable" start="5" select="quick">$targets</span><span class="parenthesis" start="13">)</span><span class="whitespace" start="14"> </span><span class="op" start="15">and</span><span class="whitespace" start="18"> </span><span class="variable" start="19" select="quick">$context</span><span class="step" start="27">/</span><span class="context" start="28">..</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w3039"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><a href="../../../xslt/base/preprocess/15-transclude.xsl.html#f?{http://docbook.org/xslt/ns/extension}nearest-matching-id" class="solar"><span class="function" start="1" pair-end="42" select="quick">f:nearest-matching-id</span></a><span class="parenthesis">(</span><span class="variable" start="23" select="quick">$idref</span><span class="op" start="29">,</span><span class="whitespace" start="30"> </span><span class="variable" start="31" select="quick">$context</span><span class="step" start="39">/</span><span class="context" start="40">..</span><span class="parenthesis" start="42">)</span><span class="z">"</span><span id="wx3055" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx3059" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ww" id="w3061"><span class="es">&lt;</span><span class="enxsl">xsl:when</span><span class="z"> </span><span class="atn">test</span><span class="atneq">=</span><span class="z">"</span><span class="variable" start="1" select="quick">$targets</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w3071"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable" start="1" select="quick">$targets</span><span class="filter" start="9" pair-end="11" select="quick">[</span><span class="numeric" start="10">1</span><span class="filter" start="11">]</span><span class="step" start="12">/</span><a href="http://www.w3.org/TR/xpath-functions/#func-string" class="solar"><span class="function" start="13" pair-end="27" select="quick">string</span></a><span class="parenthesis">(</span><span class="axis" start="20">@</span><span class="qname" start="21" select="quick">xml:id</span><span class="parenthesis" start="27">)</span><span class="z">"</span><span id="wx3088" class="sc">/&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:when</span><span id="wx3092" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ww" id="w3094"><span class="es">&lt;</span><span class="enxsl">xsl:otherwise</span><span class="scx">&gt;</span><span class="txt">
        </span><span class="ww" id="w3098"><span class="es">&lt;</span><span class="enxsl">xsl:message</span><span class="scx">&gt;</span><span class="txt">Error: no matching ID for reference "</span><span class="ww" id="w3102"><span class="es">&lt;</span><span class="enxsl">xsl:value-of</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable" start="1" select="quick">$idref</span><span class="z">"</span><span id="wx3110" class="sc">/&gt;</span></span><span class="txt">" was found.</span><span class="ez">&lt;/</span><span class="clxsl">xsl:message</span><span id="wx3114" class="ec">&gt;</span></span><span class="txt">
      </span><span class="ez">&lt;/</span><span class="clxsl">xsl:otherwise</span><span id="wx3118" class="ec">&gt;</span></span><span class="txt">
    </span><span class="ez">&lt;/</span><span class="clxsl">xsl:choose</span><span id="wx3122" class="ec">&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx3126" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="z">&lt;!--</span><span class="cm"> FIXME: type annotation should be without ?, find why it is called with empty sequence </span><span class="z">--&gt;</span><span class="txt">
  </span><span class="ww" id="w3132"><span class="es">&lt;</span><span class="enxsl">xsl:function</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="fname" id="f?{http://docbook.org/xslt/ns/extension}unprefixed-id">f:unprefixed-id</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string?</span><span class="z">"</span><span class="scx">&gt;</span><span class="txt">
    </span><span class="ww" id="w3148"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?id">id</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">xs:string?</span><span class="z">"</span><span id="wx3162" class="sc">/&gt;</span></span><span class="txt">
    </span><span class="ww" id="w3164"><span class="es">&lt;</span><span class="enxsl">xsl:param</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?context">context</span><span class="z">"</span><span class="z"> </span><span class="atn">as</span><span class="atneq">=</span><span class="z">"</span><span class="av">node()</span><span class="z">"</span><span id="wx3178" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w3180"><span class="es">&lt;</span><span class="enxsl">xsl:variable</span><span class="z"> </span><span class="atn">name</span><span class="atneq">=</span><span class="z">"</span><span class="vname" id="v?prefix">prefix</span><span class="z">"</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="variable" start="1" select="quick">$context</span><span class="step" start="9">/</span><span class="axis" start="10">ancestor-or-self::</span><span class="qname" start="28" select="quick">*</span><span class="filter" start="29" pair-end="40" select="quick">[</span><span class="axis" start="30">@</span><span class="qname" start="31" select="quick">ta:prefix</span><span class="filter" start="40">]</span><span class="filter" start="41" pair-end="43" select="quick">[</span><span class="numeric" start="42">1</span><span class="filter" start="43">]</span><span class="step" start="44">/</span><span class="axis" start="45">@</span><span class="qname" start="46" select="quick">ta:prefix</span><span class="z">"</span><span id="wx3207" class="sc">/&gt;</span></span><span class="txt">
    
    </span><span class="ww" id="w3209"><span class="es">&lt;</span><span class="enxsl">xsl:sequence</span><span class="z"> </span><span class="atn">select</span><span class="atneq">=</span><span class="z">"</span><span class="if" start="1">if</span><span class="whitespace" start="3"> </span><span class="parenthesis" start="4" pair-end="12" select="quick">(</span><span class="variable" start="5" select="quick">$prefix</span><span class="parenthesis" start="12">)</span><span class="whitespace" start="13"> </span><span class="op" start="14">then</span><span class="whitespace" start="18"> </span><a href="http://www.w3.org/TR/xpath-functions/#func-substring-after" class="solar"><span class="function" start="19" pair-end="47" select="quick">substring-after</span></a><span class="parenthesis">(</span><span class="variable" start="35" select="quick">$id</span><span class="op" start="38">,</span><span class="whitespace" start="39"> </span><span class="variable" start="40" select="quick">$prefix</span><span class="parenthesis" start="47">)</span><span class="whitespace" start="48"> </span><span class="op" start="49">else</span><span class="whitespace" start="53"> </span><span class="variable" start="54" select="quick">$id</span><span class="z">"</span><span id="wx3235" class="sc">/&gt;</span></span><span class="txt">
  </span><span class="ez">&lt;/</span><span class="clxsl">xsl:function</span><span id="wx3239" class="ec">&gt;</span></span><span class="txt">
  
  </span><span class="z">&lt;!--</span><span class="cm">
  &lt;xsl:key name="unprefixed-id" match="*[@xml:id]" use="f:unprefixed-id(@xml:id, .)"/&gt;&#xD;
  </span><span class="z">--&gt;</span><span class="txt">
  
</span><span class="ez">&lt;/</span><span class="clxsl">xsl:stylesheet</span><span id="wx3247" class="ec">&gt;</span></span><span class="txt"></span></p></div></body></html>